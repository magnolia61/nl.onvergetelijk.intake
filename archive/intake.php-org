<?php

require_once 'intake.civix.php';

use CRM_Intake_ExtensionUtil as E;

function intake_civicrm_customPre(string $op, int $groupID, int $entityID, array &$params): void {

    $extdebug   = 0;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug   = FALSE;

    ##########################################################################################
    ### RETURN IF ONLY FOTOSTATUS IS UPDATED
    ##########################################################################################        

    $arraysize = sizeof($params);

    if ($arraysize == 1 AND $params[0]['column_name'] == 'fot_status_1798') {
        return;
    }

    if ($op != 'create' && $op != 'edit') { //    did we just create or edit a custom object?
        wachthond($extdebug,4, "########################################################################");
        wachthond($extdebug,4, "### INTAKE [PRE] EXIT: op != create OR op != edit", "(op: $op)");
        wachthond($extdebug,4, "########################################################################");
        return; //  if not, get out of here
    }

    $extwrite               = 1;
    $extintake              = 1;

    $today_datetime         = date("Y-m-d H:i:s");
    $today_datetime_past    = date('Y-m-d H:i:s', strtotime('-99 year', strtotime($today_datetime)) );
    wachthond($extdebug,4, 'today_datetime_past',       $today_datetime_past);

    $profilecont            = array(225);
    $profilecontintake      = array(181);

    $profilepartdeel        = array(139);
    $profilepartleid        = array(190);
    $profilepart_leidintern = array(300);

    $profilepartref         = array(213);
    $profilepartvog         = array(140);
    $profilepart            = array_merge($profilepartdeel, $profilepartleid);
    $profilepartintake      = array_merge($profilepartref,  $profilepartvog);

    if (in_array($groupID, $profilecontintake))  {

        $contact_id = $entityID;

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] START NAW / BIO / REF / VOG VOOR $entityID", "[groupID: $groupID / op: $op]");
        wachthond($extdebug,4, "########################################################################");

    } else {
        wachthond($extdebug,4, "########################################################################");
        wachthond($extdebug,4, "### INTAKE [PRE] EXIT: groupID ($groupID) not in allowed list (profileintake)", $profileintake);
        wachthond($extdebug,4, "########################################################################");
        return; //  if not, get out of here
    }

    if (in_array($groupID, $profilecontintake)) {

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 1.1 START RETRIEVE VALUES FROM PARAMS");
        wachthond($extdebug,1, "########################################################################");

        wachthond($extdebug,4, "entityid",    $entityID);
        wachthond($extdebug,4, "params",      $params);

        foreach($params as $i=>$item) {

            if ( !isset($indexed[$i][$item['id']]) ) {
                $indexed[$i]['key']         = $i;
                $indexed[$i]['entity_id']   = $item['entity_id']    ?? NULL;
                $indexed[$i]['column_name'] = $item['column_name']  ?? NULL;
//              $indexed[$i]['table_name']  = $item['table_name']   ?? NULL;
                $indexed[$i]['value']       = $item['value']        ?? NULL;
            }

            if (!isset($key_int_nodig[$i])    AND $item['column_name']=="int_nodig_1494"   ) {$all_int_nodig[]   = $i;}
            if (!isset($key_int_status[$i])   AND $item['column_name']=="int_status_1492"  ) {$all_int_status[]  = $i;}

            if (!isset($key_fot_status[$i])   AND $item['column_name']=="fot_status_1798"  ) {$all_fot_status[]  = $i;}
            if (!isset($key_naw_gecheckt[$i]) AND $item['column_name']=="naw_gecheckt_1505") {$all_naw_gecheckt[]= $i;}
            if (!isset($key_naw_status[$i])   AND $item['column_name']=="naw_status_1508"  ) {$all_naw_status[]  = $i;}
            if (!isset($key_bio_ingevuld[$i]) AND $item['column_name']=="bio_ingevuld_1496") {$all_bio_ingevuld[]= $i;}
            if (!isset($key_bio_gecheckt[$i]) AND $item['column_name']=="bio_gecheckt_1497") {$all_bio_gecheckt[]= $i;}
            if (!isset($key_bio_status[$i])   AND $item['column_name']=="bio_status_1498"  ) {$all_bio_status[]  = $i;}    
            if (!isset($key_ref_nodig[$i])    AND $item['column_name']=="ref_nodig_1019"   ) {$all_ref_nodig[]   = $i;}
            if (!isset($key_ref_laatste[$i])  AND $item['column_name']=="ref_laatste_1004" ) {$all_ref_laatste[] = $i;}
            if (!isset($key_ref_naam[$i])     AND $item['column_name']=="ref_naam_1003"    ) {$all_ref_naam[]    = $i;}
            if (!isset($key_ref_status[$i])   AND $item['column_name']=="ref_status_1490"  ) {$all_ref_status[]  = $i;}

            if (!isset($key_vog_nodig[$i])    AND $item['column_name']=="vog_nodig_998"    ) {$all_vog_nodig[]   = $i;}
            if (!isset($key_vog_laatste[$i])  AND $item['column_name']=="vog_laatste_56"   ) {$all_vog_laatste[] = $i;}
            if (!isset($key_vog_kenmerk[$i])  AND $item['column_name']=="vog_kenmerk_68"   ) {$all_vog_kenmerk[] = $i;}
            if (!isset($key_vog_status[$i])   AND $item['column_name']=="vog_status_1489"  ) {$all_vog_status[]  = $i;}
        }

        wachthond($extdebug,2, "indexed", $indexed);

        $key_int_nodig              = $all_int_nodig[0];
        $key_int_status             = $all_int_status[0];

        $key_fot_status             = $all_fot_status[0];
        $key_naw_gecheckt           = $all_naw_gecheckt[0];
        $key_naw_status             = $all_naw_status[0];
        $key_bio_ingevuld           = $all_bio_ingevuld[0];
        $key_bio_gecheckt           = $all_bio_gecheckt[0];
        $key_bio_status             = $all_bio_status[0];        

        $key_ref_nodig              = $all_ref_nodig[0];
        $key_ref_laatste            = $all_ref_laatste[0];
        $key_ref_naam               = $all_ref_naam[0];        
        $key_ref_status             = $all_ref_status[0];

        $key_vog_nodig              = $all_vog_nodig[0];
        $key_vog_laatste            = $all_vog_laatste[0];
        $key_vog_kenmerk            = $all_vog_kenmerk[0];
        $key_vog_status             = $all_vog_status[0];

        wachthond($extdebug,3,  "key_int_nodig",            $key_int_nodig);
        wachthond($extdebug,3,  "key_int_status",           $key_int_status);

        wachthond($extdebug,3,  "key_fot_status",           $key_fot_status);
        wachthond($extdebug,3,  "key_naw_gecheckt",         $key_naw_gecheckt);
        wachthond($extdebug,3,  "key_naw_status",           $key_naw_status);
        wachthond($extdebug,3,  "key_bio_ingevuld",         $key_bio_ingevuld);
        wachthond($extdebug,3,  "key_bio_gecheckt",         $key_bio_gecheckt);
        wachthond($extdebug,3,  "key_bio_status",           $key_bio_status);

        wachthond($extdebug,3,  "key_ref_nodig",            $key_ref_nodig);
        wachthond($extdebug,3,  "key_ref_laatste",          $key_ref_laatste);
        wachthond($extdebug,3,  "key_ref_naam",             $key_ref_naam);
        wachthond($extdebug,3,  "key_ref_status",           $key_ref_status);

        wachthond($extdebug,3,  "key_vog_nodig",            $key_vog_nodig);
        wachthond($extdebug,3,  "key_vog_laatste",          $key_vog_laatste);
        wachthond($extdebug,3,  "key_vog_kenmerk",          $key_vog_kenmerk);
        wachthond($extdebug,3,  "key_vog_status",           $key_vog_status);

        ##########################################################################################
        ### GET INT NODIG
        ##########################################################################################        

        if ($key_int_nodig >= 0) {
            $raw_int_nodig             = $params[$key_int_nodig]['value']               ?? NULL;
            $new_int_nodig             = explode('', $raw_int_nodig ?? '');
            $org_int_nodig             = $new_int_nodig;  
            wachthond($extdebug,3,      "org_int_nodig", $org_int_nodig[0]);
        }

        ##########################################################################################
        ### GET INT STATUS
        ##########################################################################################        

        if ($key_int_status >= 0) {
            $raw_int_status             = $params[$key_int_status]['value']             ?? NULL;
            $val_int_status             = explode('', $raw_int_status ?? '');
            wachthond($extdebug,3,      "val_int_status", $val_int_status[0]);
        }

        ##########################################################################################
        ### GET FOT STATUS
        ##########################################################################################        

        if ($key_fot_status >= 0) {
            $raw_fot_status             = $params[$key_fot_status]['value']             ?? NULL;
            $val_fot_status             = explode('', $raw_fot_status ?? '');
            wachthond($extdebug,3,      "val_fot_status", $val_fot_status[0]);
        }

        ##########################################################################################
        ### GET DATUM NAW GECHECKT
        ##########################################################################################        

        if ($key_naw_gecheckt >= 0) {
            $pid_naw_gecheckt           = $params[$key_naw_gecheckt]['entity_id']       ?? NULL;
            wachthond($extdebug,3,      "pid_naw_gecheckt", $pid_naw_gecheckt);

            $raw_naw_gecheckt           = $params[$key_naw_gecheckt]['value']           ?? NULL;
            if ($raw_naw_gecheckt) {
                $val_naw_gecheckt       = date("Y-m-d H:i:s", strtotime($raw_naw_gecheckt)); 
            } else {
                $val_naw_gecheckt       = NULL; 
            }
            $krt_naw_gecheckt           = date("Y-m-d",         $new_naw_gecheckt);
            wachthond($extdebug,3,      "val_naw_gecheckt",     $val_naw_gecheckt);
        }

        ##########################################################################################
        ### GET NAW STATUS
        ##########################################################################################        

        if ($key_naw_status >= 0) {
            $raw_naw_status             = $params[$key_naw_status]['value']             ?? NULL;
            $val_naw_status             = explode('', $raw_naw_status ?? '');
            wachthond($extdebug,3,      "val_naw_status", $val_naw_status[0]);
        }

        ##########################################################################################
        ### GET DATUM BIO_INGEVULD
        ##########################################################################################        

        if ($key_bio_ingevuld >= 0) {
            $raw_bio_ingevuld           = $params[$key_bio_ingevuld]['value']           ?? NULL;
            if ($raw_bio_ingevuld) {
                $val_bio_ingevuld       = date("Y-m-d H:i:s", strtotime($raw_bio_ingevuld)); 
            } else {
                $val_bio_ingevuld       = NULL; 
            }
            $krt_bio_ingevuld           = date("Y-m-d",         $new_bio_ingevuld);
            wachthond($extdebug,3,      "val_bio_ingevuld",     $val_bio_ingevuld);
        }

        ##########################################################################################
        ### GET DATUM BIO_GECHECKT
        ##########################################################################################        

        if ($key_bio_gecheckt >= 0) {
            $raw_bio_gecheckt           = $params[$key_bio_gecheckt]['value']           ?? NULL;
            if ($raw_bio_gecheckt) {
                $val_bio_gecheckt       = date("Y-m-d H:i:s", strtotime($raw_bio_gecheckt)); 
            } else {
                $val_bio_gecheckt       = NULL; 
            }
            $krt_bio_gecheckt           = date("Y-m-d",         $new_bio_gecheckt);
            wachthond($extdebug,3,      "val_bio_gecheckt",     $val_bio_gecheckt);
        }

        ##########################################################################################
        ### GET BIO STATUS
        ##########################################################################################        

        if ($key_bio_status >= 0) {
            $raw_bio_status             = $params[$key_bio_status]['value']             ?? NULL;
            $val_bio_status             = explode('', $raw_bio_status ?? '');
            wachthond($extdebug,3,      "val_bio_status",   $val_bio_status[0]);
        }

        ##########################################################################################
        ### GET REF NODIG
        ##########################################################################################        

        if ($key_ref_nodig >= 0) {
            $raw_ref_nodig             = $params[$key_ref_nodig]['value']               ?? NULL;
            $new_ref_nodig             = explode('', $raw_ref_nodig ?? '');
            wachthond($extdebug,3,      "val_ref_nodig", $val_ref_nodig[0]);
        }

        ##########################################################################################
        ### GET DATUM REF_LAATSTE
        ##########################################################################################        

        if ($key_ref_laatste >= 0) {
            $raw_ref_laatste           = $params[$key_ref_laatste]['value']             ?? NULL;
            if ($raw_ref_laatste) {
                $val_ref_laatste       = date("Y-m-d H:i:s", strtotime($raw_ref_laatste)); 
            } else {
                $val_ref_laatste       = NULL; 
            }
            $krt_ref_laatste           = date("Y-m-d",         $new_ref_laatste);
            wachthond($extdebug,3,      "val_ref_laatste",     $val_ref_laatste);
        }        

        ##########################################################################################
        ### GET REF STATUS
        ##########################################################################################        

        if ($key_ref_status >= 0) {
            $raw_ref_status             = $params[$key_ref_status]['value']             ?? NULL;
            $val_ref_status             = explode('', $raw_ref_status ?? '');
            wachthond($extdebug,3,      "org_ref_status", $org_ref_status[0]);
        }

        ##########################################################################################
        ### GET VOG NODIG
        ##########################################################################################        

        if ($key_vog_nodig >= 0) {
            $raw_vog_nodig             = $params[$key_vog_nodig]['value']               ?? NULL;
            $val_vog_nodig             = explode('', $raw_vog_nodig ?? '');
            wachthond($extdebug,3,      "org_vog_nodig", $org_vog_nodig[0]);
        }

        ##########################################################################################
        ### GET DATUM VOG_LAATSTE
        ##########################################################################################

        if ($key_vog_laatste >= 0) {
            $raw_vog_laatste           = $params[$key_vog_laatste]['value']             ?? NULL;
            if ($raw_vog_laatste) {
                $val_vog_laatste       = date("Y-m-d H:i:s", strtotime($raw_vog_laatste)); 
            } else {
                $val_vog_laatste       = NULL; 
            }
            $krt_vog_laatste           = date("Y-m-d",         $new_vog_laatste);
            wachthond($extdebug,3,      "val_vog_laatste",     $val_vog_laatste);
        }

        ##########################################################################################
        ### GET DATUM VOG_KENMERK
        ##########################################################################################        

        if ($key_vog_kenmerk >= 0) {
            $raw_vog_kenmerk           = $params[$key_vog_kenmerk]['value']             ?? NULL;
            $val_vog_kenmerk           = $raw_vog_kenmerk; 
            wachthond($extdebug,3,      "val_vog_kenmerk", $val_vog_kenmerk);
        }

        ##########################################################################################
        ### GET VOG STATUS
        ##########################################################################################        

        if ($key_vog_status >= 0) {
            $raw_vog_status             = $params[$key_vog_status]['value']             ?? NULL;
            $val_vog_status             = explode('', $raw_vog_status ?? '');
            wachthond($extdebug,3,      "val_vog_status", $val_vog_status[0]);
        }

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 1.2 RETREIVE RELEVANT CONTACT VALUES");
        wachthond($extdebug,1, "########################################################################");

        $params_contact = [
            'checkPermissions' => FALSE,
            'debug'  => $apidebug,        
            'select' => [
                'display_name',
                'DITJAAR.ditjaar_kampjaar',
                'DITJAAR.ditjaar_kampkort',
                'DITJAAR.ditjaar_regdate',
                'DITJAAR.ditjaar_functie',
                'DITJAAR.ditjaar_rol',
                'DITJAAR.ditjaar_deelnamestatus',
                'WERVING.nextkamp_decimalen',
            ],
            'where' => [
                ['id',        'IN', [$contact_id]],
            ],
        ];
        wachthond($extdebug,7, 'params_contact',            $params_contact);
        $result_contact  = civicrm_api4('Contact','get',    $params_contact);
        wachthond($extdebug,9, 'result_contact',            $result_contact);

        $displayname        = $result_contact[0]['display_name']                ?? NULL;
        $ditjaar_kampkort   = $result_contact[0]['DITJAAR.ditjaar_kampkort']    ?? NULL;
        $ditjaar_kampjaar   = $result_contact[0]['DITJAAR.ditjaar_kampjaar']    ?? NULL;
        $ditjaar_regdate    = $result_contact[0]['DITJAAR.ditjaar_regdate']     ?? NULL;
        $ditjaar_functie    = $result_contact[0]['DITJAAR.ditjaar_functie']     ?? NULL;
        $ditjaar_rol        = $result_contact[0]['DITJAAR.ditjaar_rol']         ?? NULL;
        $leeftijd_decimaal  = $result_contact[0]['WERVING.nextkamp_decimalen']  ?? NULL;

        wachthond($extdebug,2, 'displayname',               $displayname);
        wachthond($extdebug,2, 'ditjaar_kampkort',          $ditjaar_kampkort);
        wachthond($extdebug,2, 'ditjaar_kampjaar',          $ditjaar_kampjaar);
        wachthond($extdebug,2, 'ditjaar_regdate',           $ditjaar_regdate);
        wachthond($extdebug,2, 'ditjaar_functie',           $ditjaar_functie);
        wachthond($extdebug,2, 'ditjaar_rol',               $ditjaar_rol);
        wachthond($extdebug,2, 'leeftijd_decimaal',         $leeftijd_decimaal);

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 1.2 RETREIVE TODAY FISCAL YEAR START VALUE FROM CACHE");
        wachthond($extdebug,1, "########################################################################");

        if (!Civi::cache()->get('cache_today_fiscalyear_start'))    {
            find_fiscalyear();
        }   
        $today_fiscalyear_start = Civi::cache()->get('cache_today_fiscalyear_start')    ?? NULL;
        $today_fiscalyear_einde = Civi::cache()->get('cache_today_fiscalyear_einde')    ?? NULL;
        $today_kampjaar         = Civi::cache()->get('cache_today_kampjaar')            ?? NULL;
        wachthond($extdebug,4, 'today_kampjaar',            $today_kampjaar);
        wachthond($extdebug,4, 'today_fiscalyear_start',    $today_fiscalyear_start);
        wachthond($extdebug,4, 'today_fiscalyear_einde',    $today_fiscalyear_einde);

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 1.3 BEPAAL GRENSNOGGOED REF & VOG VOOR HOOFDLEIDING & STAF");
        wachthond($extdebug,1, "########################################################################");

        ################################################################################################
        # RETREIVE GRENS VOG NOG GOED VALUE FROM CACHE
        ################################################################################################

        $grensvognoggoed1       = Civi::cache()->get('cache_grensvognoggoed1')          ?? NULL;
        $grensvognoggoed3       = Civi::cache()->get('cache_grensvognoggoed3')          ?? NULL;
        $grensrefnoggoed3       = Civi::cache()->get('cache_grensrefnoggoed3')          ?? NULL;
        wachthond($extdebug,3, 'grensvognoggoed1',          $grensvognoggoed1);
        wachthond($extdebug,3, 'grensvognoggoed3',          $grensvognoggoed3);
        wachthond($extdebug,3, 'grensrefnoggoed3',          $grensrefnoggoed3);

        wachthond($extdebug,3, "ditjaar_functie",           $ditjaar_functie);

        if (in_array($ditjaar_functie, array('hoofdleiding', 'bestuurslid'))) {

            $grensrefnoggoed    = $grensvognoggoed1;
            $grensvognoggoed    = $grensvognoggoed1;
            $grensnoggoedjaar   = 1;
            wachthond($extdebug,2, "grensvognoggoed voor groepsleiding is $grensnoggoedjaar jaar",    $grensvognoggoed);

        } else {

            $grensrefnoggoed    = $grensrefnoggoed3;
            $grensvognoggoed    = $grensvognoggoed3;
            $grensnoggoedjaar   = 3;
            wachthond($extdebug,2, "grensvognoggoed voor groepsleiding is $grensnoggoedjaar jaar",    $grensvognoggoed);
        }

        wachthond($extdebug,3, 'grensvognoggoed',           $grensvognoggoed);
        wachthond($extdebug,3, 'grensnoggoedjaar',          $grensnoggoedjaar);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 3.1 NAW - 1e KEER LEID DAN NAWDATE = REGDATE",   "[NAW]");
        wachthond($extdebug,2, "########################################################################");

        if ($ditjaar_rol == 'leiding') {
            if (empty($val_naw_gecheckt) AND $ditjaar_regdate) {
                $new_ditjaar_nawgecheckt    = $ditjaar_regdate;
                wachthond($extdebug,3, 'GEBRUIK REGISTER DATE ALS NAW GECHECKED BIJ AANGEMELDE LEIDING', $ditjaar_regdate);
            }
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 3.2 NAW - BEPAAL STATUS",                        "[NAW]");
        wachthond($extdebug,2, "########################################################################");

        $nawgecheckt_infiscalyear_ditjaar   = infiscalyear($val_naw_gecheckt, $today_datetime, 'nawgecheckt','ditjaar');

        if ($nawgecheckt_infiscalyear_ditjaar == 1) {
            $new_ditjaar_nawstatus  = 'bijgewerkt';
            wachthond($extdebug,1,  "NAW GECHECKT [$krt_naw_gecheckt] > FISCALE JAAR [>$today_fiscalyear_start]", 
                                    "[$new_ditjaar_nawstatus]");
        } else {
            $new_ditjaar_nawstatus  = 'ongecheckt';
        }
        if ($nawgecheckt_infiscalyear_ditjaar == 'before') {
            $new_ditjaar_nawstatus  = 'ongecheckt';
            wachthond($extdebug,1,  "NAW GECHECKT [$krt_naw_gecheckt] < FISCALE JAAR [<$today_fiscalyear_start]",
                                    "[$new_ditjaar_nawstatus]");
        }

        $new_ditjaar_nawgecheckt = $val_naw_gecheckt;

        wachthond($extdebug,4,  "new_ditjaar_nawstatus",    $new_ditjaar_nawstatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 3.3 NAW - INJECTEER WAARDE IN PARAMS",           "[NAW]");
        wachthond($extdebug,2, "########################################################################");

        wachthond($extdebug,4,  "key_naw_status",           $key_naw_status);

        if (is_numeric($key_naw_status) AND !empty($new_ditjaar_nawstatus)) {
            wachthond($extdebug,3, 'OLD params[key_naw_status][value]', $params[$key_naw_status]);
            $params[$key_naw_status]['value'] = $new_ditjaar_nawstatus;
            wachthond($extdebug,3, 'NEW params[key_naw_status][value]', $params[$key_naw_status]);
        }

        wachthond($extdebug,4, 'today_kampjaar',            $today_kampjaar);
        wachthond($extdebug,4, 'new_ditjaar_nawnodig',      $new_ditjaar_nawnodig);
        wachthond($extdebug,1, 'new_ditjaar_nawgecheckt',   $new_ditjaar_nawgecheckt);
        wachthond($extdebug,3, 'new_ditjaar_nawstatus',     $new_ditjaar_nawstatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 4.1 PAS BIO GECHECKT AAN OBV BIO INGEVULD");
        wachthond($extdebug,2, "########################################################################");

        // WHEN BIO INGEVULD IS AANWEZIG EN NIEUWER DAN BIO GECHECKT

        if (date_biggerequal($val_bio_ingevuld, $val_bio_gecheckt, 'bioingevuld', 'biogecheckt') == 1) {

            wachthond($extdebug,2, 'org_bio_ingevuld',          $val_bio_ingevuld);
            wachthond($extdebug,2, 'val_bio_gecheckt',          $val_bio_gecheckt);

            $val_bio_gecheckt = $val_bio_ingevuld;              // M61 overschrijf de waarde voor gebruik in 2.3
            $krt_bio_gecheckt = $krt_bio_ingevuld;              // M61 overschrijf de waarde voor gebruik in 2.3

            if ($key_bio_gecheckt AND !empty($val_bio_ingevuld)) {

                wachthond($extdebug,3, 'OLD params[key_bio_gecheckt]',  $params[$key_bio_gecheckt]);                    
                $params[$key_bio_gecheckt]['value'] =                   $params[$key_bio_ingevuld]['value'];
                wachthond($extdebug,3, 'NEW params[key_bio_gecheckt]',  $params[$key_bio_gecheckt]);
            }

            wachthond($extdebug,1,  "OVERSCHRIJF BIO GECHECKT [$val_bio_gecheckt] MET RECENTERE DATUM BIO INGEVULD [$val_bio_ingevuld]");
        }

        // WHEN BIO INGEVULD IS AANWEZIG MAAR BIO GECHECKT = LEEG

        if ($val_bio_ingevuld AND empty($val_bio_gecheckt)) {

            wachthond($extdebug,2, 'org_bio_ingevuld',          $val_bio_ingevuld);
            wachthond($extdebug,2, 'val_bio_gecheckt',          $val_bio_gecheckt);

            $val_bio_gecheckt = $val_bio_ingevuld;              // M61 overschrijf de waarde voor gebruik in 2.3
            $krt_bio_gecheckt = $krt_bio_ingevuld;              // M61 overschrijf de waarde voor gebruik in 2.3

            if ($key_bio_gecheckt AND !empty($val_bio_ingevuld)) {

                wachthond($extdebug,3, 'OLD params[key_bio_gecheckt]',  $params[$key_bio_gecheckt]);                    
                $params[$key_bio_gecheckt]['value'] =                   $params[$key_bio_ingevuld]['value'];
                wachthond($extdebug,3, 'NEW params[key_bio_gecheckt]',  $params[$key_bio_gecheckt]);
            }

            wachthond($extdebug,1,  "OVERSCHRIJF BIO GECHECKT [$val_bio_gecheckt] MET RECENTERE DATUM BIO INGEVULD [$val_bio_ingevuld]");
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 4.2 BIO - BEPAAL STATUS",                        "[BIO]");
        wachthond($extdebug,2, "########################################################################");

        $biogecheckt_infiscalyear_ditjaar   = infiscalyear($val_bio_gecheckt,    $today_datetime,        'biogecheckt','ditjaar');

        if ($biogecheckt_infiscalyear_ditjaar == 1) {
            $new_ditjaar_biostatus  = 'bijgewerkt';
            wachthond($extdebug,1,  "BIO GECHECKT [$krt_bio_gecheckt] > FISCALE JAAR [$today_fiscalyear_start]", 
                                    "[$new_ditjaar_biostatus]");
        } else {
            $new_ditjaar_biostatus  = 'ongecheckt';
        }
        if ($biogecheckt_infiscalyear_ditjaar == 'before') {
            $new_ditjaar_biostatus  = 'ongecheckt';
            wachthond($extdebug,1,  "BIO GECHECKT [$krt_bio_gecheckt] < FISCALE JAAR [$today_fiscalyear_start]",
                                    "[$new_ditjaar_biostatus]");
        }

        wachthond($extdebug,4,  "new_ditjaar_biostatus",    $new_ditjaar_biostatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 4.3 BIO - INJECTEER WAARDE IN PARAMS",           "[BIO]");
        wachthond($extdebug,2, "########################################################################");

        wachthond($extdebug,4,  "key_bio_status",           $key_bio_status);

        if ($key_bio_status AND !empty($new_ditjaar_biostatus)) {
            wachthond($extdebug,3, 'OLD params[key_bio_status][value]', $params[$key_bio_status]);
            $params[$key_bio_status]['value'] = $new_ditjaar_biostatus;
            wachthond($extdebug,3, 'NEW params[key_bio_status][value]', $params[$key_bio_status]);
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 5.1 REF - BEPAAL WAARDE NODIG",                  "[REF]");
        wachthond($extdebug,2, "########################################################################");

        $new_ditjaar_refnodig   = NULL;
        $new_ditpart_refnodig   = NULL;

        ### INDIEN ER GEEN REFRECENT IS DAN IS DEZE DUS NOG NODIG
        if ($curcv_keer_leid == 1) {
            $new_ditjaar_refnodig   = 'eerstex';
        } elseif ($curcv_keer_leid >= 2) { 
            $new_ditjaar_refnodig   = 'opnieuw';
        } else {
            $new_ditjaar_refnodig   = 'opnieuw';
        }

        if (in_array($ditjaar_functie, array('hoofdleiding', 'bestuurslid'))) {
            $new_ditjaar_refnodig   = 'elkjaar';
        }

        wachthond($extdebug,4,  "new_ditjaar_refnodig",    $new_ditjaar_refnodig);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 5.2 REF - BEPAAL WAARDE STATUS",          "$displayname");
        wachthond($extdebug,2, "########################################################################");

        if ($val_ref_laatste) {

            $refrecent_infiscalyear_ditjaar  = infiscalyear($val_ref_laatste, $today_datetime,      'refrecent','ditjaar');
            wachthond($extdebug,3, "refrecent_infiscalyear_ditjaar","$refrecent_infiscalyear_ditjaar\t[refrecent: $val_ref_laatste]");

            $refrecent_binnengrens = date_biggerequal($val_ref_laatste,     $grensrefnoggoed, 'refrecent', 'grensref');
            $refrecent_buitengrens = date_biggerequal($grensrefnoggoed,     $val_ref_laatste, 'grensref',  'refrecent');
            wachthond($extdebug,3, "refrecent_binnengrens",         "$refrecent_binnengrens\t[refrecent: $val_ref_laatste]");
            wachthond($extdebug,3, "refrecent_buitengrens",         "$refrecent_buitengrens\t[refrecent: $val_ref_laatste]");
        }

        if ($val_ref_laatste) {

            $refrecent_infiscalyear_ditjaar  = infiscalyear($val_ref_laatste,$today_datetime,       'refrecent','ditjaar');
            wachthond($extdebug,3,  "refrecent_infiscalyear_ditjaar",  
                                    "$refrecent_infiscalyear_ditjaar\t[refrecent: $val_ref_laatste]");
            wachthond($extdebug,3,  "refrecent_infiscalyear_ditevent",
                                    "$refrecent_infiscalyear_ditevent\t[refrecent: $val_ref_laatste]");       

            $refrecent_binnengrens = date_biggerequal($val_ref_laatste, $grensrefnoggoed, 'refrecent', 'refgrens');
            $refrecent_buitengrens = date_biggerequal($grensrefnoggoed, $val_ref_laatste, 'refgrens',  'refrecent');
            wachthond($extdebug,3, "refrecent_binnengrens",       "$refrecent_binnengrens\t[refrecent: $val_ref_laatste]");
            wachthond($extdebug,3, "refrecent_buitengrens",       "$refrecent_buitengrens\t[refrecent: $val_ref_laatste]");

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### A STATUS REF IGV VOGRECENT BUITEN GRENSNOGGOED",              "[REF]");
            wachthond($extdebug,3, "########################################################################");

            // REFRECENT VALT BUITEN GRENS NOGGOED
            if ($refrecent_buitengrens == 1 OR empty($val_ref_laatste)) {

                wachthond($extdebug,2,  "DATUM REF [$val_ref_laatste] VALT BUITEN GRENS NOGGOED REF ($grensnoggoedjaar JAAR)",
                                        "[>$grensrefnoggoed]");

                $new_ditjaar_refstatus          = 'onbekend';

                if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {
                    $new_ditpart_refstatus      = 'onbekend';
                }
            }

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### B STATUS REF IGV VOGRECENT BINNEN GRENSNOGGOED",              "[REF]");
            wachthond($extdebug,3, "########################################################################");

            // REFRECENT VALT BINNEN GRENS NOGGOED
            if ($refrecent_binnengrens == 1) {

                wachthond($extdebug,2,  "DATUM REF [$val_ref_laatste] VALT BINNEN GRENS NOGGOED REF ($grensnoggoedjaar JAAR)",
                                        "[>$grensrefnoggoed]");

                $new_ditjaar_refstatus      = 'noggoed';

                ### INDIEN BINNEN GRENS + EVENT IS VAN DITJAAR
                if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {
                    $new_ditpart_refstatus    = 'noggoed';
                }

                // REFRECENT VALT BINNEN EVENTJAAR VAN DITEVENT
                if ($refrecent_infiscalyear_ditjaar == 1) {

                    wachthond($extdebug,2,  "DATUM REF [$val_ref_laatste] VALT BINNEN HUIDIGE FISCALE JAAR)",
                                            "[>$today_fiscalyear_start]");

                    $new_ditjaar_refstatus  = 'ontvangen';

                    if ($refrecent_infiscalyear_ditevent == 1) {

                        wachthond($extdebug,2,  "DATUM REF [$val_ref_laatste] VALT BINNEN DIT JAAR VAN DIT EVENT",
                                            "[>$ditevent_fiscalyear_start]");

                        $new_ditpart_refstatus  = 'ontvangen';
                    }
                }
            }

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### C STATUS REG IGV VOGRECENT = LEEG",                           "[REF]");
            wachthond($extdebug,3, "########################################################################");

            ### INDIEN ER GEEN REFRECENT IS DAN IS DEZE DUS NOG NODIG
            if ($curcv_keer_leid == 1) {
                $new_ditjaar_refnodig   = 'eerstex';
            } elseif ($curcv_keer_leid >= 2) { 
                $new_ditjaar_refnodig   = 'opnieuw';
            }

            $new_ditjaar_refstatus      = 'onbekend'; // basisstatus

            if ($new_ditjaar_refstatus == 'bekend') {
                $new_ditjaar_refstatus  = 'vragen';
            }

            wachthond($extdebug,2, "DATUM REFRECENT IS LEEG DUS REFNODIG WORDT", "[$new_ditjaar_refnodig]");

        }

        wachthond($extdebug,4,  "new_ditjaar_refstatus",    $new_ditjaar_refstatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 5.3 REF - INJECTEER WAARDE IN PARAMS",           "[REF]");
        wachthond($extdebug,2, "########################################################################");

        wachthond($extdebug,4,  "key_ref_nodig",           $key_ref_nodig);

        if (is_numeric($key_ref_nodig) AND !empty($new_ditjaar_refnodig)) {
            wachthond($extdebug,3, 'OLD params[key_ref_nodig][value]', $params[$key_ref_nodig]);
            $params[$key_ref_nodig]['value'] = $new_ditjaar_refnodig;
            wachthond($extdebug,3, 'NEW params[key_ref_nodig][value]', $params[$key_ref_nodig]);
        }

        wachthond($extdebug,4,  "key_ref_status",           $key_ref_status);

        if (is_numeric($key_ref_status) AND !empty($new_ditjaar_refstatus)) {
            wachthond($extdebug,3, 'OLD params[key_ref_status][value]', $params[$key_ref_status]);
            $params[$key_ref_status]['value'] = $new_ditjaar_refstatus;
            wachthond($extdebug,3, 'NEW params[key_ref_status][value]', $params[$key_ref_status]);
        }

        wachthond($extdebug,2, 'today_kampjaar',            $today_kampjaar);
        wachthond($extdebug,1, 'new_ditjaar_refnodig',      $new_ditjaar_refnodig);
        wachthond($extdebug,1, 'new_ditjaar_refstatus',     $new_ditjaar_refstatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 6.1 VOG - BEPAAL WAARDE NODIG",           "$displayname");
        wachthond($extdebug,2, "########################################################################");

        $new_ditjaar_vognodig   = NULL;
        $new_ditpart_vognodig   = NULL;

        ### INDIEN ER GEEN VOGRECENT IS DAN IS DEZE DUS NOG NODIG
        if ($curcv_keer_leid == 1) {
            $new_ditjaar_vognodig   = 'eerstex';
        } elseif ($curcv_keer_leid >= 2) { 
            $new_ditjaar_vognodig   = 'opnieuw';
        } else {
            $new_ditjaar_vognodig   = 'opnieuw';
        }

        if (in_array($ditjaar_functie, array('hoofdleiding', 'bestuurslid'))) {
            $new_ditjaar_vognodig   = 'elkjaar';
        }

        wachthond($extdebug,4,  "new_ditjaar_vognodig",    $new_ditjaar_vognodig);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 6.2 VOG - BEPAAL WAARDE STATUS",          "$displayname");
        wachthond($extdebug,2, "########################################################################");

        if ($val_vog_laatste) {

            $vogrecent_infiscalyear_ditjaar  = infiscalyear($val_vog_laatste, $today_datetime,      'vogrecent','ditjaar');
            wachthond($extdebug,3, "vogrecent_infiscalyear_ditjaar",  "$vogrecent_infiscalyear_ditjaar\t[vogrecent: $val_vog_laatste]");

            $vogrecent_binnengrens = date_biggerequal($val_vog_laatste,     $grensvognoggoed, 'vogrecent', 'grensvog');
            $vogrecent_buitengrens = date_biggerequal($grensvognoggoed,     $val_vog_laatste, 'grensvog',  'vogrecent');
            wachthond($extdebug,3, "vogrecent_binnengrens",         "$vogrecent_binnengrens\t[vogrecent: $val_vog_laatste]");
            wachthond($extdebug,3, "vogrecent_buitengrens",         "$vogrecent_buitengrens\t[vogrecent: $val_vog_laatste]");
        }

        // M61: TODO: EXTRA CHECK DOEN OF ER EEN GELDIGE AANVRAAG IS VAN ANDER EVENT DIT JAAR (HANDIG BIJ 2X ALS LEIDING MEE)

        if ($val_vog_laatste) {

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### A STATUS VOG IGV VOGRECENT BUITEN GRENSNOGGOED");
            wachthond($extdebug,3, "########################################################################");

            $org_ditpart_vogstatus = $ditpart_vogstatus; 

            // VOGRECENT VALT BUITEN GRENS NOGGOED
            if ($vogrecent_buitengrens == 1 OR empty($val_vog_laatste)) {

                wachthond($extdebug,2,  "DATUM VOG [$val_vog_laatste] VALT BUITEN GRENSNOGGOED ($grensnoggoedjaar JAAR)", 
                                        "[>$grensvognoggoed]");

                $new_ditjaar_vogstatus          = 'klaarzetten';

                if ($curcv_keer_leid == 1) {
                    $new_ditjaar_vognodig       = 'eerstex';
                }
            }

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### B STATUS VOG IGV VOGRECENT BINNEN GRENSNOGGOED");
            wachthond($extdebug,3, "########################################################################");

            // VOGRECENT VALT BINNEN GRENS NOGGOED MAAR NIET IN HUIDIGE FISCALE JAAR
            if ($vogrecent_binnengrens == 1 AND $vogrecent_infiscalyear_ditjaar != 1) {

                wachthond($extdebug,2,  "DATUM VOG [$val_vog_laatste] VALT BINNEN GRENS NOGGOED VOG ($grensnoggoedjaar JAAR)",   
                                        "[>$grensvognoggoed]");

#               $new_ditjaar_vognodig           = 'noggoed';
                $new_ditjaar_vogstatus          = 'noggoed';

            }

            // VOGRECENT VALT BINNEN HUIDIG FISCALE JAAR
            if ($vogrecent_infiscalyear_ditjaar == 1) {

                wachthond($extdebug,2,  "DATUM VOG [$val_vog_laatste] VALT BINNEN HET HUIDIGE FISCALE JAAR",   
                                        "[>$today_fiscalyear_start] VOGNODIG: ");

                $new_ditjaar_vogstatus          = 'ontvangen';
            }

        } else {

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### C STATUS VOG IGV VOGRECENT = LEEG",                           "[VOG]");
            wachthond($extdebug,3, "########################################################################");
  
//          $new_ditjaar_vogstatus              = 'klaarzetten';

            wachthond($extdebug,2, "DATUM VOGRECENT IS LEEG DUS VOGNODIG WORDT", "[$new_ditjaar_vognodig]");

        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 6.3 VOG - INJECTEER WAARDE IN PARAMS",           "[VOG]");
        wachthond($extdebug,2, "########################################################################");

        ##########################################################################################
        ### INJECTEER WAARDE IN PARAMS INDIEN WAARDE AANWEZIG
        ##########################################################################################

        wachthond($extdebug,4,  "key_vog_nodig",           $key_vog_nodig);

        if (is_numeric($key_vog_nodig) AND !empty($new_ditjaar_vognodig)) {
            wachthond($extdebug,3, 'OLD params[key_vog_nodig][value]', $params[$key_vog_nodig]);
            $params[$key_vog_nodig]['value'] = $new_ditjaar_vognodig;
            wachthond($extdebug,3, 'NEW params[key_vog_nodig][value]', $params[$key_vog_nodig]);
        }

        wachthond($extdebug,4,  "key_vog_status",           $key_vog_status);
        wachthond($extdebug,4,  "new_ditjaar_vogstatus",    $new_ditjaar_vogstatus);

        if (is_numeric($key_vog_status) AND !empty($new_ditjaar_vogstatus)) {
            wachthond($extdebug,3, 'OLD params[key_vog_status][value]', $params[$key_vog_status]);
            $params[$key_vog_status]['value'] = $new_ditjaar_vogstatus;
            wachthond($extdebug,3, 'NEW params[key_vog_status][value]', $params[$key_vog_status]);
        }

        wachthond($extdebug,2, 'today_kampjaar',            $today_kampjaar);
        wachthond($extdebug,1, 'new_ditjaar_vognodig',      $new_ditjaar_vognodig);
        wachthond($extdebug,1, 'new_ditjaar_vogstatus',     $new_ditjaar_vogstatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 7.1 INT - BEPAAL WAARDE NODIG",                  "[INT]");
        wachthond($extdebug,2, "########################################################################");

        ### INDIEN ER GEEN REFRECENT IS DAN IS DEZE DUS NOG NODIG
        if ($curcv_keer_leid == 1) {
            $new_ditjaar_intnodig   = 'eerstex';
        } elseif ($curcv_keer_leid >= 2) { 
            $new_ditjaar_intnodig   = 'opnieuw';
        } else {
            $new_ditjaar_intnodig   = 'opnieuw';
        }

        if (in_array($ditjaar_functie, array('hoofdleiding', 'bestuurslid'))) {
            $new_ditjaar_intnodig   = 'elkjaar';
        }

        wachthond($extdebug,3,  "new_ditjaar_intnodig",    $new_ditjaar_intnodig);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 7.2 INT - BEPAAL STATUS",                        "[INT]");
        wachthond($extdebug,2, "########################################################################");

        if (in_array($new_ditjaar_nawstatus, array("noggoed", "bijgewerkt")))           {
            $intakestatusnawdone  = 1;
        }
        if (in_array($new_ditjaar_biostatus, array("noggoed", "bijgewerkt")))           {
            $intakestatusbiodone  = 1;
        }
        if (in_array($new_ditjaar_refstatus, array("noggoed", "vragen", "ontvangen")))  {   // M61: wat te doen met status: bekend
            $intakestatusrefdone  = 1;
        }
        if (in_array($new_ditjaar_vogstatus, array("noggoed", "ontvangen")))            {   // M61: wat te doen met status: ingediend
            $intakestatusvogdone  = 1;
        }

        if ($intakestatusnawdone == 1 AND $intakestatusbiodone == 1 AND $intakestatusrefdone == 1 AND $intakestatusvogdone == 1) { 
            $new_ditjaar_intstatus = 'compleet';
        } else {
            $new_ditjaar_intstatus = 'gedeeltelijk';            
        }

        wachthond($extdebug,4,  "new_ditjaar_intstatus",    $new_ditjaar_intstatus);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] 7.3 INT - INJECTEER WAARDE IN PARAMS",           "[INT]");
        wachthond($extdebug,2, "########################################################################");

        wachthond($extdebug,3,  "key_int_nodig",            $key_int_nodig);

        if (is_numeric($key_int_nodig) AND !empty($new_ditjaar_intnodig)) {
            wachthond($extdebug,3, 'OLD params[key_int_nodig][value]', $params[$key_int_nodig]);
            $params[$key_int_nodig]['value'] = $new_ditjaar_intnodig;
            wachthond($extdebug,3, 'NEW params[key_int_nodig][value]', $params[$key_int_nodig]);
        }

        wachthond($extdebug,4,  "key_int_status",           $key_int_status);

        if (is_numeric($key_int_status) AND !empty($new_ditjaar_intstatus)) {
            wachthond($extdebug,3, 'OLD params[key_int_status][value]', $params[$key_int_status]);
            $params[$key_int_status]['value'] = $new_ditjaar_intstatus;
            wachthond($extdebug,3, 'NEW params[key_int_status][value]', $params[$key_int_status]);
        }

        wachthond($extdebug,2, 'today_kampjaar',            $today_kampjaar);
        wachthond($extdebug,1, 'new_ditjaar_intnodig',      $new_ditjaar_intnodig);
        wachthond($extdebug,1, 'new_ditjaar_intstatus',     $new_ditjaar_intstatus);

        wachthond($extdebug,4, "NEW params",                $params);

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INTAKE [PRE] EINDE NAW / BIO / REF / VOG VOOR $entityID", "[groupID: $groupID / op: $op]");
        wachthond($extdebug,1, "########################################################################");

    }

}

function intake_civicrm_custom($op, $groupID, $entityID, &$params) {

    $extdebug           = 3;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug           = FALSE;

    $today_datetime     = date("Y-m-d H:i:s");

    if ($op != 'create' && $op != 'edit') { //    did we just create or edit a custom object?
        wachthond($extdebug,4, "########################################################################");
        wachthond($extdebug,4, "### EXIT: op != create OR op != edit", "(op: $op)");
        wachthond($extdebug,4, "########################################################################");
        return; //  if not, get out of here
    }

    $profilecont        = array(225);
    $profilepartdeel    = array(139);
    $profilepartleid    = array(190);
    $profilepartref     = array(213);
    $profilepartvog     = array(140);

    if (in_array($groupID, $profilepartref))  {
        return;
    }

    $profilepart        = array_merge($profilepartdeel, $profilepartleid);
    $profilepartintake  = array_merge($profilepartref,  $profilepartvog);

    $profilecontmax     = array_merge($profilecont);
    $profilepartmax     = array_merge($profilepart,     $profilepartintake);
    $profilepartleidmax = array_merge($profilepartleid, $profilepartintake);
    $profilecv          = array_merge($profilecont,     $profilepart);
    $profilecvmax       = array_merge($profilecontmax,  $profilepartmax);

    if (in_array($groupID, $profilepartintake))  {      // PROFILE CONT & PART (BASIC)

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 10.X START PROFILE PART INTAKE / VOG / REF", "[groupID: $groupID / op: $op]");
        wachthond($extdebug,1, "########################################################################");

        $processintake  = 1;

        $extact         = 1;  //  ACTIVITIES
        $extint         = 1;  //  EXECUTE OR SKIP INTAKE PART

        $extnaw         = 1;
        $extbio         = 1;

        $extref         = 1;
        $extvog         = 1;

        $extwrite       = 1;

        if (in_array($groupID, $profilepartref)) {
            $extref     = 1;
            $extvog     = 0;
        } else {
            $extref     = 0;
        }
        if (in_array($groupID, $profilepartvog)) {
            $extvog     = 1;
            $extref     = 1;
        } else {
            $extvog     = 0;
        }

    } else {
        wachthond($extdebug,4, "########################################################################");
        wachthond($extdebug,4, "### INT 10.X EXIT: groupID ($groupID) not in allowed list (profileintake)", $profileintake);
        wachthond($extdebug,4, "########################################################################");
        return; //  if not, get out of here
    }

    if (in_array($groupID, $profilepartintake))  {

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 10.1 GET PARTICIPANT DATA BASED ON PID",       "[PID: $entityID]");
        wachthond($extdebug,3, "########################################################################");

        $array_partditevent = base_pid2part($entityID, $groupID);
        wachthond($extdebug,3, "array_partditevent", $array_partditevent);

        $contact_id                         = $array_partditevent['contact_id']                     ?? NULL;
        wachthond($extdebug,1, "RETRIEVE CONTACT_ID OBV ENTITYID (part_id) $entityID", "contact_id: $contact_id");

        $ditevent_displayname               = $array_partditevent['displayname']                    ?? NULL;
        $ditevent_contact_id                = $array_partditevent['contact_id']                     ?? NULL;
        $ditevent_part_id                   = $array_partditevent['id']                             ?? NULL;
        $ditevent_part_eventid              = $array_partditevent['part_event_id']                  ?? NULL;
        $ditevent_part_role_id              = $array_partditevent['role_id']                        ?? NULL;
        $ditevent_part_status_id            = $array_partditevent['status_id']                      ?? NULL;
        $ditevent_part_status_name          = $array_partditevent['status_name']                    ?? NULL;

        $ditevent_event_id                  = $array_partditevent['event_id']                       ?? NULL;
        $ditevent_event_title               = $array_partditevent['event_title']                    ?? NULL;
        $ditevent_event_type_id             = $array_partditevent['event_type_id']                  ?? NULL;
        $ditevent_event_type_label          = $array_partditevent['event_type_label']               ?? NULL;

        $ditevent_event_start               = $array_partditevent['event_start_date']               ?? NULL;
        $ditevent_event_einde               = $array_partditevent['event_end_date']                 ?? NULL;

        $ditevent_fiscalyear                = $array_partditevent['event_fiscalyear']               ?? NULL;
        $ditevent_fiscalyear_start          = $array_partditevent['fiscalyear_start']               ?? NULL;
        $ditevent_fiscalyear_einde          = $array_partditevent['fiscalyear_einde']               ?? NULL;

        $ditevent_part_kampstart            = $array_partditevent['part_kampstart']                 ?? NULL;
        $ditevent_part_kampeinde            = $array_partditevent['part_kampeinde']                 ?? NULL;

        $ditevent_kampjaar                  = $array_partditevent['part_kampjaar']                  ?? NULL;
        $ditevent_kampjaarkort              = $array_partditevent['part_kampjaar_kort']             ?? NULL;
        $ditevent_register_date             = $array_partditevent['register_date']                  ?? NULL;

        $ditevent_part_kampnaam             = $array_partditevent['part_kampnaam']                  ?? NULL;
        $ditevent_part_kampkort             = $array_partditevent['part_kampkort']                  ?? NULL;
        $ditevent_part_kampkort_low         = $array_partditevent['part_kampkort_low']              ?? NULL;
        $ditevent_part_kampkort_cap         = $array_partditevent['part_kampkort_cap']              ?? NULL;
        $ditevent_part_kamptype_naam        = $array_partditevent['part_kamptype_naam']             ?? NULL;
        $ditevent_part_kamptype_id          = $array_partditevent['part_kamptype_id']               ?? NULL;

        $ditevent_part_rol                  = $array_partditevent['part_kamprol']                   ?? NULL;    // PART
        $ditevent_part_functie              = $array_partditevent['part_kampfunctie']               ?? NULL;    // PART
        $ditevent_leid_functie              = $array_partditevent['part_leid_functie']              ?? NULL;    // PART_LEID
        $ditevent_leid_welkkamp             = $array_partditevent['part_leid_kamp']                 ?? NULL;    // PART_LEID

        $ditevent_event_kampnaam            = $array_partditevent['kenmerken_kampnaam']             ?? NULL;
        $ditevent_event_kampkort            = $array_partditevent['kenmerken_kampkort']             ?? NULL;
        $ditevent_event_kampkort_low        = $array_partditevent['kenmerken_kampkort_low']         ?? NULL;
        $ditevent_event_kampkort_cap        = $array_partditevent['kenmerken_kampkort_cap']         ?? NULL;
        $ditevent_event_kamptype_naam       = $array_partditevent['kenmerken_kamptype_naam']        ?? NULL;
        $ditevent_event_kamptype_label      = $array_partditevent['kenmerken_kamptype_label']       ?? NULL;
        $ditevent_event_kamptype_id         = $array_partditevent['kenmerken_kamptype_id']          ?? NULL;
        $ditevent_event_kampsoort           = $array_partditevent['kenmerken_kampsoort']            ?? NULL;

        $event_array = array(

            'ditevent_contact_id'       => $ditevent_contact_id,
            'ditevent_displayname'      => $ditevent_displayname,

            'ditevent_part_id'          => $ditevent_part_id,
            'ditevent_part_eventid'     => $ditevent_part_eventid,
            'ditevent_event_eventid'    => $ditevent_event_id,

            'ditevent_leid_functie'     => $ditevent_leid_functie,
            'ditevent_leid_welkkamp'    => $ditevent_leid_welkkamp,
            'ditevent_part_rol'         => $ditevent_part_rol,
            'ditevent_part_functie'     => $ditevent_part_functie,

            'ditevent_part_kampnaam'    => $ditevent_part_kampnaam,
            'ditevent_part_kampkort'    => $ditevent_part_kampkort,

            'ditevent_part_kampkort_low'=> $ditevent_part_kampkort_low,
            'ditevent_part_kampkort_cap'=> $ditevent_part_kampkort_cap,

            'ditevent_event_kampnaam'   => $ditevent_event_title,
            'ditevent_event_type_id'    => $ditevent_event_type_id,

            'ditevent_part_kampjaar'    => $ditevent_kampjaar,
            'ditevent_part_kampstart'   => $ditevent_part_kampstart,
            'ditevent_part_kampeinde'   => $ditevent_part_kampeinde,
            'ditevent_event_kampstart'  => $ditevent_event_start,
            'ditevent_event_kampeinde'  => $ditevent_event_einde,
        );

        $ditevent_event_id                  = $array_partditevent['event_id']                       ?? NULL;
        $ditevent_event_title               = $array_partditevent['event_title']                    ?? NULL;
        $ditevent_event_type_id             = $array_partditevent['event_type_id']                  ?? NULL;
        $ditevent_event_type_label          = $array_partditevent['event_type_label']               ?? NULL;

        $part_intnodig                      = $array_partditevent['part_intnodig']                  ?? NULL;
        $part_nawnodig                      = $array_partditevent['part_nawnodig']                  ?? NULL;
        $part_bionodig                      = $array_partditevent['part_bionodig']                  ?? NULL;
        $part_refnodig                      = $array_partditevent['part_refnodig']                  ?? NULL;
        $part_vognodig                      = $array_partditevent['part_vognodig']                  ?? NULL;

        $part_intstatus                     = $array_partditevent['part_intstatus']                 ?? NULL;
        $part_nawstatus                     = $array_partditevent['part_nawstatus']                 ?? NULL;
        $part_biostatus                     = $array_partditevent['part_biostatus']                 ?? NULL;
        $part_refstatus                     = $array_partditevent['part_refstatus']                 ?? NULL;
        $part_vogstatus                     = $array_partditevent['part_vogstatus']                 ?? NULL;        

        $part_nawgecheckt                   = $array_partditevent['part_naw_gecheckt']              ?? NULL;
        $part_biogecheckt                   = $array_partditevent['part_bio_gecheckt']              ?? NULL;

        $part_refpersoon                    = $array_partditevent['part_refpersoon']                ?? NULL;
        $part_refgevraagd                   = $array_partditevent['part_refgevraagd']               ?? NULL;
        $part_reffeedback                   = $array_partditevent['part_reffeedback']               ?? NULL;

        $part_vogverzocht                   = $array_partditevent['part_vogverzocht']               ?? NULL;
        $part_vogingediend                  = $array_partditevent['part_vogingediend']              ?? NULL;
        $part_vogontvangst                  = $array_partditevent['part_vogontvangst']              ?? NULL;
        $part_vogdatum                      = $array_partditevent['part_vogdatum']                  ?? NULL;
        $part_vogkenmerk                    = $array_partditevent['part_vogkenmerk']                ?? NULL;

        $params_ditevent = [
            'checkPermissions'  => FALSE,
            'debug'             => $apidebug,
            'where' => [
                ['id',  '=', $ditevent_part_id],
            ],
            'values' => [
                'id'    =>   $ditevent_part_id,
            ],
        ];

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 10.2 GET CONTACT DATA BASED ON CID",         "[CID: $contact_id]");
        wachthond($extdebug,3, "########################################################################");

        $array_contditjaar = base_cid2cont($contact_id);
        wachthond($extdebug,4, "array_contditjaar", $array_contditjaar);

        $contact_foto                       = $array_contditjaar['contact_foto']                    ?? NULL;
        $birth_date                         = $array_contditjaar['birth_date']                      ?? NULL;
        $geslacht                           = $array_contditjaar['geslacht']                        ?? NULL;
        $first_name                         = $array_contditjaar['first_name']                      ?? NULL;
        $middle_name                        = $array_contditjaar['middle_name']                     ?? NULL;
        $last_name                          = $array_contditjaar['last_name']                       ?? NULL;    
        $nick_name                          = $array_contditjaar['nick_name']                       ?? NULL;
        $displayname                        = $array_contditjaar['displayname']                     ?? NULL;
        $crm_drupalnaam                     = $array_contditjaar['crm_drupalnaam']                  ?? NULL; // drupal username
        $crm_externalid                     = $array_contditjaar['crm_externalid']                  ?? NULL; // drupal cmsid

        $laatste_keer                       = $array_contditjaar['laatstekeer']                     ?? NULL; // M61: tbv berekenen 'mee komend jaar'       
        $curcv_keer_deel                    = $array_contditjaar['curcv_keer_deel']                 ?? NULL; // keren deel
        $curcv_keer_leid                    = $array_contditjaar['curcv_keer_leid']                 ?? NULL; // keren leid

        $datum_belangstelling               = $array_contditjaar['datum_belangstelling']            ?? NULL;

        $cont_intnodig                      = $array_contditjaar['cont_intnodig']                   ?? NULL;
        $cont_intstatus                     = $array_contditjaar['cont_intstatus']                  ?? NULL;
        $cont_intake_datum                  = $array_contditjaar['cont_intake_datum']               ?? NULL;
        $cont_intake_persoon                = $array_contditjaar['cont_intake_persoon']             ?? NULL;

        $cont_nawnodig                      = $array_contditjaar['cont_nawnodig']                   ?? NULL;
        $cont_nawstatus                     = $array_contditjaar['cont_nawstatus']                  ?? NULL;
        $cont_nawgecheckt                   = $array_contditjaar['cont_nawgecheckt']                ?? NULL;

        $cont_bionodig                      = $array_contditjaar['cont_bionodig']                   ?? NULL;
        $cont_biostatus                     = $array_contditjaar['cont_biostatus']                  ?? NULL;
        $cont_bioingevuld                   = $array_contditjaar['cont_bioingevuld']                ?? NULL;
        $cont_biogecheckt                   = $array_contditjaar['cont_biogecheckt']                ?? NULL;

        $cont_refnodig                      = $array_contditjaar['cont_refnodig']                   ?? NULL;
        $cont_refstatus                     = $array_contditjaar['cont_refstatus']                  ?? NULL;
        $cont_refdatum                      = $array_contditjaar['cont_refdatum']                   ?? NULL;
        $cont_refnaam                       = $array_contditjaar['cont_refnaam']                    ?? NULL;

        $cont_vognodig                      = $array_contditjaar['cont_vognodig']                   ?? NULL;
        $cont_vogstatus                     = $array_contditjaar['cont_vogstatus']                  ?? NULL;
        $cont_voglaatste                    = $array_contditjaar['cont_voglaatste']                 ?? NULL;
        $cont_vogkenmerk                    = $array_contditjaar['cont_vogkenmerk']                 ?? NULL;

        $refrecent          = $array_contditjaar['cont_refdatum']                   ?? NULL;
        $refkenmerk         = $array_contditjaar['cont_refnaam']                    ?? NULL;
        $refpersoon         = $array_contditjaar['cont_refpersoon']                 ?? NULL;
        $reffeedback        = $array_contditjaar['cont_reffeedback']                ?? NULL;

        $vogrecent          = $array_contditjaar['cont_voglaatste']                 ?? NULL;
        $vogkenmerk         = $array_contditjaar['cont_vogkenmerk']                 ?? NULL;

        wachthond($extdebug,3, 'part_id',           $ditevent_part_id);
        wachthond($extdebug,3, 'part_eventid',      $ditevent_part_eventid);
        wachthond($extdebug,3, 'part_status_id',    $ditevent_part_status_id);
        wachthond($extdebug,3, 'part_welkkamp',     $ditevent_leid_welkkamp);
        wachthond($extdebug,3, 'part_functie',      $ditevent_part_functie);

        wachthond($extdebug,3, 'cont_refrecent',    $refrecent);
        wachthond($extdebug,3, 'cont_refpersoon',   $refpersoon);
        wachthond($extdebug,3, 'cont_reffeedback',  $reffeedback);
        wachthond($extdebug,3, 'part_refpersoon',   $part_refpersoon);
        wachthond($extdebug,3, 'part_refgevraagd',  $part_refgevraagd);
        wachthond($extdebug,3, 'part_reffeedback',  $part_reffeedback);

        wachthond($extdebug,3, 'cont_vogrecent',    $vogrecent);
        wachthond($extdebug,3, 'part_vogverzocht',  $part_vogverzocht);
        wachthond($extdebug,3, 'part_vogingediend', $part_vogingediend);
        wachthond($extdebug,3, 'part_vogontvangst', $part_vogontvangst);
        wachthond($extdebug,3, 'part_vogdatum',     $part_vogdatum);
        wachthond($extdebug,3, 'part_vogkenmerk',   $part_vogkenmerk);  

        $params_contact = [
            'checkPermissions'  => FALSE,
            'debug' => $apidebug,
            'where' => [
                ['id',       '=',  $contact_id],
            ],
            'values' => [
                'id'            => $contact_id,
//              'display_name'  => $displayname,
            ],
        ];

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 10.3 GET ALLPART INFO DIT JAAR BASED ON CID","[CID: $contact_id]");
        wachthond($extdebug,3, "########################################################################");

        $array_allpart_ditjaar              = base_find_allpart($contact_id, $today_datetime);

        wachthond($extdebug,4, "########################################################################");
        wachthond($extdebug,2, "array_allpart_ditjaar",                            $array_allpart_ditjaar);
        wachthond($extdebug,4, "########################################################################");

        $ditjaar_refdate                    = $array_allpart_ditjaar['refdate'];
        $ditjaar_refyear                    = $array_allpart_ditjaar['refyear'];

        $ditjaar_refdate                    = $array_allpart_ditjaar['refdate'];
        $ditjaar_refyear                    = $array_allpart_ditjaar['refyear'];

        $ditjaar_all_count                  = $array_allpart_ditjaar['result_allpart_all_count'];
        $ditjaar_pen_count                  = $array_allpart_ditjaar['result_allpart_pen_count'];
        $ditjaar_wait_count                 = $array_allpart_ditjaar['result_allpart_wait_count'];
        $ditjaar_neg_count                  = $array_allpart_ditjaar['result_allpart_neg_count'];

        $ditjaar_pos_count                  = $array_allpart_ditjaar['result_allpart_pos_count'];
        $ditjaar_pos_deel_count             = $array_allpart_ditjaar['result_allpart_pos_deel_count'];
        $ditjaar_pos_leid_count             = $array_allpart_ditjaar['result_allpart_pos_leid_count'];

        $ditjaar_all_count                  = $array_allpart_ditjaar['result_allpart_all_count'];
        $ditjaar_all_deel_count             = $array_allpart_ditjaar['result_allpart_all_deel_count'];
        $ditjaar_all_leid_count             = $array_allpart_ditjaar['result_allpart_all_leid_count'];

        $ditjaar_one_part_id                = $array_allpart_ditjaar['result_allpart_one_part_id'];
        $ditjaar_one_deel_part_id           = $array_allpart_ditjaar['result_allpart_one_deel_part_id'];
        $ditjaar_one_leid_part_id           = $array_allpart_ditjaar['result_allpart_one_leid_part_id'];

        $ditjaar_one_event_id               = $array_allpart_ditjaar['result_allpart_one_event_id'];
        $ditjaar_one_deel_event_id          = $array_allpart_ditjaar['result_allpart_one_deel_event_id'];
        $ditjaar_one_leid_event_id          = $array_allpart_ditjaar['result_allpart_one_leid_event_id'];

        $ditjaar_one_event_type_id          = $array_allpart_ditjaar['result_allpart_one_event_type_id'];
        $ditjaar_one_deel_event_type_id     = $array_allpart_ditjaar['result_allpart_one_deel_event_type_id'];
        $ditjaar_one_leid_event_type_id     = $array_allpart_ditjaar['result_allpart_one_leid_event_type_id'];

        $ditjaar_one_status_id              = $array_allpart_ditjaar['result_allpart_one_status_id'];
        $ditjaar_one_deel_status_id         = $array_allpart_ditjaar['result_allpart_one_deel_status_id'];
        $ditjaar_one_leid_status_id         = $array_allpart_ditjaar['result_allpart_one_leid_status_id'];

        $ditjaar_one_kampfunctie            = $array_allpart_ditjaar['result_allpart_one_kampfunctie'];
        $ditjaar_one_deel_kampfunctie       = $array_allpart_ditjaar['result_allpart_one_deel_kampfunctie'];
        $ditjaar_one_leid_kampfunctie       = $array_allpart_ditjaar['result_allpart_one_leid_kampfunctie'];

        $ditjaar_one_kampkort               = $array_allpart_ditjaar['result_allpart_one_kampkort'];
        $ditjaar_one_deel_kampkort          = $array_allpart_ditjaar['result_allpart_one_deel_kampkort'];
        $ditjaar_one_leid_kampkort          = $array_allpart_ditjaar['result_allpart_one_leid_kampkort'];

        $ditjaar_pos_part_id                = $array_allpart_ditjaar['result_allpart_pos_part_id'];
        $ditjaar_pos_deel_part_id           = $array_allpart_ditjaar['result_allpart_pos_deel_part_id'];
        $ditjaar_pos_leid_part_id           = $array_allpart_ditjaar['result_allpart_pos_leid_part_id'];

        $ditjaar_pos_event_id               = $array_allpart_ditjaar['result_allpart_pos_event_id'];
        $ditjaar_pos_deel_event_id          = $array_allpart_ditjaar['result_allpart_pos_deel_event_id'];
        $ditjaar_pos_leid_event_id          = $array_allpart_ditjaar['result_allpart_pos_leid_event_id'];

        $ditjaar_pos_event_type_id          = $array_allpart_ditjaar['result_allpart_pos_event_type_id'];
        $ditjaar_pos_deel_event_type_id     = $array_allpart_ditjaar['result_allpart_pos_deel_event_type_id'];
        $ditjaar_pos_leid_event_type_id     = $array_allpart_ditjaar['result_allpart_pos_leid_event_type_id'];

        $ditjaar_pos_status_id              = $array_allpart_ditjaar['result_allpart_pos_status_id'];
        $ditjaar_pos_deel_status_id         = $array_allpart_ditjaar['result_allpart_pos_deel_status_id'];
        $ditjaar_pos_leid_status_id         = $array_allpart_ditjaar['result_allpart_pos_leid_status_id'];

        $ditjaar_pos_kampfunctie            = $array_allpart_ditjaar['result_allpart_pos_kampfunctie'];
        $ditjaar_pos_deel_kampfunctie       = $array_allpart_ditjaar['result_allpart_pos_deel_kampfunctie'];
        $ditjaar_pos_leid_kampfunctie       = $array_allpart_ditjaar['result_allpart_pos_leid_kampfunctie'];

        $ditjaar_pos_kampkort               = $array_allpart_ditjaar['result_allpart_pos_kampkort'];
        $ditjaar_pos_deel_kampkort          = $array_allpart_ditjaar['result_allpart_pos_deel_kampkort'];
        $ditjaar_pos_leid_kampkort          = $array_allpart_ditjaar['result_allpart_pos_leid_kampkort'];

        $ditjaar_wait_part_id               = $array_allpart_ditjaar['result_allpart_wait_part_id'];
        $ditjaar_pen_part_id                = $array_allpart_ditjaar['result_allpart_pen_part_id'];
        $ditjaar_neg_part_id                = $array_allpart_ditjaar['result_allpart_neg_part_id'];

        $ditjaar_wait_event_id              = $array_allpart_ditjaar['result_allpart_wait_event_id'];
        $ditjaar_pen_event_id               = $array_allpart_ditjaar['result_allpart_pen_event_id'];
        $ditjaar_neg_event_id               = $array_allpart_ditjaar['result_allpart_neg_event_id'];

        $ditjaar_wait_event_type_id         = $array_allpart_ditjaar['result_allpart_wait_event_type_id'];
        $ditjaar_pen_event_type_id          = $array_allpart_ditjaar['result_allpart_pen_event_type_id'];
        $ditjaar_neg_event_type_id          = $array_allpart_ditjaar['result_allpart_neg_event_type_id'];

        $ditjaar_wait_status_id             = $array_allpart_ditjaar['result_allpart_wait_status_id'];
        $ditjaar_pen_status_id              = $array_allpart_ditjaar['result_allpart_pen_status_id'];
        $ditjaar_neg_status_id              = $array_allpart_ditjaar['result_allpart_neg_status_id'];

        $ditjaar_wait_kampkort              = $array_allpart_ditjaar['result_allpart_wait_kampkort'];
        $ditjaar_pen_kampkort               = $array_allpart_ditjaar['result_allpart_pen_kampkort'];
        $ditjaar_neg_kampkort               = $array_allpart_ditjaar['result_allpart_neg_kampkort'];

        wachthond($extdebug,4, 'entityID',                          $entityID); 
        wachthond($extdebug,4, 'contact_id',                        $contact_id); 

        wachthond($extdebug,2, 'ditevent_contact_id',               $ditevent_contact_id);
        wachthond($extdebug,2, 'ditevent_part_id',                  $ditevent_part_id);
        wachthond($extdebug,2, 'ditevent_part_eventid',             $ditevent_part_eventid);
        wachthond($extdebug,2, 'ditevent_event_type_id',            $ditevent_event_type_id);

        wachthond($extdebug,2, 'ditevent_part_status_id',           $ditevent_part_status_id);
        wachthond($extdebug,2, 'ditevent_part_status_name',         $ditevent_part_status_name);

        wachthond($extdebug,2, 'ditevent_part_kampnaam',            $ditevent_part_kampnaam);
        wachthond($extdebug,2, 'ditevent_part_kampkort',            $ditevent_part_kampkort);
        wachthond($extdebug,2, 'ditevent_part_kamptype_id',         $ditevent_part_kamptype_id);
        wachthond($extdebug,2, 'ditevent_part_kamptype_naam',       $ditevent_part_kamptype_naam);        

        wachthond($extdebug,2, 'ditevent_event_id',                 $ditevent_event_id);
        wachthond($extdebug,2, 'ditevent_event_title',              $ditevent_event_title);
//      wachthond($extdebug,2, 'ditevent_event_kampnaam',           $ditevent_event_kampnaam);
//      wachthond($extdebug,2, 'ditevent_event_kampkort',           $ditevent_event_kampkort);

//      wachthond($extdebug,2, 'ditevent_event_kamptype',           $ditevent_event_kamptype);
//      wachthond($extdebug,2, 'ditevent_event_kamptype_naam',      $ditevent_event_kamptype_naam);
//      wachthond($extdebug,2, 'ditevent_event_kamptype_label',     $ditevent_event_kamptype_label);
//      wachthond($extdebug,2, 'ditevent_event_kamptype_id',        $ditevent_event_kamptype_id);
//      wachthond($extdebug,2, 'ditevent_event_kampsoort',          $ditevent_event_kampsoort);

        if ($ditevent_leid_functie AND $ditevent_event_type_id == 1) {
            wachthond($extdebug,2, 'ditevent_leid_welkkamp',        $ditevent_leid_welkkamp);
            wachthond($extdebug,2, 'ditevent_leid_functie',         $ditevent_leid_functie);
        }

        wachthond($extdebug,2, 'ditevent_part_functie',             $ditevent_part_functie);
        wachthond($extdebug,2, 'ditevent_part_rol',                 $ditevent_part_rol);
        wachthond($extdebug,2, 'ditevent_part_role_id',             $ditevent_part_role_id);

        wachthond($extdebug,2, 'ditevent_register_date',            $ditevent_register_date);
        wachthond($extdebug,2, 'ditevent_event_start',              $ditevent_event_start);
        wachthond($extdebug,2, 'ditevent_event_einde',              $ditevent_event_einde);
        wachthond($extdebug,2, 'ditevent_kampjaar',                 $ditevent_kampjaar);

        wachthond($extdebug,3, 'part_intnodig',             $part_intnodig);
        wachthond($extdebug,3, 'part_nawnodig',             $part_nawnodig);
        wachthond($extdebug,3, 'part_bionodig',             $part_bionodig);
        wachthond($extdebug,3, 'part_refnodig',             $part_refnodig);
        wachthond($extdebug,3, 'part_vognodig',             $part_vognodig);

        wachthond($extdebug,3, 'part_intstatus',            $part_intstatus);
        wachthond($extdebug,3, 'part_nawstatus',            $part_nawstatus);
        wachthond($extdebug,3, 'part_biostatus',            $part_biostatus);
        wachthond($extdebug,3, 'part_refstatus',            $part_refstatus);
        wachthond($extdebug,3, 'part_vogstatus',            $part_vogstatus);

        wachthond($extdebug,3, 'part_nawgecheckt',          $part_nawgecheckt);
        wachthond($extdebug,3, 'part_biogecheckt',          $part_bioghecheckt);

        wachthond($extdebug,3, 'part_refpersoon',           $part_refpersoon);
        wachthond($extdebug,3, 'part_refgevraagd',          $part_refgevraagd);
        wachthond($extdebug,3, 'part_reffeedback',          $part_reffeedback);

        wachthond($extdebug,3, 'part_vogverzocht',          $part_vogverzocht);
        wachthond($extdebug,3, 'part_vogingediend',         $part_vogingediend);
        wachthond($extdebug,3, 'part_vogontvangst',         $part_vogontvangst);
        wachthond($extdebug,3, 'part_vogdatum',             $part_vogdatum);
        wachthond($extdebug,3, 'part_vogkenmerk',           $part_vogkenmerk);

        wachthond($extdebug,3, 'cont_intnodig',             $cont_intnodig);
        wachthond($extdebug,3, 'cont_nawnodig',             $cont_nawnodig);
        wachthond($extdebug,3, 'cont_bionodig',             $cont_bionodig);
        wachthond($extdebug,3, 'cont_refnodig',             $cont_refnodig);
        wachthond($extdebug,3, 'cont_vognodig',             $cont_vognodig);

        wachthond($extdebug,3, 'cont_intstatus',            $cont_intstatus);
        wachthond($extdebug,3, 'cont_nawstatus',            $cont_nawstatus);
        wachthond($extdebug,3, 'cont_biostatus',            $cont_biostatus);
        wachthond($extdebug,3, 'cont_refstatus',            $cont_refstatus);
        wachthond($extdebug,3, 'cont_vogstatus',            $cont_vogstatus);

        wachthond($extdebug,3, 'cont_nawgecheckt',          $cont_nawgecheckt);
        wachthond($extdebug,3, 'cont_bioingevuld',          $cont_bioingevuld);
        wachthond($extdebug,3, 'cont_biogecheckt',          $cont_bioghecheckt);
        wachthond($extdebug,3, 'cont_reflaatste',           $cont_refdatum);
        wachthond($extdebug,3, 'cont_refnaam',              $cont_refnaam);
        wachthond($extdebug,3, 'cont_voglaatste',           $cont_voglaatste);
        wachthond($extdebug,3, 'cont_vogkenmerk',           $cont_vogkenmerk);

        if (in_array($groupID, $profilepartvog) AND $extint == 1) {

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 10.4 START RETREIVE VOG INFO FROM PARAMS", "[groupID: $groupID / op: $op]");
            wachthond($extdebug,1, "########################################################################");

            wachthond($extdebug,4, "entityid",    $entityID);
            wachthond($extdebug,4, "params",      $params);

            foreach($params as $i=>$item) {

              if ( !isset($indexed[$i][$item['id']]) ) {
                $indexed[$i]['key']         = $i;
                $indexed[$i]['entity_id']   = $item['entity_id']    ?? NULL;
                $indexed[$i]['column_name'] = $item['column_name']  ?? NULL;
                $indexed[$i]['table_name']  = $item['table_name']   ?? NULL;
                $indexed[$i]['value']       = $item['value']        ?? NULL;
              }
              if (!isset($key_partvogverzocht[$i]) AND $item['column_name'] == "datum_verzoek_599" ) {
                $all_part_vog_verzocht[] = $i;
              }
            }
            wachthond($extdebug,4, "indexed", $indexed);

            $key_part_vog_verzocht  = $all_part_vog_verzocht[0];

            if ($key_part_vog_verzocht >= 0) {

                  $pid_part_vog_verzocht  = $params[$key_part_vog_verzocht]['entity_id']  ?? NULL;
                  $raw_part_vog_verzocht  = $params[$key_part_vog_verzocht]['value']      ?? NULL;
                  $new_part_vog_verzocht  = strtotime($raw_part_vog_verzocht);
                  $fin_part_vog_verzocht  = date("Y-m-d H:i:s", $new_part_vog_verzocht);  

        //    wachthond($extdebug,4, "key_part_vog_verzocht", $key_part_vog_verzocht);
        //    wachthond($extdebug,4, "raw_part_vog_verzocht", $raw_part_vog_verzocht);
              wachthond($extdebug,1, "fin_part_vog_verzocht", $fin_part_vog_verzocht);
              wachthond($extdebug,1, "pid_part_vog_verzocht", $pid_part_vog_verzocht);
            }

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 10.4 EINDE RETREIVE VOG INFO FROM PARAMS", "[groupID: $groupID / op: $op]");
            wachthond($extdebug,1, "########################################################################");
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 10.5 BEPAAL GRENSNOGGOED REF & VOG VOOR HOOFDLEIDING & STAF");
        wachthond($extdebug,3, "########################################################################");

        wachthond($extdebug,3, 'displayname',                       $displayname);
        wachthond($extdebug,3, 'ditevent_leid_functie',             $ditevent_leid_functie);

        if (!Civi::cache()->get('cache_today_fiscalyear_start'))    {
            find_fiscalyear();
        }

        $grensvognoggoed1       = Civi::cache()->get('cache_grensvognoggoed1')          ?? NULL;
        $grensvognoggoed3       = Civi::cache()->get('cache_grensvognoggoed3')          ?? NULL;
        $grensrefnoggoed3       = Civi::cache()->get('cache_grensrefnoggoed3')          ?? NULL;
        wachthond($extdebug,3, 'grensvognoggoed1',          $grensvognoggoed1);
        wachthond($extdebug,3, 'grensvognoggoed3',          $grensvognoggoed3);
        wachthond($extdebug,3, 'grensrefnoggoed3',          $grensrefnoggoed3);

        if (in_array($ditevent_leid_functie, array('hoofdleiding', 'bestuurslid'))) {
            $grensrefnoggoed    = $grensvognoggoed1;
            $grensvognoggoed    = $grensvognoggoed1;
            $grensnoggoedjaar   = 1;
            wachthond($extdebug,2, "grensvognoggoed voor groepsleiding is $grensnoggoedjaar jaar",    $grensvognoggoed);
        } else {
            $grensrefnoggoed    = $grensrefnoggoed3;
            $grensvognoggoed    = $grensvognoggoed3;
            $grensnoggoedjaar   = 3;
            wachthond($extdebug,2, "grensvognoggoed voor groepsleiding is $grensnoggoedjaar jaar",    $grensvognoggoed);
        }

        wachthond($extdebug,3, 'grensvognoggoed',           $grensvognoggoed);
        wachthond($extdebug,3, 'grensnoggoedjaar',          $grensnoggoedjaar);

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 10.6 CHECK STATUS DITEVENT & DITJAAR MEE", "[groupID: $groupID]");
        wachthond($extdebug,1, "########################################################################");

        wachthond($extdebug,2, 'ditevent_event_type_id',    $ditevent_event_type_id);
        wachthond($extdebug,2, 'ditevent_leid_welkkamp',    $ditevent_leid_welkkamp);

        if ($ditevent_event_type_id == 1 AND $ditevent_leid_welkkamp) {
            $diteventleidyes        = 1;
        }

        $ditevent_infiscalyear_ditjaar  = infiscalyear($ditevent_event_start, $today_datetime, 'ditevent_event_start','ditjaar');

        if ($ditevent_event_type_id == 1 AND $ditevent_infiscalyear_ditjaar == 1) {
            $ditjaareventleidyes    = 1;
            $ditjaarleidyes         = 1;   
        }

        wachthond($extdebug,2, 'ditjaarleidyes',            $ditjaarleidyes);
        wachthond($extdebug,2, 'diteventleidyes',           $diteventleidyes);
        wachthond($extdebug,2, 'ditjaareventleidyes',       $ditjaareventleidyes);

        ##########################################################################################
        ### BEPAAL PARAMS UPDATE INT NODIG & STATUS
        ##########################################################################################

        if ($curcv_keer_leid >= 1) { $new_ditjaar_intnodig = "opnieuw"; } else { $new_ditjaar_intnodig = "eerstex"; } 

        $new_ditjaar_intstatus  = "gedeeltelijk";

    }

    if (empty($contact_id)) { // GA ALLEEN DOOR ALS CONTACT ID NIET LEEG IS (DEZE CHECK IS EERDER OOK AL GEDAAN)

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 10.X SKIPPED EXTENSION INTAKE (empty contact_id)", "[groupID: $groupID]");
        wachthond($extdebug,1, "########################################################################");
        return; //   if not, get out of here
    }

    wachthond($extdebug,3, 'extint',                $extint);
    wachthond($extdebug,3, 'groupID',               $groupID);
    wachthond($extdebug,3, 'profilecvmax',          $profilecvmax);
    wachthond($extdebug,3, 'profilepartleidmax',    $profilepartleidmax);
    wachthond($extdebug,3, 'diteventleidyes',       $diteventleidyes);
    wachthond($extdebug,3, 'diteventleidstf',       $diteventleidstf);
    wachthond($extdebug,3, 'ditjaareventleidyes',   $ditjaareventleidyes);

    wachthond($extdebug,3, 'extref',                $extref);

    if ($extint == 1 AND in_array($groupID, $profilepartleidmax)) { // PROFILE PARTICIPANT LEID MAX 

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 11.0 DELETE ACTIVITIES INDIEN NODIG VOOR $displayname",   "START");
        wachthond($extdebug,1, "########################################################################");

        ###########################################################################################
        ### 10. DELETE ACTIVITIES IF: 1. aangemaakt maar VOG nog goed 2. geen verzoek dit jaar 3. status niet completed 4. multiple
        ###########################################################################################

        if ($extvog == 1 AND (in_array($cont_intnodig, array("noggoed")) OR $ditjaarleidnot == 1) OR $ditevent_part_status_id == 4) {

            wachthond($extdebug,3, "refpersoon_activity_id",    $refpersoon_activity_id);
            wachthond($extdebug,3, "refverzoek_activity_id",    $refverzoek_activity_id);
            wachthond($extdebug,3, "vogverzoek_activity_id",    $vogverzoek_activity_id);
            wachthond($extdebug,3, "vogontvangst_activity_id",  $vogontvangst_activity_id);

            if ($refpersoon_activity_id   > 0 AND $refpersoon_activity_status   != 2) {
                intake_activity_delete($contact_id, $refpersoon_activity_id);
            }           
            if ($refverzoek_activity_id   > 0 AND $refverzoek_activity_status   != 2) {
                intake_activity_delete($contact_id, $refverzoek_activity_id);
            }           
            if ($vogverzoek_activity_id   > 0 AND $vogverzoek_activity_status   != 2) {
                intake_activity_delete($contact_id, $vogverzoek_activity_id);
            }
            if ($vogaanvraag_activity_id  > 0 AND $vogaanvraag_activity_status  != 2) {
                intake_activity_delete($contact_id, $vogaanvraag_activity_id);
            }
            if ($vogontvangst_activity_id > 0 AND $vogontvangst_activity_status != 2) {
                intake_activity_delete($contact_id, $vogontvangst_activity_id);
            }

            if ($ditevent_part_status_id == 4 AND $result_partditjaar_pos_count == 0) {
                intake_activitytype_delete($contact_id, 'VOG_verzoek',   $ditevent_fiscalyear_start, $ditevent_fiscalyear_einde);
            }
            if ($ditevent_part_status_id == 4 AND $result_partditjaar_pos_count == 0) {
                intake_activitytype_delete($contact_id, 'VOG_aanvraag',  $ditevent_fiscalyear_start, $ditevent_fiscalyear_einde);
            }
            if ($ditevent_part_status_id == 4 AND $result_partditjaar_pos_count == 0) {
                intake_activitytype_delete($contact_id, 'VOG_ontvangst', $ditevent_fiscalyear_start, $ditevent_fiscalyear_einde);
            }

        } else {

            wachthond($extdebug,3, "ditjaarleidnot",                $ditjaarleidnot);
            wachthond($extdebug,3, "ditevent_part_status_id",       $ditevent_part_status_id);
            wachthond($extdebug,3, "new_ditjaar_intnodig",          $new_ditjaar_intnodig);
            wachthond($extdebug,3, "result_partditjaar_pos_count",  $result_partditjaar_pos_count);

            if ($ditevent_part_status_id == 4 AND $result_partditjaar_pos_count == 0) {
                intake_activitytype_delete($contact_id, 'VOG_verzoek',  $ditevent_fiscalyear_start, $ditevent_fiscalyear_einde);
            }
            if ($ditevent_part_status_id == 4 AND $result_partditjaar_pos_count == 0) {
                intake_activitytype_delete($contact_id, 'VOG_aanvraag', $ditevent_fiscalyear_start, $ditevent_fiscalyear_einde);
            }
            if ($ditevent_part_status_id == 4 AND $result_partditjaar_pos_count == 0) {
                intake_activitytype_delete($contact_id, 'VOG_ontvangst',$ditevent_fiscalyear_start, $ditevent_fiscalyear_einde);
            }

        }
        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 11.0 DELETE ACTIVITIES INDIEN NODIG VOOR $displayname",   "EINDE");
        wachthond($extdebug,1, "########################################################################");

    } else {
        wachthond($extdebug,3, "groupID",           $groupID);
    }

    if ($extref == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) { // PROFILE PARTICIPANT LEID MAX

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 11.1 GET ACTIVITIES 'REF PERSOON' VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $activity_array = array(
            'activity_type_id'          => 139,
            'activity_type_naam'        => 'ref_persoon',   // type_id: 139
        );
        $activity_intake_array = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
        wachthond($extdebug,4, "activity_intake_array", $activity_intake_array);

        if ($activity_intake_array['activity_count'] == 1) {

            $refpersoon_activity_id             = $activity_intake_array['activity_id']             ?? NULL;
            $refpersoon_activity_status         = $activity_intake_array['activity_status']         ?? NULL;
            $refpersoon_activity_status_name    = $activity_intake_array['activity_status_name']    ?? NULL;
            $refpersoon_activity_datum          = $activity_intake_array['activity_datum']          ?? NULL;

            $refpersoon_activity_kampkort       = $activity_intake_array['activity_kampkort']       ?? NULL;
            $refpersoon_activity_kampfunctie    = $activity_intake_array['activity_kampfunctie']    ?? NULL;
            $refpersoon_activity_kampstart      = $activity_intake_array['activity_kampstart']      ?? NULL;
            $refpersoon_activity_kampjaar       = $activity_intake_array['activity_kampjaar']       ?? NULL;

            $refpersoon_activity_aanvrager      = $activity_intake_array['referentie_aanvrager']    ?? NULL;
            $refpersoon_activity_relid          = $activity_intake_array['referentie_relid']        ?? NULL;
            $refpersoon_activity_refid          = $activity_intake_array['referentie_refid']        ?? NULL;  
            $refpersoon_activity_referentie     = $activity_intake_array['referentie_naam']         ?? NULL;

            wachthond($extdebug,3, 'refpersoon_activity_id',                    $refpersoon_activity_id);
            wachthond($extdebug,3, 'refpersoon_activity_status',                $refpersoon_activity_status);
            wachthond($extdebug,3, 'refpersoon_activity_status_name',           $refpersoon_activity_status_name);
            wachthond($extdebug,3, 'refpersoon_activity_datum',                 $refpersoon_activity_datum);

            wachthond($extdebug,3, 'refpersoon_activity_kampkort',              $refpersoon_activity_kampkort);
            wachthond($extdebug,3, 'refpersoon_activity_kampfunctie',           $refpersoon_activity_kampfunctie);
            wachthond($extdebug,3, 'refpersoon_activity_kampstart',             $refpersoon_activity_kampstart);
            wachthond($extdebug,3, 'refpersoon_activity_kampjaar',              $refpersoon_activity_kampjaar);

            wachthond($extdebug,3, 'refpersoon_activity_aanvrager',             $refpersoon_activity_aanvrager);
            wachthond($extdebug,3, 'refpersoon_activity_referentie',            $refpersoon_activity_referentie);
            wachthond($extdebug,3, 'refpersoon_activity_relid',                 $refpersoon_activity_relid);
            wachthond($extdebug,3, 'refpersoon_activity_refid',                 $refpersoon_activity_refid);
          
        } else {
            wachthond($extdebug,3, "refpersoon_activity_id\tNO ACTIVITY FOUND");
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 11.2 GET ACTIVITIES 'REF VERZOEK' VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $activity_array = array(
            'activity_type_id'          => 117,
            'activity_type_naam'        => 'ref_verzoek',   // type_id: 117
        );
        $activity_intake_array = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
        wachthond($extdebug,4, "activity_intake_array", $activity_intake_array);

        if ($activity_intake_array['activity_count'] == 1) {

            $refverzoek_activity_id             = $activity_intake_array['activity_id']             ?? NULL;
            $refverzoek_activity_status         = $activity_intake_array['activity_status']         ?? NULL;
            $refverzoek_activity_status_name    = $activity_intake_array['activity_status_name']    ?? NULL;
            $refverzoek_activity_datum          = $activity_intake_array['activity_datum']          ?? NULL;

            $refverzoek_activity_kampkort       = $activity_intake_array['activity_kampkort']       ?? NULL;
            $refverzoek_activity_kampfunctie    = $activity_intake_array['activity_kampfunctie']    ?? NULL;
            $refverzoek_activity_kampstart      = $activity_intake_array['activity_kampstart']      ?? NULL;
            $refverzoek_activity_kampjaar       = $activity_intake_array['activity_kampjaar']       ?? NULL;

            $refverzoek_activity_aanvrager      = $activity_intake_array['referentie_aanvrager']    ?? NULL;
            $refverzoek_activity_relid          = $activity_intake_array['referentie_relid']        ?? NULL;
            $refverzoek_activity_refid          = $activity_intake_array['referentie_refid']        ?? NULL;  
            $refverzoek_activity_referentie     = $activity_intake_array['referentie_naam']         ?? NULL;

            wachthond($extdebug,3, 'refverzoek_activity_id',                    $refverzoek_activity_id);
            wachthond($extdebug,3, 'refverzoek_activity_status',                $refverzoek_activity_status);
            wachthond($extdebug,3, 'refverzoek_activity_status_name',           $refverzoek_activity_status_name);
            wachthond($extdebug,3, 'refverzoek_activity_datum',                 $refverzoek_activity_datum);

            wachthond($extdebug,3, 'refverzoek_activity_kampkort',              $refverzoek_activity_kampkort);
            wachthond($extdebug,3, 'refverzoek_activity_kampfunctie',           $refverzoek_activity_kampfunctie);
            wachthond($extdebug,3, 'refverzoek_activity_kampstart',             $refverzoek_activity_kampstart);
            wachthond($extdebug,3, 'refverzoek_activity_kampjaar',              $refverzoek_activity_kampjaar);

            wachthond($extdebug,3, 'refverzoek_activity_aanvrager',             $refverzoek_activity_aanvrager);
            wachthond($extdebug,3, 'refverzoek_activity_referentie',            $refverzoek_activity_referentie);
            wachthond($extdebug,3, 'refverzoek_activity_relid',                 $refverzoek_activity_relid);
            wachthond($extdebug,3, 'refverzoek_activity_refid',                 $refverzoek_activity_refid);
          
        } else {
            wachthond($extdebug,3, "refverzoek_activity_id\tNO ACTIVITY FOUND");
        }

    }

    if ($extvog == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) { // PROFILE PARTICIPANT LEID MAX

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 11.3 GET ACTIVITIES 'VOG VERZOEK' VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $activity_array = array(
            'activity_type_id'          => 118,
            'activity_type_naam'        => 'vog_verzoek',  // type_id: 118            
        );
        $activity_intake_array = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
        wachthond($extdebug,4, "activity_intake_array", $activity_intake_array);

        if ($activity_intake_array['activity_count'] == 1) {

            $vogverzoek_activity_id                 = $activity_intake_array['activity_id']             ?? NULL;
            $vogverzoek_activity_status             = $activity_intake_array['activity_status']         ?? NULL;
            $vogverzoek_activity_status_name        = $activity_intake_array['activity_status_name']    ?? NULL;
            $vogverzoek_activity_datum              = $activity_intake_array['activity_datum']          ?? NULL;

            $vogverzoek_activity_kampkort           = $activity_intake_array['activity_kampkort']       ?? NULL;
            $vogverzoek_activity_kampfunctie        = $activity_intake_array['activity_kampfunctie']    ?? NULL;
            $vogverzoek_activity_kampstart          = $activity_intake_array['activity_kampstart']      ?? NULL;
            $vogverzoek_activity_kampjaar           = $activity_intake_array['activity_kampjaar']       ?? NULL;

            $vogverzoek_activity_vog_nodig          = $activity_intake_array['vog_nodig']               ?? NULL;
            $vogverzoek_activity_datum_verzoek      = $activity_intake_array['vog_datum_verzoek']       ?? NULL;
            $vogverzoek_activity_datum_aanvraag     = $activity_intake_array['vog_datum_aanvraag']      ?? NULL;  
            $vogverzoek_activity_datum_ontvangst    = $activity_intake_array['vog_datum_ontvangst']     ?? NULL;  

            wachthond($extdebug,3, 'vogverzoek_activity_id',                    $vogverzoek_activity_id);
            wachthond($extdebug,3, 'vogverzoek_activity_status',                $vogverzoek_activity_status);
            wachthond($extdebug,3, 'vogverzoek_activity_status_name',           $vogverzoek_activity_status_name);
            wachthond($extdebug,3, 'vogverzoek_activity_datum',                 $vogverzoek_activity_datum);

            wachthond($extdebug,3, 'vogverzoek_activity_kampkort',              $vogverzoek_activity_kampkort);
            wachthond($extdebug,3, 'vogverzoek_activity_kampfunctie',           $vogverzoek_activity_kampfunctie);
            wachthond($extdebug,3, 'vogverzoek_activity_kampstart',             $vogverzoek_activity_kampstart);
            wachthond($extdebug,3, 'vogverzoek_activity_kampjaar',              $vogverzoek_activity_kampjaar);

            wachthond($extdebug,3, 'vogverzoek_activity_vog_nodig',             $vogverzoek_activity_vog_nodig);
            wachthond($extdebug,3, 'vogverzoek_activity_vog_datum_verzoek',     $vogverzoek_activity_vog_datum_verzoek);
            wachthond($extdebug,3, 'vogverzoek_activity_vog_datum_aanvraag',    $vogverzoek_activity_vog_datum_aanvraag);
            wachthond($extdebug,3, 'vogverzoek_activity_vog_datum_ontvangst',   $vogverzoek_activity_vog_datum_ontvangst);
          
        } else {
            wachthond($extdebug,3, "vogverzoek_activity_id\tNO ACTIVITY FOUND");
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 11.4 GET ACTIVITIES 'VOG AANVRAAG' VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $activity_array = array(
            'activity_type_id'          => 119,
            'activity_type_naam'        => 'vog_aanvraag',  // type_id: 118            
        );
        $activity_intake_array = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
        wachthond($extdebug,4, "activity_intake_array", $activity_intake_array);

        if ($activity_intake_array['activity_count'] == 1) {

            $vogaanvraag_activity_id                = $activity_intake_array['activity_id']             ?? NULL;
            $vogaanvraag_activity_status            = $activity_intake_array['activity_status']         ?? NULL;
            $vogaanvraag_activity_status_name       = $activity_intake_array['activity_status_name']    ?? NULL;
            $vogaanvraag_activity_datum             = $activity_intake_array['activity_datum']          ?? NULL;

            $vogaanvraag_activity_kampkort          = $activity_intake_array['activity_kampkort']       ?? NULL;
            $vogaanvraag_activity_kampfunctie       = $activity_intake_array['activity_kampfunctie']    ?? NULL;
            $vogaanvraag_activity_kampstart         = $activity_intake_array['activity_kampstart']      ?? NULL;
            $vogaanvraag_activity_kampjaar          = $activity_intake_array['activity_kampjaar']       ?? NULL;

            $vogaanvraag_activity_vog_nodig         = $activity_intake_array['vog_nodig']               ?? NULL;
            $vogaanvraag_activity_datum_aanvraag    = $activity_intake_array['vog_datum_aanvraag']      ?? NULL;
            $vogaanvraag_activity_datum_aanvraag    = $activity_intake_array['vog_datum_aanvraag']      ?? NULL;  
            $vogaanvraag_activity_datum_ontvangst   = $activity_intake_array['vog_datum_ontvangst']     ?? NULL;  

            wachthond($extdebug,3, 'vogaanvraag_activity_id',                   $vogaanvraag_activity_id);
            wachthond($extdebug,3, 'vogaanvraag_activity_status',               $vogaanvraag_activity_status);
            wachthond($extdebug,3, 'vogaanvraag_activity_status_name',          $vogaanvraag_activity_status_name);
            wachthond($extdebug,3, 'vogaanvraag_activity_datum',                $vogaanvraag_activity_datum);

            wachthond($extdebug,3, 'vogaanvraag_activity_kampkort',             $vogaanvraag_activity_kampkort);
            wachthond($extdebug,3, 'vogaanvraag_activity_kampfunctie',          $vogaanvraag_activity_kampfunctie);
            wachthond($extdebug,3, 'vogaanvraag_activity_kampstart',            $vogaanvraag_activity_kampstart);
            wachthond($extdebug,3, 'vogaanvraag_activity_kampjaar',             $vogaanvraag_activity_kampjaar);

            wachthond($extdebug,3, 'vogaanvraag_activity_vog_nodig',            $vogaanvraag_activity_vog_nodig);
            wachthond($extdebug,3, 'vogaanvraag_activity_vog_datum_aanvraag',   $vogaanvraag_activity_vog_datum_aanvraag);
            wachthond($extdebug,3, 'vogaanvraag_activity_vog_datum_aanvraag',   $vogaanvraag_activity_vog_datum_aanvraag);
            wachthond($extdebug,3, 'vogaanvraag_activity_vog_datum_ontvangst',  $vogaanvraag_activity_vog_datum_ontvangst);
          
        } else {
            wachthond($extdebug,3, "vogaanvraag_activity_id\tNO ACTIVITY FOUND");
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 11.5 GET ACTIVITIES 'VOG ONTVANGST' VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $activity_array = array(
            'activity_type_id'          => 120,
            'activity_type_naam'        => 'vog_ontvangst',  // type_id: 120            
        );
        $activity_intake_array = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
        wachthond($extdebug,4, "activity_intake_array",     $activity_intake_array);

        if ($activity_intake_array['activity_count'] == 1) {

            $vogontvangst_activity_id               = $activity_intake_array['activity_id']             ?? NULL;
            $vogontvangst_activity_status           = $activity_intake_array['activity_status']         ?? NULL;
            $vogontvangst_activity_status_name      = $activity_intake_array['activity_status_name']    ?? NULL;
            $vogontvangst_activity_datum            = $activity_intake_array['activity_datum']          ?? NULL;

            $vogontvangst_activity_kampkort         = $activity_intake_array['activity_kampkort']       ?? NULL;
            $vogontvangst_activity_kampfunctie      = $activity_intake_array['activity_kampfunctie']    ?? NULL;
            $vogontvangst_activity_kampstart        = $activity_intake_array['activity_kampstart']      ?? NULL;
            $vogontvangst_activity_kampjaar         = $activity_intake_array['activity_kampjaar']       ?? NULL;

            $vogontvangst_activity_vog_nodig        = $activity_intake_array['vog_nodig']               ?? NULL;
            $vogontvangst_activity_datum_ontvangst  = $activity_intake_array['vog_datum_ontvangst']     ?? NULL;
            $vogontvangst_activity_datum_ontvangst  = $activity_intake_array['vog_datum_ontvangst']     ?? NULL;  
            $vogontvangst_activity_datum_ontvangst  = $activity_intake_array['vog_datum_ontvangst']     ?? NULL;  

            wachthond($extdebug,3, 'vogontvangst_activity_id',                      $vogontvangst_activity_id);
            wachthond($extdebug,3, 'vogontvangst_activity_status',                  $vogontvangst_activity_status);
            wachthond($extdebug,3, 'vogontvangst_activity_status_name',             $vogontvangst_activity_status_name);
            wachthond($extdebug,3, 'vogontvangst_activity_datum',                   $vogontvangst_activity_datum);

            wachthond($extdebug,3, 'vogontvangst_activity_kampkort',                $vogontvangst_activity_kampkort);
            wachthond($extdebug,3, 'vogontvangst_activity_kampfunctie',             $vogontvangst_activity_kampfunctie);
            wachthond($extdebug,3, 'vogontvangst_activity_kampstart',               $vogontvangst_activity_kampstart);
            wachthond($extdebug,3, 'vogontvangst_activity_kampjaar',                $vogontvangst_activity_kampjaar);

            wachthond($extdebug,3, 'vogontvangst_activity_vog_nodig',               $vogontvangst_activity_vog_nodig);
            wachthond($extdebug,3, 'vogontvangst_activity_vog_datum_ontvangst',     $vogontvangst_activity_vog_datum_ontvangst);
            wachthond($extdebug,3, 'vogontvangst_activity_vog_datum_ontvangst',     $vogontvangst_activity_vog_datum_ontvangst);
            wachthond($extdebug,3, 'vogontvangst_activity_vog_datum_ontvangst',     $vogontvangst_activity_vog_datum_ontvangst);
          
        } else {
            wachthond($extdebug,3, "vogontvangst_activity_id\tNO ACTIVITY FOUND");
        }        

    }

    // M61: TODO & TO CHECK: NU TIJDELIJK ALLEEN INTAKE DEEL ALS DIE HET EVENT IS VAN DIT HUIDIGE JAAR
    if ($extint == 1 AND in_array($groupID, $profilecvmax) AND ($diteventleidyes == 1 OR $diteventleidstf == 1)) {

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 12.1 BEPAAL WAARDEN 'NODIG' VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        ###########################################################################################
        ### BASIS WAARDEN INTAKE NODIG
        ###########################################################################################

        $cont_intnodig                      = $array_contditjaar['cont_intnodig']                   ?? NULL;
        $cont_refnodig                      = $array_contditjaar['cont_refnodig']                   ?? NULL;
        $cont_vognodig                      = $array_contditjaar['cont_vognodig']                   ?? NULL;

        $part_intnodig                      = $array_partditevent['part_intnodig']                  ?? NULL;
        $part_refnodig                      = $array_partditevent['part_refnodig']                  ?? NULL;
        $part_vognodig                      = $array_partditevent['part_vognodig']                  ?? NULL;

        ###########################################################################################
        ### A. BEPAAL NAW NODIG > Overrule naw nodig naar jaarlijkse check voor iedereen
        ###########################################################################################

        $new_ditjaar_nawnodig = 'elkjaar';
        $new_ditpart_nawnodig = 'elkjaar';

        ###########################################################################################
        ### B. BEPAAL NAW NODIG > Overrule naw nodig naar jaarlijkse check voor iedereen
        ###########################################################################################

        $new_ditjaar_bionodig = 'elkjaar';
        $new_ditpart_bionodig = 'elkjaar';

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 12.2 ZET INITIEEL BESTAANDE WAARDE VAN INTNODIG in CONT & PART");
        wachthond($extdebug,2, "########################################################################");

        ### CONT  X
        ### PART  V

        if (empty($cont_intnodig) AND !empty($part_intnodig)) {
            $new_ditpart_intnodig = $part_intnodig;
            wachthond($extdebug,3, "A1 cont_intnodig: X",   $cont_intnodig);
            wachthond($extdebug,3, "A1 part_intnodig: V",   $part_intnodig);
        }
        if (empty($cont_refnodig) AND !empty($part_refnodig)) {
            $new_ditpart_refnodig = $part_refnodig;
            wachthond($extdebug,3, "A2 cont_refnodig: X",   $cont_refnodig);
            wachthond($extdebug,3, "A2 part_refnodig: V",   $part_refnodig);
        }
        if (empty($cont_vognodig) AND !empty($part_vognodig)) {
            $new_ditpart_vognodig = $part_vognodig;
            wachthond($extdebug,3, "A3 cont_vognodig: X",   $cont_vognodig);
            wachthond($extdebug,3, "A3 part_vognodig: V",   $part_vognodig);
        }

        ### CONT  V
        ### PART  X

        if (!empty($cont_intnodig) AND empty($part_intnodig)) {
            $new_ditjaar_intnodig = $cont_intnodig;
            wachthond($extdebug,3, "B1 cont_intnodig: V",   $cont_intnodig);
            wachthond($extdebug,3, "B1 part_intnodig: X",   $part_intnodig);
        }
        if (!empty($cont_refnodig) AND empty($part_refnodig)) {
            $new_ditjaar_refnodig = $cont_refnodig;
            wachthond($extdebug,3, "B2 cont_refnodig: V",   $cont_refnodig);
            wachthond($extdebug,3, "B2 part_refnodig: X",   $part_refnodig);
        }
        if (!empty($cont_vognodig) AND empty($part_vognodig)) {
            $new_ditjaar_vognodig = $cont_vognodig;
            wachthond($extdebug,3, "B3 cont_vognodig: V",   $cont_vognodig);
            wachthond($extdebug,3, "B3 part_vognodig: X",   $part_vognodig);
        }

        ### CONT  V
        ### PART  V

        if (!empty($cont_intnodig) AND $cont_intnodig == $part_intnodig) {
            $new_ditpart_intnodig = $part_intnodig;
            wachthond($extdebug,3, "C1 cont_intnodig: V",   $cont_intnodig);
            wachthond($extdebug,3, "C1 part_intnodig: V",   $part_intnodig);
        }
        if (!empty($cont_refnodig) AND $cont_refnodig == $part_refnodig) {
            $new_ditpart_refnodig = $part_refnodig;
            wachthond($extdebug,3, "C2 cont_refnodig: V",   $cont_refnodig);
            wachthond($extdebug,3, "C2 part_refnodig: V",   $part_refnodig);
        }
        if (!empty($cont_vognodig) AND $cont_vognodig == $part_vognodig) {
            $new_ditpart_vognodig = $part_vognodig;
            wachthond($extdebug,3, "C3 cont_vognodig: V",   $cont_vognodig);
            wachthond($extdebug,3, "C3 part_vognodig: V",   $part_vognodig);
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 12.3 BEPAAL WAARDE VOGNODIG VOOR $displayname", "[$ditevent_leid_functie $ditevent_event_kampkort]");
        wachthond($extdebug,3, "########################################################################");

        $new_ditjaar_vognodig   = NULL;
        $new_ditpart_vognodig   = NULL;

        wachthond($extdebug,3, 'cont_voglaatste',           $cont_voglaatste);
        wachthond($extdebug,3, 'grensvognoggoed',           $grensvognoggoed);

        if ($cont_voglaatste) {
            $vogrecent_infiscalyear_ditjaar  = infiscalyear($cont_voglaatste, $today_datetime,      'vogrecent','ditjaar');
            $vogrecent_infiscalyear_ditevent = infiscalyear($cont_voglaatste, $ditevent_event_start,'vogrecent','ditevent');
            wachthond($extdebug,3, "vogrecent_infiscalyear_ditjaar",  "$vogrecent_infiscalyear_ditjaar\t[vogrecent: $cont_voglaatste]");
            wachthond($extdebug,3, "vogrecent_infiscalyear_ditevent", "$vogrecent_infiscalyear_ditevent\t[vogrecent: $cont_voglaatste]");       

            $vogrecent_binnengrens = date_biggerequal($cont_voglaatste, $grensvognoggoed, 'vogrecent', 'grensvog');
            $vogrecent_buitengrens = date_biggerequal($grensvognoggoed, $cont_voglaatste, 'grensvog',  'vogrecent');
            wachthond($extdebug,3, "vogrecent_binnengrens",       "$vogrecent_binnengrens\t[vogrecent: $cont_voglaatste]");
            wachthond($extdebug,3, "vogrecent_buitengrens",       "$vogrecent_buitengrens\t[vogrecent: $cont_voglaatste]");
        }

        if ($part_vogdatum) {
            $part_vogdatum_infiscalyear_ditjaar  = infiscalyear($part_vogdatum, $today_datetime,      'part_vogdatum','ditjaar');
            $part_vogdatum_infiscalyear_ditevent = infiscalyear($part_vogdatum, $ditevent_event_start,'part_vogdatum','ditevent');
            wachthond($extdebug,3, "part_vogdatum_infiscalyear_ditjaar", "$part_vogdatum_infiscalyear_ditjaar\t[part_vogdatum: $part_vogdatum]");
            wachthond($extdebug,3, "part_vogdatum_infiscalyear_ditevent","$part_vogdatum_infiscalyear_ditevent\t[part_vogdatum: $part_vogdatum]");
        }

        // VOGRECENT NIET IN DIT JAAR, WEL BINNEN GRENSNOGGOED
        if ($vogrecent_binnengrens == 1 AND $vogrecent_infiscalyear_ditjaar != 1) {
            $new_ditjaar_vognodig   = 'noggoed';
        }
        // VOGRECENT VALT BUITEN GRENS NOGGOED
        if ($vogrecent_buitengrens == 1) {
            $new_ditjaar_vognodig   = 'opnieuw';
        }
        // ALS ER GEEN VOG RECENT DATUM IS DAN IS DEZE DUS NODIG
        if (empty($cont_voglaatste)) {
            $new_ditjaar_vognodig   = 'eerstex';            
        }
        // HOOFDLEIDING & BESTUUR ELK JAAR
        if (in_array($ditevent_leid_functie, array('hoofdleiding', 'bestuurslid'))) {
            $new_ditjaar_vognodig   = 'elkjaar';
        }

        $aclgroup_bestuur       = 455;  // M61: hardcoded id of (manual) ACL group ditjaar_bestuur
        $group_bestuur          = acl_group_get($contact_id, $aclgroup_bestuur, 'bestuur');
        $group_bestuur_member   = $group_bestuur['group_member'];

        if ($group_bestuur_member == 1) {
            $new_ditjaar_vognodig   = 'elkjaar';
        }

        // INDIEN DITEVENT = DITJAAR PLAATS DAN VOG NODIG IN PART
        if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {
            $new_ditpart_vognodig   = $new_ditjaar_vognodig;
        }

        wachthond($extdebug,2, "new_ditjaar_vognodig",    $new_ditjaar_vognodig);
        wachthond($extdebug,2, "new_ditpart_vognodig",    $new_ditpart_vognodig);

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 12.4 CORRIGEER WAARDEN INT/REF/VOGNODIG VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        ###########################################################################################
        # PAS REFNODIG NOG AAN IN SOMMIGE GEVALLEN N.A.V VOGNODIG
        ###########################################################################################

        // M61 trek refnodig gelijk met vognodig voor leiding vaker dan 9 (totdat alles weer gelijk is)
        if (empty($refrecent)   AND in_array($new_ditjaar_vognodig, array("noggoed")) AND $curcv_keer_leid >= 5) {
            $new_ditjaar_refnodig     = 'noggoed';
        }
        // M61 trek refnodig gelijk met vognodig voor leiding vaker dan 2
        if ($refrecent      AND in_array($new_ditjaar_vognodig, array("noggoed")) AND $curcv_keer_leid > 2) {
            $new_ditjaar_refnodig     = 'noggoed';
        }

        ###########################################################################################
        # BEPAAL DE WAARDE VAN INTAKE NODIG
        ###########################################################################################

        ### STATUS EERSTE KEER
        if ($new_ditjaar_vognodig == 'eerstex') {   // M61: TREK INTNODIG GELIJK MET VOGNODIG
            $new_ditjaar_intnodig  = 'eerstex';
            $new_ditjaar_refnodig  = 'eerstex';
            wachthond($extdebug,1, "INDIEN VOGNODIG eerstex dan ook intnodig en refnodig", $new_ditjaar_intnodig);
        }

        ### STATUS NOG GOED
        if ($new_ditjaar_vognodig == 'noggoed') {   // M61: TREK INTNODIG GELIJK MET VOGNODIG
            $new_ditjaar_intnodig  = 'noggoed';
            wachthond($extdebug,1, "INDIEN VOGNODIG noggoed dan ook intnodig", $new_ditjaar_intnodig);
        }

        ### STATUS OPNIEUW
        if ($new_ditjaar_vognodig == 'opnieuw') {   // M61: TREK INTNODIG GELIJK MET VOGNODIG
            $new_ditjaar_intnodig  = 'opnieuw';
            wachthond($extdebug,1, "INDIEN VOGNODIG opnieuw dan ook intnodig", $new_ditjaar_intnodig);
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 12.5 FORCEER INTNODIG & VOGNODIG IN SOMMIGE GEVALLEN $displayname", "[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        wachthond($extdebug,3, "ditevent_leid_functie", $ditevent_leid_functie);

        ### INDIEN HOOFDLEIDING OF STAF
        if (in_array($ditevent_leid_functie, array('hoofdleiding', 'bestuurslid'))) {
            $new_ditjaar_intnodig  = 'elkjaar';
            $new_ditjaar_refnodig  = 'elkjaar';
            $new_ditjaar_vognodig  = 'elkjaar';
            $new_ditpart_vognodig  = 'elkjaar';
            wachthond($extdebug,1, "INDIEN hoofdleiding of staf intnodig en vognodig elkjaar",       "$new_ditjaar_intnodig ($ditevent_leid_functie)");
        }

        ### STATUS INHAAL
        if (in_array($part_refnodig, array("inhaal")) AND !in_array($ditevent_part_functie, array('hoofdleiding', 'bestuurslid'))) {
            $new_ditjaar_intnodig   = 'inhaal';
            wachthond($extdebug,1, "INDIEN hoofdleiding en refnodig = inhaal dan intnodig = inhaal", "$new_ditjaar_intnodig ($ditevent_leid_functie)");
        }           

        ###########################################################################################
        // INDIEN DITEVENT & TEVENS PARTEVENT: TREK CONT NODIG EN PART NODIG GELIJK
        ###########################################################################################

        if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {
            $new_ditpart_intnodig = $new_ditjaar_intnodig;
            $new_ditpart_refnodig = $new_ditjaar_refnodig;
            $new_ditpart_vognodig = $new_ditjaar_vognodig;
        }

        ##########################################################################################
        if ($extnaw == 1 AND in_array($groupID, $profilecvmax)) {           // PROFILE ALLES + VOG
        ##########################################################################################

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 13.1 BEPAAL DE STATUS NAW $displayname [$ditevent_leid_functie $ditevent_event_kampkort]", "[groupID: $groupID]");
            wachthond($extdebug,3, "########################################################################");

            $new_ditjaar_nawnodig = 'elkjaar';
            $new_ditpart_nawnodig = 'elkjaar';

            $org_ditjaar_nawgecheckt = $cont_nawgecheckt;
            $org_ditpart_nawgecheckt = $part_nawgecheckt;

            if ($cont_nawgecheckt)  { $new_ditjaar_nawgecheckt = $cont_nawgecheckt; }
            if ($part_nawgecheckt)  { $new_ditpart_nawgecheckt = $part_nawgecheckt; }

            wachthond($extdebug,3, 'org_ditjaar_nawgecheckt',   $org_ditjaar_nawgecheckt);
            wachthond($extdebug,3, 'org_ditpart_nawgecheckt',   $org_ditpart_nawgecheckt);

            $cont_nawgecheckt_infiscalyear_ditjaar   = infiscalyear($org_ditjaar_nawgecheckt,$today_datetime,      'nawgecheckt','ditjaar');
            $cont_nawgecheckt_infiscalyear_ditevent  = infiscalyear($org_ditjaar_nawgecheckt,$ditevent_event_start,'nawgecheckt','ditevent');
            wachthond($extdebug,2, 'nawgecheckt_infiscalyear_ditjaar',      $cont_nawgecheckt_infiscalyear_ditjaar);
            wachthond($extdebug,2, 'nawgecheckt_infiscalyear_ditevent',     $cont_nawgecheckt_infiscalyear_ditevent);

            ##########################################################################################
            // BEPAAL NIEUWE WAARDEN NAWGECHECKT
            ##########################################################################################

            if ($cont_nawgecheckt_infiscalyear_ditevent == 1) {

                // ALS PART_NAWGECHECKT BESTAAT MAAR CONT NAWGECHECKT NIEUWER IS    (BINNEN FISCALYEAR VAN DIT EVENT)
                if (date_bigger($cont_nawgecheckt, $part_nawgecheckt) == 1) {
                    $new_ditpart_nawgecheckt = $cont_nawgecheckt;
                    wachthond($extdebug,3, "cont_nawgecheckt [$cont_nawgecheckt] > part_nawgecheckt $part_nawgecheckt", "[cont_nawgecheckt was nieuwer]");
                }
                // ALS PART_NAWGECHECKT BESTAAT EN NIEUWER IS DAN CONT NAWGECHECKT  (BINNEN FISCALYEAR VAN DIT EVENT)
                if (date_bigger($part_nawgecheckt, $cont_nawgecheckt) == 1) {
                    $new_ditjaar_nawgecheckt = $part_nawgecheckt;
                    wachthond($extdebug,3, "part_nawgecheckt [$part_nawgecheckt] > cont_nawgecheckt $cont_nawgecheckt", "[part_nawgecheckt was nieuwer]");
                }
                // ALS PART_NAWGECHECKT LEEG IS EN CONT NAWGECHECKT BESTAAT         (BINNEN FISCALYEAR VAN DIT EVENT)
                if (empty($part_nawgecheckt)) {
                    $new_ditpart_nawgecheckt = $cont_nawgecheckt;
                    wachthond($extdebug,3, "cont_nawgecheckt [$cont_nawgecheckt] > part_nawgecheckt $part_nawgecheckt", "[part_nawgecheckt was leeg]");
                }
            }

            ##########################################################################################
            ### BEPAAL NIEUWE STATUS NAW
            ##########################################################################################

            if ($cont_nawgecheckt_infiscalyear_ditjaar == 1) {
                $new_ditjaar_nawstatus  = 'bijgewerkt';
                wachthond($extdebug,1,  "CONT_NAWGECHECKT [$new_ditjaar_nawgecheckt] IN FISCAL JAAR DIT JAAR",  "> CONT_NAWSTATUS: [$new_ditjaar_nawstatus]");
            } else {
                $new_ditjaar_nawstatus  = 'ongecheckt';
            }

            if ($cont_nawgecheckt_infiscalyear_ditevent == 1) {
                $new_ditpart_nawstatus  = 'bijgewerkt';
                wachthond($extdebug,1,  "CONT_NAWGECHECKT [$new_ditjaar_nawgecheckt] IN FISCAL JAAR VAN EVENT", "> PART_NAWSTATUS: [$new_ditpart_nawstatus]");
            } else {
                $new_ditpart_nawstatus = 'ongecheckt';
            }

            wachthond($extdebug,3, 'new_ditjaar_nawnodig',      $new_ditjaar_nawnodig);
            wachthond($extdebug,3, 'new_ditjaar_nawgecheckt',   $new_ditjaar_nawgecheckt);
            wachthond($extdebug,3, 'new_ditjaar_nawstatus',     $new_ditjaar_nawstatus);

            wachthond($extdebug,3, 'new_ditpart_nawnodig',      $new_ditpart_nawnodig);
            wachthond($extdebug,3, 'new_ditpart_nawgecheckt',   $new_ditpart_nawgecheckt);
            wachthond($extdebug,3, 'new_ditpart_nawstatus',     $new_ditpart_nawstatus);

        }

        ##########################################################################################
        if ($extbio == 1 AND in_array($groupID, $profilecvmax)) {       // PROFILE ALLES + VOG
        ##########################################################################################

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 13.2 BEPAAL DE STATUS BIO $displayname [$ditevent_leid_functie $ditevent_event_kampkort]", "[groupID: $groupID]");
            wachthond($extdebug,3, "########################################################################");

            $new_ditjaar_bionodig = 'elkjaar';
            $new_ditpart_bionodig = 'elkjaar';

            $org_ditjaar_bioingevuld = $cont_bioingevuld;
            $org_ditjaar_biogecheckt = $cont_biogecheckt;
            $org_ditpart_biogecheckt = $part_biogecheckt;

            if ($cont_biogecheckt)  { $new_ditjaar_biogecheckt = $cont_biogecheckt; }
            if ($part_biogecheckt)  { $new_ditpart_biogecheckt = $part_biogecheckt; }

            wachthond($extdebug,3, 'org_ditjaar_biogecheckt',   $org_ditjaar_biogecheckt);
            wachthond($extdebug,3, 'org_ditpart_biogecheckt',   $org_ditpart_biogecheckt);

            ##########################################################################################
            // UPDATE BIO INGEVULD INDIEN LEEG EN BIOGECHECKT WEL INGEVULD IS
            ##########################################################################################
            if ($org_ditjaar_biogecheckt AND empty($org_ditjaar_bioingevuld)) {
                $new_ditjaar_bioingevuld = $new_ditjaar_biogecheckt;
                wachthond($extdebug,3, "bio_ingevuld = leeg en bio_gecheckt = ($new_ditjaar_biogecheckt)", "Update bio_ingevuld");
            }

            $cont_biogecheckt_infiscalyear_ditjaar   = infiscalyear($org_ditjaar_biogecheckt,$today_datetime,      'biogecheckt','ditjaar');
            $cont_biogecheckt_infiscalyear_ditevent  = infiscalyear($org_ditjaar_biogecheckt,$ditevent_event_start,'biogecheckt','ditevent');
            wachthond($extdebug,2, 'biogecheckt_infiscalyear_ditjaar',      $cont_biogecheckt_infiscalyear_ditjaar);
            wachthond($extdebug,2, 'biogecheckt_infiscalyear_ditevent',     $cont_biogecheckt_infiscalyear_ditevent);

            ##########################################################################################
            // BEPAAL NIEUWE WAARDEN BIOGECHECKT
            ##########################################################################################

            if ($cont_biogecheckt_infiscalyear_ditevent == 1) {

                $new_ditjaar_biogecheckt = $cont_biogecheckt;

                // ALS PART_BIOGECHECKT BESTAAT MAAR CONT BIOGECHECKT NIEUWER IS    (BINNEN FISCALYEAR VAN DIT EVENT)
                if (date_bigger($cont_biogecheckt, $part_biogecheckt) == 1) {
                    $new_ditpart_biogecheckt = $cont_biogecheckt;
                    wachthond($extdebug,3, "cont_biogecheckt [$cont_biogecheckt] > part_biogecheckt $part_biogecheckt", "[cont_biogecheckt was nieuwer]");
                }
                // ALS PART_BIOGECHECKT BESTAAT EN NIEUWER IS DAN CONT BIOGECHECKT  (BINNEN FISCALYEAR VAN DIT EVENT)
                if (date_bigger($part_biogecheckt, $cont_biogecheckt) == 1) {
                    $new_ditjaar_biogecheckt = $part_biogecheckt;
                    wachthond($extdebug,3, "part_biogecheckt [$part_biogecheckt] > cont_biogecheckt $cont_biogecheckt", "[part_biogecheckt was nieuwer]");
                }
                // ALS PART_BIOGECHECKT LEEG IS EN CONT BIOGECHECKT BESTAAT         (BINNEN FISCALYEAR VAN DIT EVENT)
                if (empty($part_biogecheckt)) {
                    $new_ditpart_biogecheckt = $cont_biogecheckt;
                    wachthond($extdebug,3, "cont_biogecheckt [$cont_biogecheckt] > part_biogecheckt $part_biogecheckt", "[part_biogecheckt was leeg]");
                }
            }

            ##########################################################################################
            ### BEPAAL NIEUWE STATUS BIO
            ##########################################################################################

            if ($cont_biogecheckt_infiscalyear_ditjaar == 1) {
                $new_ditjaar_biostatus  = 'bijgewerkt';
                wachthond($extdebug,1,  "CONT_BIOGECHECKT [$new_ditjaar_biogecheckt] IN FISCAL JAAR DIT JAAR",  "> CONT_BIOSTATUS: [$new_ditjaar_biostatus]");
            } else {
                $new_ditjaar_biostatus  = 'ongecheckt';
            }

            if ($cont_biogecheckt_infiscalyear_ditevent == 1) {
                $new_ditpart_biostatus  = 'bijgewerkt';
                wachthond($extdebug,1,  "CONT_BIOGECHECKT [$new_ditjaar_biogecheckt] IN FISCAL JAAR VAN EVENT", "> PART_BIOSTATUS: [$new_ditpart_biostatus]");
            } else {
                $new_ditpart_biostatus = 'ongecheckt';
            }

            wachthond($extdebug,3, 'new_ditjaar_bionodig',      $new_ditjaar_bionodig);
            wachthond($extdebug,3, 'new_ditjaar_biogecheckt',   $new_ditjaar_biogecheckt);
            wachthond($extdebug,3, 'new_ditjaar_biostatus',     $new_ditjaar_biostatus);

            wachthond($extdebug,3, 'new_ditpart_bionodig',      $new_ditpart_bionodig);
            wachthond($extdebug,3, 'new_ditpart_biogecheckt',   $new_ditpart_biogecheckt);
            wachthond($extdebug,3, 'new_ditpart_biostatus',     $new_ditpart_biostatus);

        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 13.3 BEPAAL DE STATUS REF $displayname [$ditevent_leid_functie $ditevent_event_kampkort]","[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        $new_refpersoon_actstatus = 'Available';  // DEFAULT TO AVAILABLE (CONCEPT)
        $new_refverzoek_actstatus = 'Available';  // DEFAULT TO AVAILABLE (CONCEPT)

        $new_ditjaar_refnodig = NULL;
        $new_ditpart_refnodig = NULL;

        // M61: TODO: DIT PRIMAIR HALEN UIT RELATION REFERENTIE IPV WAARDE UIT EVENT. (OOK HANDIG BIJ 2X ALS LEIDING MEE)   

        if ($refrecent) {

            $refrecent_infiscalyear_ditjaar  = infiscalyear($refrecent,$today_datetime,      'refrecent','ditjaar');
            $refrecent_infiscalyear_ditevent = infiscalyear($refrecent,$ditevent_event_start,'refrecent','ditevent');
            wachthond($extdebug,3, "refrecent_infiscalyear_ditjaar",  "$refrecent_infiscalyear_ditjaar\t[refrecent: $refrecent]");
            wachthond($extdebug,3, "refrecent_infiscalyear_ditevent", "$refrecent_infiscalyear_ditevent\t[refrecent: $refrecent]");       

            $refrecent_binnengrens = date_biggerequal($refrecent, $grensrefnoggoed, 'refrecent', 'refgrens');
            $refrecent_buitengrens = date_biggerequal($grensrefnoggoed, $refrecent, 'refgrens',  'refrecent');
            wachthond($extdebug,3, "refrecent_binnengrens",       "$refrecent_binnengrens\t[refrecent: $refrecent]");
            wachthond($extdebug,3, "refrecent_buitengrens",       "$refrecent_buitengrens\t[refrecent: $refrecent]");

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 13.3 A STATUS REF IGV REFRECENT BUITEN GRENSNOGGOED");
            wachthond($extdebug,3, "########################################################################");

            // REFRECENT VALT BUITEN GRENS NOGGOED
            if ($refrecent_buitengrens == 1 OR empty($refrecent)) {

                wachthond($extdebug,2, "DATUM REF [$refrecent] VALT BUITEN GRENS NOGGOED REF ($grensnoggoedjaar JAAR)",   "[>$grensrefnoggoed]");

                $new_ditjaar_refnodig           = 'opnieuw';
                $new_ditjaar_refstatus          = 'onbekend';

                if ($curcv_keer_leid == 1) {
                    $new_ditjaar_refnodig       = 'eerstex';
                }

                if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

                    $new_ditpart_refnodig       = 'opnieuw';
                    $new_ditpart_refstatus      = 'onbekend';

                    if ($curcv_keer_leid == 1) {
                        $new_ditpart_refnodig   = 'eerstex';
                    }
                }
            }

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 13.3 B STATUS REF IGV REFRECENT BINNEN GRENSNOGGOED");
            wachthond($extdebug,3, "########################################################################");

            // REFRECENT VALT BINNEN GRENS NOGGOED
            if ($refrecent_binnengrens == 1) {

                wachthond($extdebug,2, "DATUM REF [$refrecent] VALT BINNEN GRENS NOGGOED REF ($grensnoggoedjaar JAAR)",   "[>$grensrefnoggoed]");

                $new_ditjaar_refnodig       = 'noggoed';
                $new_ditjaar_refstatus      = 'noggoed';

                ### INDIEN BINNEN GRENS + EVENT IS VAN DITJAAR
                if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

                    $new_ditpart_refnodig     = 'noggoed';
                    $new_ditpart_refstatus    = 'noggoed';
                }

                // REFRECENT VALT BINNEN EVENTJAAR VAN DITEVENT
                if ($refrecent_infiscalyear_ditjaar == 1) {

                    wachthond($extdebug,2, "DATUM REF [$refrecent] VALT BINNEN HUIDIGE FISCALE JAAR)",    "[>$today_fiscalyear_start]");

                    $new_ditjaar_refnodig   = 'noggoed';
                    $new_ditjaar_refstatus  = 'ontvangen';

                    if ($refrecent_infiscalyear_ditevent == 1) {

                        wachthond($extdebug,2, "DATUM REF [$refrecent] VALT BINNEN DIT JAAR VAN DIT EVENT",   "[>$ditevent_fiscalyear_start]");

                        $new_ditpart_refnodig   = 'noggoed';
                        $new_ditpart_refstatus  = 'ontvangen';
                    }
                }
            }

        } else {

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 13.3 C STATUS REF IGV REFRECENT = LEEG");
            wachthond($extdebug,3, "########################################################################");

            ### INDIEN ER GEEN REFRECENT IS DAN IS DEZE DUS NOG NODIG
            if ($curcv_keer_leid == 1) {
                $new_ditjaar_refnodig       = 'eerstex';
            } elseif ($curcv_keer_leid >= 2) { 
                $new_ditjaar_refnodig       = 'opnieuw';
            }

            $new_ditjaar_refstatus      = 'onbekend'; // basisstatus

            if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {
                      $new_ditpart_refnodig     = $new_ditjaar_refnodig;
                      $new_ditpart_refstatus    = $new_ditjaar_refstatus;
            }
        }

        if ($new_ditjaar_refstatus == 'bekend') {
            $new_ditjaar_refstatus  = 'vragen';
        }

        wachthond($extdebug,2, "DATUM REFRECENT IS LEEG DUS REFNODIG WORDT", "[$new_ditjaar_refnodig]");

        ###########################################################################################
        # BEPAAL STATUS REF VOOR DIT JAAR
        ###########################################################################################

        if (in_array($new_ditjaar_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND empty($referentie_name))  {
            $new_ditjaar_refstatus = 'onbekend';
        }
        if (in_array($new_ditjaar_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND $part_refpersoon)     {
            $new_ditjaar_refstatus = 'vragen';
        }
        if (in_array($new_ditjaar_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND $part_refgevraagd)    {
            $new_ditjaar_refstatus = 'gevraagd';
        }
        if (in_array($new_ditjaar_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND $part_reffeedback)    {
            $new_ditjaar_refstatus = 'ontvangen';
        }
        if (in_array($new_ditjaar_refnodig, array('noggoed')) AND $referentie_name) {
            $new_ditjaar_refstatus = 'noggoed';
        }

        ###########################################################################################
        # BEPAAL STATUS REF VOOR DIT EVENT
        ###########################################################################################

        if (in_array($new_ditpart_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND empty($referentie_name))  {
            $new_ditpart_refstatus = 'onbekend';
        }
        if (in_array($new_ditpart_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND $part_refpersoon)     {
            $new_ditpart_refstatus = 'vragen';
        }
        if (in_array($new_ditpart_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND $part_refgevraagd)    {
            $new_ditpart_refstatus = 'gevraagd';
        }
        if (in_array($new_ditpart_refnodig, array('eerstex', 'opnieuw', 'elkjaar', 'inhaal')) AND $part_reffeedback)    {
            $new_ditpart_refstatus = 'ontvangen';
        }
        if (in_array($new_ditpart_refnodig, array('noggoed')) AND $referentie_name) {
            $new_ditpart_refstatus = 'noggoed';
        }

        ###########################################################################################
        # BEPAAL STATUS REF NOG WAT UITZONDERINGEN
        ###########################################################################################

        if ($new_vognodignextyear == 1 AND empty($refrecent) AND $curcv_keer_leid >= 10) {
            $new_refpersoon_actstatus   = 'Not Required';
            $new_ditjaar_refstatus      = 'noggoed';
            wachthond($extdebug,1, "ZET REFSTATUS OP NOGGOED VOOR LEIDING WAARBIJ DIE MIST WAARBIJ VOLGEND JAAR WEER VOG NODIG IS", "[new_ditjaar_refstatus: $new_ditjaar_refstatus]");
        }

        ### SCENARIO LEIDING KEER MEE >5

        if (empty($refrecent) AND in_array($new_ditjaar_vognodig, array("noggoed")) AND $curcv_keer_leid >= 5) {
            $new_refpersoon_actstatus   = 'Not Required';
            $new_ditjaar_refstatus      = 'noggoed';
            wachthond($extdebug,1, "TREK REFSTATUS GELIJK MET VOGSTATUS VOOR LEIDING VAKER MEE >=5", "[new_ditjaar_refstatus: $new_ditjaar_refstatus]");
        }
        if (in_array($new_ditjaar_vognodig, array("noggoed")) AND $curcv_keer_leid > 2) {
            $new_refpersoon_actstatus   = 'Not Required';
            $new_ditjaar_refstatus      = 'noggoed';
            wachthond($extdebug,1, "TREK REFNODIG GELIJK MET VOGNODIG VOOR LEIDING VAKER MEE DAN 2", "[new_ditjaar_refstatus: $new_ditjaar_refstatus]");
        }

        wachthond($extdebug,3, "new_ditjaar_refnodig",          "$new_ditjaar_refnodig\t($refrecent)");
        wachthond($extdebug,3, "new_ditpart_refnodig",          "$new_ditpart_refnodig\t($refrecent)");
        wachthond($extdebug,3, "new_ditjaar_refstatus",         $new_ditjaar_refstatus);
        wachthond($extdebug,3, "new_ditpart_refstatus",         $new_ditpart_refstatus);
        wachthond($extdebug,3, "new_refpersoon_actstatus",      $new_refpersoon_actstatus);

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 13.4 A BEPAAL DE STATUS VAN DE VOG", "$displayname [$ditevent_leid_functie $ditevent_part_kampkort]");
        wachthond($extdebug,3, "########################################################################");

        ###########################################################################################
        # BEPAAL STATUS VOG DIT JAAR
        ###########################################################################################

        // VOGRECENT NIET IN DIT JAAR, WEL BINNEN GRENSNOGGOED
        if ($vogrecent_binnengrens == 1 AND $vogrecent_infiscalyear_ditjaar == 0) {
            $new_ditjaar_vogstatus  = 'noggoed';
        }
        // VOGRECENT VALT BUITEN GRENS NOGGOED
        if ($vogrecent_buitengrens == 1 OR empty($cont_voglaatste)) {
            $new_ditjaar_vogstatus  = 'klaarzetten';
        }
        // VOGRECENT DIT JAAR AANGEVRAAGD EN ONTVANNGEN
        if ($vogrecent_infiscalyear_ditjaar == 1) {
            $new_ditjaar_vogstatus  = 'ontvangen';
        }
        // INDIEN DITEVENT = DITJAAR PLAATS DAN VOG NODIG IN PART
        if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {
            $new_ditpart_vogstatus  = $new_ditjaar_vogstatus;
        }

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 14.8a CHECK OP REF VERZOEK IN HET HUIDIGE FISCALE JAAR VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,3, "########################################################################");

            $refverzoekditjaar = 0;
            if (infiscalyear($part_refgevraagd,$ditevent_event_start,'part_refgevraagd','ditevent') == 1) {
                $refverzoekditjaar = 1;
            }
            wachthond($extdebug,2, 'refverzoekditjaar', "$refverzoekditjaar $part_refgevraagd");

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 14.8b CHECK OP VOG VERZOEK IN HET HUIDIGE FISCALE JAAR VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,3, "########################################################################");

            $vogverzoekditjaar = 0;
            if (infiscalyear($part_vogverzocht,$ditevent_event_start,'part_vogverzocht','ditevent') == 1) {
                $vogverzoekditjaar = 1;
            }
            wachthond($extdebug,2, 'vogverzoekditjaar', "$vogverzoekditjaar $part_vogverzocht");

            if ($extref == 1) {

                wachthond($extdebug,3, "########################################################################");
                wachthond($extdebug,1, "### INT 14.9 UPDATE TAB INTAKE MBT NIEUWERE DATUMS REF & VOG IGV VOOR $displayname", "[groupID: $groupID]");
                wachthond($extdebug,3, "########################################################################");

                if ($refrecent) {
                    $refrecent_infiscalyear_ditjaar  = infiscalyear($refrecent,$today_datetime,      'refrecent','ditjaar');
                    $refrecent_infiscalyear_ditevent = infiscalyear($refrecent,$ditevent_event_start,'refrecent','ditevent');
                    wachthond($extdebug,3, "refrecent_infiscalyear_ditjaar",  "$refrecent_infiscalyear_ditjaar\t[refrecent: $refrecent]");
                    wachthond($extdebug,3, "refrecent_infiscalyear_ditevent", "$refrecent_infiscalyear_ditevent\t[refrecent: $refrecent]");     
                }

                ### NIEUWSTE WAARDE REF KOMT UIT PART 
                if ( ($part_reffeedback   AND empty($refrecent)) OR date_bigger($part_reffeedback, $refrecent) == 1) {

                    $new_refnaam    = $part_refnaam;

                    $new_ditjaar_refrecent  = $part_reffeedback;
                    $new_ditjaar_refnaam    = $part_refnaam;

                    wachthond($extdebug,2, "WEL UPDATE TAB REFRECENT WANT PART_REFFEEDBACK IS NIEUWER",   $new_ditjaar_refrecent);
                }

                ### NIEUWSTE WAARDE REF KOMT UIT CONT 
                if ( ($referentie_feedback  AND empty($refrecent)) OR date_bigger($part_reffeedback, $refrecent) == 1) {

                    $new_ditjaar_refrecent = $referentie_feedback;
                    wachthond($extdebug,2, "WEL UPDATE TAB REFRECENT WANT REFERENTIE_FEEDBACK IS NIEUWER",  $new_ditjaar_refrecent);
                }

                ### DATUM INTAKE REFPERSOON IS LEEG: VUL MET LAATSTE WAARDE REF FEEDBACK 
                if ( empty($refpersoon) AND !empty($new_ditjaar_refrecent) ) {

                    $new_ditjaar_refpersoon = $new_ditjaar_refrecent;
                    wachthond($extdebug,2, "WEL UPDATE TAB REFPERSOON WANT LEEG. UPDATE MET REFRECENT",   $new_ditjaar_refpersoon);
                }

            } 

            if ($cont_voglaatste) {
                $vogrecent_infiscalyear_ditjaar  = infiscalyear($cont_voglaatste,$today_datetime,      'vogrecent','ditjaar');
                $vogrecent_infiscalyear_ditevent = infiscalyear($cont_voglaatste,$ditevent_event_start,'vogrecent','ditevent');
                wachthond($extdebug,3, "vogrecent_infiscalyear_ditjaar",  "$vogrecent_infiscalyear_ditjaar [vogrecent: $cont_voglaatste]");
                wachthond($extdebug,3, "vogrecent_infiscalyear_ditevent", "$vogrecent_infiscalyear_ditevent [vogrecent: $cont_voglaatste]");      
            }

            if ($extvog == 1) {

                if ( ($part_vogdatum    AND empty($cont_voglaatste)) OR date_bigger($part_vogdatum, $cont_voglaatste) == 1) {

                    $new_ditjaar_vogrecent  = $part_vogdatum;
                    $new_ditjaar_vogkenmerk = $part_vogkenmerk;

                    wachthond($extdebug,2, "WEL UPDATE TAB VOGRECENT WANT PART_VOGDATUM IS NIEUWER",        $part_vogdatum);
                } else {
                    wachthond($extdebug,2, "GEEN UPDATE TAB VOGRECENT WANT PART_VOGDATUM IS NIET NIEUWER",  $part_vogdatum);
                }
            }

        if ($extvog == 1 AND ($ditjaareventleidmss == 1 OR $ditjaareventleidyes == 1)) {

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 14.10 UPDATE INTAKE GEGEVENS IN PART LEID VOG VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,3, "########################################################################");

            if (empty($part_vogontvangst)   AND infiscalyear($part_vogdatum,$ditevent_event_start,'part_vogdatum','ditevent') == 1) {
                $new_part_vogontvangst  = $part_vogdatum;
                wachthond($extdebug,1, "VOGONTVANGST LEEG MAAR VOGDATUM INGEVULD", "[part_vogdatum: $part_vogdatum]");
            }
            if (empty($part_vogdatum)     AND infiscalyear($part_vogontvangst,$ditevent_event_start,'part_vogontvangst','ditevent') == 1) {
                $new_part_vogdatum      = $part_vogontvangst;
                wachthond($extdebug,1, "VOGDATUM LEEG MAAR VOGONTVANGST INGEVULD", "[part_vogontvangst: $part_vogontvangst]");
            }
            if (empty($part_vogingediend)   AND infiscalyear($part_vogdatum,$ditevent_event_start,'part_vogdatum','ditevent') == 1) {
                $new_part_vogaanvraag   = $part_vogdatum;
                wachthond($extdebug,1, "VOGAANVRAAG LEEG MAAR VOGDATUM INGEVULD", "[part_vogdatum: $part_vogdatum]");
            }
        }

        if ($extref == 1 AND $result_ref_get_refcount == 1 AND ($ditjaareventleidmss == 1 OR $ditjaareventleidyes == 1)) {

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 14.11 UPDATE INTAKE GEGEVENS IN PART LEID REF VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,3, "########################################################################");

            if (infiscalyear($referentie_start,$ditevent_event_start,'referentie_start','ditevent') == 1) {
                $new_part_refpersoon  = $referentie_start;
                wachthond($extdebug,1, "PART_REF_PERSOON LEEG MAAR DATUM REL_PERSOON_START IN FISCAL YEAR EVENT", "[referentie_start: $referentie_start]");
            }
            if (infiscalyear($referentie_einde,$ditevent_event_einde,'referentie_einde','ditevent') == 1) {
                $new_part_refpersoon  = $ditevent_fiscalyear_start;
                wachthond($extdebug,1, "PART_REF_PERSOON LEEG MAAR DATUM REL_PERSOON_EINDE IN FISCAL YEAR EVENT", "[referentie_start: $ditevent_fiscalyear_start]");
            }
            if (empty($part_refgevraagd)  AND infiscalyear($referentie_gevraagd,$ditevent_event_start,'referentie_gevraagd',    'ditevent') == 1) {
                $new_part_refgevraagd = $referentie_gevraagd;
                wachthond($extdebug,1, "PART_REF_GEVRAAGD LEEG MAAR REL_GEVRAAGD INGEVULD", "[referentie_gevraagd: $referentie_gevraagd]");
            }
            if (empty($part_reffeedback)  AND infiscalyear($referentie_feedback,$ditevent_event_start,'referentie_feedback',    'ditevent') == 1) {
                $new_part_reffeedback = $referentie_feedback;
                wachthond($extdebug,1, "PART_REF_FEEDBACK LEEG MAAR REL_FEEDBACK INGEVULD", "[referentie_feedback: $referentie_feedback]");
            }
            if (empty($part_refbezwaar)   AND infiscalyear($referentie_bezwaar,$ditevent_event_start,'referentie_bezwaar',      'ditevent') == 1) {
                $new_part_refbezwaar  = $referentie_bezwaar;
                wachthond($extdebug,1, "PART_REF_BEZWAAR LEEG MAAR REL_BEZWAAR INGEVULD", "[referentie_bezwaar: $referentie_bezwaar]");
            }
        }

    if ($extref == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND $ditjaareventleidyes == 1) {

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 15.1 x BEPAAL NEW DATUMS VOOR ACTIVITIES REF VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,1, "########################################################################");

        wachthond($extdebug,2, "1. prt_refpersoon",   $part_refpersoon);
        wachthond($extdebug,2, "2. act_refpersoon",   $refpersoon_activity_datum);
        if ($referentie_start) {  wachthond($extdebug,3, "2. rel_refpersoon",   $referentie_start);   }

        wachthond($extdebug,2, "1. prt_refverzoek",   $part_refgevraagd);
        wachthond($extdebug,2, "2. act_refverzoek",   $refverzoek_activity_datum);
        if ($referentie_gevraagd) { wachthond($extdebug,3, "2. rel_refverzoek",   $referentie_gevraagd);  }

        wachthond($extdebug,2, "1. prt_reffeedback",  $part_reffeedback);
        wachthond($extdebug,2, "2. act_reffeedback",  $referentie_feedback);    // M61 er is geen aparte act datum feedback 
        if ($referentie_feedback) { wachthond($extdebug,3, "2. rel_reffeedback",  $referentie_feedback);  }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 15.1 a BEPAAL (NIEUWE) DATUM ACTIVITY REF PERSOON VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $datum_refpersoon                   = NULL;
        $ditjaar_refpersoon_actdatetime     = NULL;

        if (infiscalyear($part_refpersoon,$ditevent_event_start,'part_refpersoon','ditevent') == 1) {
            $datum_refpersoon               = $part_refpersoon;
            $ditjaar_refpersoon_actdatetime = $datum_refpersoon;
            wachthond($extdebug,3, "activity_datum ref_persoon - LOGDATUM = part_refpersoon",   $datum_reffeedback);
        } else {
            $newdate            = strtotime ('+42 day' , strtotime($ditevent_register_date));
            $datum_refpersoon   = date ( 'Y-m-d H:i:s' , $newdate );
            $ditjaar_refpersoon_actdatetime = $datum_refpersoon;
            wachthond($extdebug,3, "activity_datum ref_persoon - DEADLINE = part_regdate +42",  $datum_refpersoon);
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 15.1 b BEPAAL (NIEUWE) DATUM ACTIVITY REF VERZOEK VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        $datum_refverzoek                   = NULL;
        $ditjaar_refverzoek_actdatetime     = NULL;

        if (infiscalyear($part_reffeedback,$ditevent_event_start,'part_reffeedback','ditevent') == 1) {
            $datum_refverzoek   = $part_reffeedback;
            wachthond($extdebug,3, "activity_datum ref_verzoek - LOGDATUM = part_reffeedback",  $datum_reffeedback);
        } elseif (!empty($part_refgevraagd)) {
            $newdate      = strtotime ('+42 day' , strtotime($part_refgevraagd));
            $datum_refverzoek   = date ( 'Y-m-d H:i:s' , $newdate );
            $ditjaar_refverzoek_actdatetime   = $datum_refverzoek;
            wachthond($extdebug,3, "activity_datum ref_verzoek - LOGDATUM = ref_verzoek +42",   $datum_refverzoek);
        } else {
            $datum_refverzoek   = $eventkamp_event_start;
            wachthond($extdebug,3, "activity_datum ref_verzoek - LOGDATUM = eventkamp_start",   $datum_refverzoek);
        }

        wachthond($extdebug,1, "########################################################################");

    } else {
        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,3, 'extref',                $extref);
        wachthond($extdebug,3, 'extact',                $extact);
        wachthond($extdebug,3, 'ditjaarleidstf',        $ditjaarleidstf);
        wachthond($extdebug,3, 'ditjaareventleidyes',   $ditjaareventleidyes);
        wachthond($extdebug,3, 'profilepartleidmax',    $profilepartleidmax);
        wachthond($extdebug,1, "### INT 12.1 SKIPPED BEPAAL DE JUISTE DATUMS VOOR ACTIVITIES REF", "[groupID: $groupID]");
    }

    if ($extvog == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND $ditjaareventleidyes == 1) {

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 15.2 a BEPAAL (NIEUWE) DATUM ACTIVITY VOG VERZOEK VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        $datum_vogverzoek                   = NULL;
        $new_ditjaar_vogverzoek_actdatetime = NULL;

        if (infiscalyear($part_vogverzocht, $ditevent_event_start,'part_vogverzocht','ditevent') == 1) {
            $datum_vogverzoek                       = $part_vogverzocht;
            $new_ditjaar_vogverzoek_actdatetime     = $part_vogverzocht;
            wachthond($extdebug,3, "activity_datum vog_verzoek - LOGDATUM = vog verzocht",    $datum_vogverzoek);
        } else {
            $newdate                                = strtotime ('+14 day' , strtotime($ditevent_register_date));
            $datum_vogverzoek                       = date ( 'Y-m-d H:i:s' , $newdate );
            $new_ditjaar_vogverzoek_actdatetime     = $datum_vogverzoek;
            wachthond($extdebug,3, "activity_datum vog_verzoek - LOGDATUM = part_reg_date +14", $datum_vogverzoek);
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 15.2 b BEPAAL (NIEUWE) DATUM ACTIVITY VOG AANVRAAG VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        $datum_vogaanvraag                      = NULL;
        $new_ditjaar_vogaanvraag_actdatetime    = NULL;

        if (infiscalyear($part_vogingediend, $ditevent_event_start,'part_vogingediend','ditevent') == 1) {
            // M61 TODO: als leiding datum in de toekomst ingaf, dat corrigeren naar datum van verzenden formulier
            $datum_vogaanvraag                      = $part_vogingediend;
            $new_ditjaar_vogaanvraag_actdatetime    = $datum_vogaanvraag;
            wachthond($extdebug,3, "activity_datum vog_aanvraag - LOGDATUM = vog ingediend", $datum_vogaanvraag);
        } elseif (infiscalyear($part_vogverzocht, $ditevent_event_start,'part_vogverzocht','ditevent') == 1) {
            $newdate                                = strtotime ( '+30 day' , strtotime ($part_vogverzocht) ) ;
            $datum_vogaanvraag                      = date ( 'Y-m-d H:i:s' , $newdate );
            $new_ditjaar_vogaanvraag_actdatetime    = $datum_vogaanvraag;
            wachthond($extdebug,3, "activity_datum vog_aanvraag - DEADLINE = part_verzocht +42",  $datum_vogaanvraag);
        } else {
            $datum_vogaanvraag                      = $eventkamp_event_start;
            $new_ditjaar_vogaanvraag_actdatetime    = $datum_vogaanvraag;
            wachthond($extdebug,3, "activity_datum vog_aanvraag - LOGDATUM = eventkamp_start",    $datum_vogaanvraag);
        }

        if (infiscalyear($part_vogdatum, $ditevent_event_start,'part_vogdatum','ditevent') == 1 AND empty($part_vogingediend)) {  
            $datum_vogaanvraag                      = $part_vogdatum;
            $new_ditjaar_vogaanvraag_actdatetime    = $datum_vogaanvraag;
            wachthond($extdebug,3, "activity_datum vog_aanvraag - LOGDATUM = vogdatum",       $datum_vogaanvraag);
        }

        if (date_bigger($datum_vogaanvraag, $eventkamp_event_start) == 1) {
            wachthond($extdebug,3, "### DATUM ACTIVITY ONTVANGST > EVENT START DATE ###");
            $datum_vogaanvraag                      = $eventkamp_event_start;   // M61: TODO WAAROM EIGENLIJK?
            $new_ditjaar_vogaanvraag_actdatetime    = $datum_vogaanvraag;       // M61: TODO WAAROM EIGENLIJK?
            wachthond($extdebug,3, "activity_datum vog_aanvraag - LOGDATUM = eventkamp_event_einde", $datum_vogaanvraag);
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 15.2 c BEPAAL (NIEUWE) DATUM ACTIVITY VOG ONTVANGST VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,3, "########################################################################");

        $datum_vogontvangst                     = NULL;
        $new_ditjaar_vogontvangst_actdatetime   = NULL;

        if (infiscalyear($part_vogontvangst, $ditevent_event_start,'part_vogontvangst','ditevent') == 1) {
            $datum_vogontvangst                     = $part_vogontvangst;
            $new_ditjaar_vogontvangst_actdatetime   = $datum_vogontvangst;
            wachthond($extdebug,3, "activity_datum vog_ontvangst - LOGDATUM = datum vog ontvangst", $datum_vogontvangst);
        } elseif (date_bigger($datum_vogontvangst, $eventkamp_event_start) == 1) {
            wachthond($extdebug,3, "### DATUM ACTIVITY ONTVANGST > EVENT START DATE ###");
            $datum_vogontvangst                     = $eventkamp_event_einde;   // M61: TODO WAAROM EIGENLIJK?
            $new_ditjaar_vogontvangst_actdatetime   = $datum_vogontvangst;      // M61: WRS OM LATE DICHT BIJ EVT DATE TE HOUDEN
            wachthond($extdebug,3, "activity_datum vog_ontvangst - LOGDATUM = eventkamp_einde",   $datum_vogontvangst);
        } elseif (infiscalyear($part_vogingediend, $ditevent_event_start,'part_vogingediend','ditevent') == 1) {
            $newdate                                = strtotime ( '+49 day', strtotime ($part_vogingediend) ) ;
            $datum_vogontvangst                     = date ( 'Y-m-d H:i:s' , $newdate );
            $new_ditjaar_vogontvangst_actdatetime   = $datum_vogontvangst;
            wachthond($extdebug,3, "activity_datum vog_ontvangst - DEADLINE = part_ingediend +42",  $datum_vogontvangst);
        } else {
            $datum_vogontvangst                     = $eventkamp_event_einde;
            $new_ditjaar_vogontvangst_actdatetime   = $datum_vogontvangst;
            wachthond($extdebug,3, "activity_datum vog_ontvangst - DEADLINE = eventkamp_start",   $datum_vogontvangst);
        }

    } else {
        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,3, 'extvog',              $extvog);
        wachthond($extdebug,3, 'extact',              $extact);
        wachthond($extdebug,3, 'ditjaareventleidstf', $ditjaareventleidstf);
        wachthond($extdebug,3, 'ditjaareventleidyes', $ditjaareventleidyes);
        wachthond($extdebug,3, 'profilepartleidmax',  $profilepartleidmax);
        wachthond($extdebug,1, "### INT 12.2 SKIPPED BEPAAL DE JUISTE DATUMS VOOR ACTIVITIES VOG", "[groupID: $groupID]");
    }

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INT 16.X CREATE INTAKE ACTIVITIES VOOR $displayname", "[groupID: $groupID]");

    $activity_array = array(
        'displayname'               => $displayname,
        'contact_id'                => $contact_id,
        'activity_source'           => 1, 
        'activity_target'           => $contact_id,
        'activity_assignee'         => $related_hoofdleiding_id,
        'activity_date_time'        => $today_datetime,
        'activity_status_name'      => 'Available',     // initial status concept
        'activity_prioriteit'       => 'Normaal',
    );

    $intake_array = array(
        'ref_nodig'                 => $new_ditjaar_refnodig,
        'ref_datum_persoon'         => $part_refpersoon,
        'ref_datum_gevraagd'        => $part_refgevraagd,
        'ref_datum_feedback'        => $part_reffeedback,
        'ref_datum_bezwaar'         => $part_refbezwaar,

        'ref_aanvrager_naam'        => $displayname,
        'ref_aanvrager_functie'     => $ditevent_leid_functie,
        'ref_aanvrager_pid'         => $ditevent_part_id,
        'ref_aanvrager_cid'         => $contact_id,

        'ref_rel_id'                => $referentie_relid,
        'ref_referentie_cid'        => $referentie_cid,
        'ref_referentie_naam'       => $referentie_name,
        'ref_referentie_voornaam'   => $referentie_fn,
        'ref_referentie_telefoon'   => $referentie_phone,
    );

    if ($extref == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND $ditjaareventleidyes == 1) {

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 16.1 CREATE AN ACTIVITY REFPERSOON VOOR $displayname", "[ALS REF PERSOON IS GEVRAAGD]");
        wachthond($extdebug,2, "########################################################################");

        wachthond($extdebug,3, 'refpersoon_activity_id',   $refpersoon_activity_id);

        if (empty($refpersoon_activity_id) AND in_array($new_ditjaar_refnodig,array("eerstex","elkjaar","opnieuw","inhaal"))) {

            $activity_array['activity_type_id']     = 139;
            $activity_array['activity_type_naam']   = 'ref_persoon';
            $activity_array['activity_subject']     = 'REF persoon doorgeven';

            $intake_activity_create = intake_activity_create($contact_id, $activity_array, $event_array, 'ref_persoon');
            wachthond($extdebug,3, "intake_activity_create",    "[NEW ACTID: $intake_activity_create]");
            $refpersoon_activity_id = $intake_activity_create;            

        } else {
            wachthond($extdebug,2, "INFO: Er wordt GEEN activiteit REFPERSOON aangemaakt", "[aid: $refpersoon_activity_id]");
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 16.2 CREATE AN ACTIVITY REFVERZOEK VOOR $displayname", "[ALS REF PERSOON IS VERZOCHT]");
        wachthond($extdebug,3, "########################################################################");

        if (empty($refverzoek_activity_id) AND $part_refgevraagd) {

            $activity_array['activity_type_id']     = 117;
            $activity_array['activity_type_naam']   = 'ref_feedback';
            $activity_array['activity_subject']     = 'REF feedback ontvangen';

            $intake_activity_create = intake_activity_create($contact_id, $activity_array, $event_array, 'ref_verzoek');
            wachthond($extdebug,3, "intake_activity_create",    "[NEW ACTID: $intake_activity_create]");
            $refverzoek_activity_id = $intake_activity_create;

        } elseif ($refverzoek_activity_id > 0) {
            wachthond($extdebug,2, "INFO: Er wordt GEEN activiteit REFVERZOEK aangemaakt", "[aid: $refverzoek_activity_id]");
        } elseif (empty($part_refgevraagd)) {
            wachthond($extdebug,2, "INFO: Er wordt GEEN activiteit REFVERZOEK aangemaakt", "[feedback nog niet gevraagd]");
        }

    } else { 
        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, 'extref',                  $extref);
        wachthond($extdebug,1, 'extact',                  $extact);
        wachthond($extdebug,1, 'ditjaarleidstf',          $ditjaarleidstf);
        wachthond($extdebug,1, 'ditjaareventleidyes',     $ditjaareventleidyes);
        wachthond($extdebug,1, "### INT 13.X SKIPPED CREATE INTAKE ACTIVITIES REF", "[groupID: $groupID]");
    }

    if ($extvog == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND $ditjaareventleidyes == 1) {

        $intake_array = array(
            'vog_nodig'                 => $new_ditjaar_vognodig,
            'vog_datum_verzoek'         => $part_vogverzocht,
            'vog_datum_aanvraag'        => $part_vogingediend,
            'vog_datum_ontvangst'       => $part_vogontvangst,
        );

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 16.3 CREATE AN ACTIVITY VOGVERZOEK VOOR $displayname", "[ALVAST ALS PLACEHOLDER]");
        wachthond($extdebug,3, "########################################################################");

        wachthond($extdebug,3, 'vogverzoek_activity_id',   $vogverzoek_activity_id);

        if (empty($vogverzoek_activity_id) AND in_array($new_ditjaar_vognodig, array('eerstex','opnieuw','elkjaar','inhaal'))) {

            $activity_array['activity_type_id']     = 118;
            $activity_array['activity_type_naam']   = 'vog_verzoek';
            $activity_array['activity_subject']     = 'VOG aanvraag verzocht';

            $intake_activity_create = intake_activity_create($contact_id, $activity_array, $event_array, $intake_array);
            wachthond($extdebug,3, "intake_activity_create",    "[NEW ACTID: $intake_activity_create]");
            $vogverzoek_activity_id = $intake_activity_create;

        } else {
            wachthond($extdebug,2, "INFO: Er wordt GEEN activiteit VOGVERZOEK aangemaakt", "[aid: $vogverzoek_activity_id]");
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 16.4 CREATE AN ACTIVITY VOGAANVRAAG VOOR $displayname", "[ALS VOG AANVRAAG IS INGEDIEND]");
        wachthond($extdebug,3, "########################################################################");

        if (empty($vogaanvraag_activity_id) AND in_array($new_ditjaar_vognodig, array('eerstex','opnieuw','elkjaar','inhaal'))) {
      
            $activity_array['activity_type_id']     = 119;
            $activity_array['activity_type_naam']   = 'vog_aanvraag';
            $activity_array['activity_subject']     = 'VOG aanvraag ingediend';
            
            $intake_activity_create = intake_activity_create($contact_id, $activity_array, $event_array, $intake_array);
            wachthond($extdebug,3, "intake_activity_create",    "[NEW ACTID: $intake_activity_create]");
            $vogaanvraag_activity_id = $intake_activity_create;

        } else {
            wachthond($extdebug,2, "INFO: Er wordt GEEN activiteit VOGAANVRAAG aangemaakt", "[aid: $vogaanvraag_activity_id]");
        }

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 16.4 CREATE AN ACTIVITY VOGONTVANGST VOOR $displayname", "[ALS VOG AANVRAAG IS INGEDIEND]");
        wachthond($extdebug,3, "########################################################################");

        if (empty($vogontvangst_activity_id) AND in_array($new_ditjaar_vognodig, array('eerstex','opnieuw','elkjaar','inhaal'))) {

            $activity_array['activity_type_id']     = 120;
            $activity_array['activity_type_naam']   = 'vog_ontvangst';
            $activity_array['activity_subject']     = 'VOG ontvangst bevestigd';

            $intake_activity_create = intake_activity_create($contact_id, $activity_array, $event_array, $intake_array);
            wachthond($extdebug,3, "intake_activity_create",    "[NEW ACTID: $intake_activity_create]");
            $vogontvangst_activity_id = $intake_activity_create;            

        } else {
            wachthond($extdebug,2, "INFO: Er wordt GEEN activiteit VOGONTVANGST aangemaakt", "[aid: $vogontvangst_activity_id]");
        }

    } else {
        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, 'extvog',                            $extvog);
        wachthond($extdebug,1, 'extact',                            $extact);
        wachthond($extdebug,1, 'ditjaarleidstf',                    $ditjaarleidstf);
        wachthond($extdebug,1, 'ditjaareventleidyes',               $ditjaareventleidyes);
        wachthond($extdebug,1, 'profilepartleidmax',                $profilepartleidmax);           
        wachthond($extdebug,1, "### INT 13.X SKIPPED CREATE INTAKE ACTIVITIES VOG", "[groupID: $groupID]");
    }

    if ($extact == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) { // PROFILE PARTICIPANT LEID MAX 

      wachthond($extdebug,1, "########################################################################");
      wachthond($extdebug,1, "### INT 17. BEPAAL NIEUWE STATUS ONDERDELEN INTAKE $displayname", "[groupID: $groupID]");
      wachthond($extdebug,1, "########################################################################");
    }

    if ($extref == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) { // PROFILE PARTICIPANT LEID MAX  

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 17.1 a BEPAAL NEW STATUS ACTIVITEIT REF PERSOON VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $new_refpersoon_actstatus   = 'Available';    // DEFAULT TO AVAILABLE (CONCEPT)
        $new_refpersoon_actprio     = 'Normaal';      // DEFAULT TO NORMAL

        $part_refpersoon_infiscalyear_ditevent = infiscalyear($part_refpersoon, $ditevent_event_start, 'refpersoon', 'ditevent')  ?? 0;

        wachthond($extdebug,3, "- new_ditpart_refnodig",        $new_ditpart_refnodig);
        wachthond($extdebug,3, "- new_ditjaar_refnodig",        $new_ditjaar_refnodig);

        wachthond($extdebug,2, "- part_refpersoon",             $part_refpersoon);
        wachthond($extdebug,2, "- part_refpersoon_infiscalyear_ditevent",   "$part_refpersoon_infiscalyear_ditevent [part_refpersoon: $part_refpersoon]");

        wachthond($extdebug,2, "1 new_ditpart_refstatus",       $new_ditpart_refstatus);
        wachthond($extdebug,2, "1 new_ditjaar_refstatus",       $new_ditjaar_refstatus);
        wachthond($extdebug,2, "1 new_refpersoon_actstatus",    $new_refpersoon_actstatus);

        if (in_array($new_ditjaar_refnodig, array("noggoed"))) {
            $new_refpersoon_actstatus   = 'Not Required';
        } else {

        $diffsince_refpersoon   = NULL;
        $dayssince_refpersoon   = NULL;
        #if ($part_refpersoon) { $act_refpersoon = $part_refpersoon; } else { $act_refpersoon = $today_datetime; }
        $diffsince_refpersoon = date_diff(date_create($part_refpersoon),date_create($today_datetime));
        $dayssince_refpersoon = $diffsince_refpersoon->format('%a');
        wachthond($extdebug,2, "- dayssince_refpersoon",  $dayssince_refpersoon);

        if ($dayssince_refpersoon >= 0  AND $dayssince_refpersoon < 7)      { $new_refpersoon_actstatus = "Pending";        } // AFWACHTING
        if ($dayssince_refpersoon >= 7  AND $dayssince_refpersoon < 21)     { $new_refpersoon_actstatus = "Left Message";   } // HERINNERD
        if ($dayssince_refpersoon >= 21 AND $dayssince_refpersoon < 35)     { $new_refpersoon_actstatus = "Unreachable";    } // ONBEREIKBAAR
        if ($dayssince_refpersoon >= 35)                                    { $new_refpersoon_actstatus = "No_show";        } // VERLOPEN
        if ($dayssince_refpersoon >= 270)                                   { $new_refpersoon_actstatus = "Bounced";        } // GEFAALD

        if ( date_bigger($today_datetime, $ditevent_event_einde) == 1 AND $new_refpersoon_actstatus != "Completed") {
//          $new_refpersoon_actstatus = "Failed";
//          Failed nadat de laatste dag van kamp gepasseerd is
//          wachthond($extdebug,2, "activity refpersoon > status failed want event inmiddels voorbij");
        }

        // M61 zorg dat de REF persoon activity en mails pas starten zodra de VOG klaargezet is (1 mail met intake todo's)
        if (in_array($new_ditjaar_vognodig, array("eerstex", "elkjaar", "opnieuw")) AND $vogverzoekditjaar == 1) {
            $new_refpersoon_actstatus   = 'Scheduled';
            wachthond($extdebug,3, "ditjaar_refpersoon_actstatus: $new_refpersoon_actstatus", "[vog verzocht dus trigger ook referentie en verstuur bredere intake email");
        }
        // M61 zorg dat de REF persoon activity en mails pas starten zodra de VOG klaargezet is (1 mail met intake todo's)
        if (in_array($new_ditjaar_vognodig, array("eerstex", "elkjaar", "opnieuw")) AND $vogverzoekditjaar != 1) {
            $new_refpersoon_actstatus   = 'Available';
            wachthond($extdebug,3, "ditjaar_refpersoon_actstatus: $new_refpersoon_actstatus", "[in afwachting van VOG verzoek]");
        }

        if ($refpersoon_activity_id AND $referentie_cid)  {
            $new_refpersoon_actstatus   = 'Completed';
            $new_ditjaar_refstatus      = 'vragen';
        }
        if ($refpersoon_activity_id AND $part_refgevraagd)  {
            $new_refpersoon_actstatus   = 'Completed';
            $new_ditjaar_refstatus      = 'gevraagd';
        }

        if ($new_refpersoon_actstatus == "Pending")         { $new_refpersoon_actprio = 'Laag';     }   // AFWACHTING
        if ($new_refpersoon_actstatus == "Left Message")    { $new_refpersoon_actprio = 'Normaal';  }   // HERINNERD
        if ($new_refpersoon_actstatus == "Unreachable")     { $new_refpersoon_actprio = 'Urgent';   }   // ONBEREIKBAAR
        if ($new_refpersoon_actstatus == "No_show")         { $new_refpersoon_actprio = 'Urgent';   }   // VERLOPEN     
        if ($new_refpersoon_actstatus == "Bounced")         { $new_refpersoon_actprio = 'Urgent';   }   // GEFAALD/GEBOUNCED
    }

      wachthond($extdebug,2, "2 new_ditpart_refstatus",         $new_ditpart_refstatus);
      wachthond($extdebug,2, "2 new_ditjaar_refstatus",         $new_ditjaar_refstatus);
      wachthond($extdebug,2, "2 new_refverzoek_actstatus",      $new_refverzoek_actstatus);
      wachthond($extdebug,2, "2 new_refverzoek_actprio",        $new_refverzoek_actprio);

      wachthond($extdebug,2, "########################################################################");
      wachthond($extdebug,1, "### INT 17.1 b COPY REFSTATUS DITEVENT > DITJAAR INDIEN EVENT DITJAAR $displayname", "[groupID: $groupID]");
      wachthond($extdebug,2, "########################################################################");

      if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

        wachthond($extdebug,2,  "REFSTATUS ($new_ditjaar_vogstatus) UIT DITEVENT GEKOPIEERD NAAR DITJAAR", "[WANT EVENT IS IN DITJAAR]");

//        $new_ditjaar_refstatus = $new_ditpart_refstatus;

      } else {

        wachthond($extdebug,2, 'ditjaareventleidyes',   $ditjaareventleidyes);
        wachthond($extdebug,2, 'ditjaareventleidstf',   $ditjaareventleidstf);

        wachthond($extdebug,2,  "REFSTATUS UIT DITEVENT NIET KOPIEREN NAAR DITJAAR WANT EVENT =! DITJAAR");

      }

      wachthond($extdebug,2, "########################################################################");
      wachthond($extdebug,1, "### INT 17.2 a BEPAAL NEW STATUS ACTIVITEIT REF VERZOEK VOOR $displayname", "[groupID: $groupID]");
      wachthond($extdebug,2, "########################################################################");

      $new_refverzoek_actstatus = 'Available';  // DEFAULT TO AVAILABLE (CONCEPT)
      $new_refverzoek_actprio   = 'Normaal';    // DEFAULT TO NORMAL
      $part_refgevraagd_infiscalyear_ditevent = infiscalyear($part_refgevraagd, $ditevent_event_start, 'refverzoek', 'ditevent')  ?? 0;

      wachthond($extdebug,3, "- new_ditpart_refnodig",          $new_ditpart_refnodig);
      wachthond($extdebug,3, "- new_ditjaar_refnodig",          $new_ditjaar_refnodig);

      wachthond($extdebug,2, "- part_refgevraagd",              $part_refgevraagd);
      wachthond($extdebug,2, "- part_refgevraagd_infiscalyear_ditevent", "$part_refgevraagd_infiscalyear_ditevent [part_refgevraagd: $part_refgevraagd]");

      wachthond($extdebug,2, "1 new_ditpart_refstatus",         $new_ditpart_refstatus);    
      wachthond($extdebug,2, "1 new_ditjaar_refstatus",         $new_ditjaar_refstatus);
      wachthond($extdebug,2, "1 new_refverzoek_actstatus",      $new_refverzoek_actstatus);

      if (in_array($new_ditjaar_refnodig, array("noggoed"))) {

        $new_refverzoek_actstatus   = 'Not Required';

      } else {

        $diffsince_refverzoek   = NULL;       
        $dayssince_refverzoek   = NULL;
        $diffsince_refverzoek   = date_diff(date_create($part_refgevraagd),date_create($today_datetime));
        $dayssince_refverzoek   = $diffsince_refverzoek->format('%a');
        wachthond($extdebug,2, "- dayssince_refverzoek",  $dayssince_refverzoek);

        if ($dayssince_refverzoek >= 0  AND $dayssince_refverzoek < 7)      { $new_refverzoek_actstatus = "Pending";        } // AFWACHTING
        if ($dayssince_refverzoek >= 7  AND $dayssince_refverzoek < 21)     { $new_refverzoek_actstatus = "Left Message";   } // HERINNERD
        if ($dayssince_refverzoek >= 21 AND $dayssince_refverzoek < 35)     { $new_refverzoek_actstatus = "Unreachable";    } // ONBEREIKBAAR
        if ($dayssince_refverzoek >= 35)                                    { $new_refverzoek_actstatus = "No_show";        } // VERLOPEN
        if ($dayssince_refverzoek >= 270)                                   { $new_refverzoek_actstatus = "Bounced";        } // GEFAALD

        if ( date_bigger($today_datetime, $ditevent_event_einde) == 1 AND $new_refverzoek_actstatus != "Completed") {
            // $status_refaanvraag = "Failed";
            wachthond($extdebug,2, "activity refverzoek > status failed want event inmiddels voorbij");
        }
        if ($refverzoek_activity_id AND ($part_reffeedback OR $referentie_feedback)) {
            $new_refverzoek_actstatus   = 'Completed';
            $new_ditjaar_refstatus      = 'ontvangen';
        }

        if ($new_refverzoek_actstatus == "Pending")     { $new_refverzoek_actprio = 'Laag';   }   // AFWACHTING
        if ($new_refverzoek_actstatus == "Left Message"){ $new_refverzoek_actprio = 'Normaal';}   // HERINNERD
        if ($new_refverzoek_actstatus == "Unreachable") { $new_refverzoek_actprio = 'Urgent'; }   // ONBEREIKBAAR
        if ($new_refverzoek_actstatus == "No_show")     { $new_refverzoek_actprio = 'Urgent'; }   // VERLOPEN
        if ($new_refverzoek_actstatus == "Bounced")     { $new_refverzoek_actprio = 'Urgent'; }   // GEFAALD/GEBOUNCED
      }

        wachthond($extdebug,2, "2 new_ditpart_refstatus",               $new_ditpart_refstatus);
        wachthond($extdebug,2, "2 new_ditjaar_refstatus",               $new_ditjaar_refstatus);
        wachthond($extdebug,2, "2 new_refverzoek_actstatus",            $new_refverzoek_actstatus);
        wachthond($extdebug,2, "2 new_refverzoek_actprio",              $new_refverzoek_actprio);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 17.2 b COPY REFSTATUS DITEVENT > DITJAAR INDIEN EVENT DITJAAR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

            wachthond($extdebug,2,  "REFSTATUS ($new_ditjaar_refstatus) UIT DITEVENT GEKOPIEERD NAAR DITJAAR", "[WANT EVENT IS IN DITJAAR]");
            wachthond($extdebug,2, "########################################################################");

//          $new_ditjaar_refstatus = $new_ditpart_refstatus;
        } else {

            wachthond($extdebug,2, 'ditjaareventleidyes',   $ditjaareventleidyes);
            wachthond($extdebug,2, 'ditjaareventleidstf',   $ditjaareventleidstf);
            wachthond($extdebug,2,  "REFSTATUS UIT DITEVENT NIET KOPIEREN NAAR DITJAAR WANT EVENT != DITJAAR");

        }
    }

    if ($extvog == 1 AND $extact == 1 AND ($diteventleidyes == 1 OR $diteventleidstf == 1)) {

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 17.3 a BEPAAL NEW STATUS ACTIVITEIT VOG VERZOEK VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $new_vogverzoek_actstatus     = 'Pending';  // DEFAULT TO AVAILABLE (AFWACHTING)
        $new_vogverzoek_actprio       = 'Normaal';  // DEFAULT TO NORMAL
        $vogverzocht_infiscalyear_ditevent    = infiscalyear($part_vogverzocht, $ditevent_event_start, 'vogrecent', 'ditevent') ?? 0;
        $partvogdatum_infiscalyear_ditevent   = infiscalyear($part_vogdatum,    $ditevent_event_start, 'vogrecent', 'ditevent') ?? 0;

        wachthond($extdebug,3, "- partvogdatum_infiscalyear_ditevent",  "$partvogdatum_infiscalyear_ditevent [partvogdatum: $part_vogdatum]");
        wachthond($extdebug,2, "- part_vogverzocht",                    $part_vogverzocht);
        wachthond($extdebug,3, "- vogverzocht_infiscalyear_ditevent",   "$vogverzocht_infiscalyear_ditevent [part_vogverzocht: $part_vogverzocht]");

        wachthond($extdebug,2, "1 new_ditpart_vognodig",                $new_ditpart_vognodig);
        wachthond($extdebug,2, "1 new_ditpart_vogstatus",               $new_ditpart_vogstatus);
        wachthond($extdebug,2, "1 new_vogverzoek_actstatus",            $new_vogverzoek_actstatus);
        wachthond($extdebug,2, "1 new_vogverzoek_actprio",              $new_vogverzoek_actprio);

        if (in_array($new_ditpart_vognodig, array('eerstex','opnieuw','elkjaar','inhaal'))) {

            if (date_bigger($part_vogverzocht, $ditevent_fiscalyear_start) == 1) {

                if ($vogverzocht_infiscalyear_ditevent  == 1) {
                    $new_ditpart_vogstatus      = 'verzocht';
                    $new_vogverzoek_actstatus   = 'Completed';
                }
                if ($vogingediend_infiscalyear_ditevent == 1)   {
                    $new_ditpart_vogstatus = 'ingediend';
                    wachthond($extdebug,2,  "STATUS VOG_AANVRAAG VAN $new_vogverzoek_actstatus NAAR Completed", 
                        "[WANT part_vogingediend: $part_vogingediend IN EVENT_FISCAL_YEAR");
                }
                if ($vogontvangst_infiscalyear_ditevent == 1)   {
                    $new_ditpart_vogstatus = 'ontvangen';
                    wachthond($extdebug,2,  "STATUS VOG AANVRAAG VAN $new_vogverzoek_actstatus NAAR Completed",
                        "[WANT part_vogontvangst: $part_vogontvangst IN EVENT_FISCAL_YEAR");
                }
                if ($partvogdatum_infiscalyear_ditevent == 1)   {
                    $new_ditpart_vogstatus = 'ontvangen'; 
                    wachthond($extdebug,2,  "STATUS VOG AANVRAAG VAN $new_vogverzoek_actstatus NAAR Completed",
                        "[WANT part_vogdatum: $part_vogdatum IN EVENT_FISCAL_YEAR");
                }

            } elseif (empty($part_vogverzocht))         {
                $new_ditpart_vogstatus = 'klaarzetten';
            }

        } elseif ($new_ditpart_vognodig == 'noggoed' AND $cont_voglaatste) {
            $new_ditpart_vogstatus          = 'noggoed';
            $new_vogaanvraag_actstatus      = 'Not Required';
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 17.3 b COPY VOGSTATUS DITEVENT > DITJAAR INDIEN EVENT DITJAAR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

      if ($diteventleidyes == 1 OR $diteventleidstf == 1) {

        wachthond($extdebug,2, "2 new_ditpart_vognodig",        $new_ditpart_vognodig);
        wachthond($extdebug,2, "2 new_ditpart_vogstatus",       $new_ditpart_vogstatus);
        wachthond($extdebug,2, "2 new_vogverzoek_actstatus",    $new_vogverzoek_actstatus);
        wachthond($extdebug,2, "2 new_vogverzoek_actprio",      $new_vogverzoek_actprio);
      }

      if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

        wachthond($extdebug,2,  "VOGSTATUS ($new_ditjaar_vogstatus) UIT DITEVENT GEKOPIEERD NAAR DITJAAR", "[WANT EVENT IS IN DITJAAR]");

        $new_ditjaar_vogstatus              = $new_ditpart_vogstatus;
        $new_vogverzoek_actstatus           = $new_vogverzoek_actstatus;
        $new_vogverzoek_actprio             = $new_vogverzoek_actprio;

        wachthond($extdebug,2, "2 new_ditjaar_vognodig",            $new_ditjaar_vognodig);
        wachthond($extdebug,2, "2 new_ditjaar_vogstatus",           $new_ditjaar_vogstatus);
        wachthond($extdebug,2, "2 new_vogverzoek_actstatus",        $new_vogverzoek_actstatus);
        wachthond($extdebug,2, "2 new_vogverzoek_actprio",          $new_vogverzoek_actprio);

      } else {

        wachthond($extdebug,2, 'ditjaareventleidyes',   $ditjaareventleidyes);
        wachthond($extdebug,2, 'ditjaareventleidstf',   $ditjaareventleidstf);

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,2,  "VOGSTATUS UIT DITEVENT NIET KOPIEREN NAAR DITJAAR WANT EVENT =! DITJAAR");
        wachthond($extdebug,2, "########################################################################");

      }

      wachthond($extdebug,2, "########################################################################");
      wachthond($extdebug,1, "### INT 17.4 a BEPAAL NEW STATUS ACTIVITEIT VOG AANVRAAG VOOR $displayname", "[groupID: $groupID]");
      wachthond($extdebug,2, "########################################################################");

      $new_vogaanvraag_actstatus    = 'Available';  // DEFAULT TO AVAILABLE (CONCEPT)
      $new_vogaanvraag_actprio      = 'Normaal';  // DEFAULT TO NORMAL
      $vogingediend_infiscalyear_ditevent   = infiscalyear($part_vogingediend,  $ditevent_event_start, 'vogrecent', 'ditevent') ?? 0;

      wachthond($extdebug,2, "- part_vogingediend",                 $part_vogingediend);
      wachthond($extdebug,3, "- vogingediend_infiscalyear_ditevent",$vogingediend_infiscalyear_ditevent);

      wachthond($extdebug,2, "1 new_ditpart_vognodig",              $new_ditpart_vognodig);
      wachthond($extdebug,2, "1 new_ditpart_vogstatus",             $new_ditpart_vogstatus);
      wachthond($extdebug,2, "1 new_vogaanvraag_actstatus",         $new_vogaanvraag_actstatus);
      wachthond($extdebug,2, "1 new_vogaanvraag_actprio",           $new_vogaanvraag_actprio);

      $diffsince_vogverzoek     = NULL;
      $dayssince_vogverzoek     = NULL;
      $diffsince_vogverzoek     = date_diff(date_create($part_vogverzocht),date_create($today_datetime));
      $dayssince_vogverzoek     = $diffsince_vogverzoek->format('%a');  
      wachthond($extdebug,2, "- dayssince_vogverzoek", $dayssince_vogverzoek);

      if ($dayssince_vogverzoek >= 0  AND $dayssince_vogverzoek < 14)     { $new_vogaanvraag_actstatus = "Pending";     } // AFWACHTING
      if ($dayssince_vogverzoek >= 14 AND $dayssince_vogverzoek < 21)     { $new_vogaanvraag_actstatus = "Left Message";} // HERINNERD
      if ($dayssince_vogverzoek >= 21 AND $dayssince_vogverzoek < 30)     { $new_vogaanvraag_actstatus = "Unreachable"; } // ONBEREIKBAAR
      if ($dayssince_vogverzoek >= 30)                                    { $new_vogaanvraag_actstatus = "No_show";     } // VERLOPEN
      if ($dayssince_vogverzoek >= 270)                                   { $new_vogaanvraag_actstatus = "Bounced";     } // GEFAALD/GEBOUNCED

      if ($new_vogaanvraag_actstatus == "Pending")      { $new_vogaanvraag_actprio = 'Laag';    }   // AFWACHTING
      if ($new_vogaanvraag_actstatus == "Left Message") { $new_vogaanvraag_actprio = 'Normaal'; }   // HERINNERD
      if ($new_vogaanvraag_actstatus == "Unreachable")  { $new_vogaanvraag_actprio = 'Urgent';  }   // ONBEREIKBAAR
      if ($new_vogaanvraag_actstatus == "No_show")      { $new_vogaanvraag_actprio = 'Urgent';  }   // VERLOPEN     
      if ($new_vogaanvraag_actstatus == "Bounced")      { $new_vogaanvraag_actprio = 'Urgent';  }   // GEFAALD/GEBOUNCED

      if ($vogaanvraag_activity_status_name != 'Completed' AND $new_vogaanvraag_actstatus == 'Completed') {
        $ditjaar_vogaanvraag_afgerond = $today_datetime;
      } else {
        $ditjaar_vogaanvraag_afgerond = $vogaanvraag_activity_afgerond;
      }

      if (in_array($new_ditpart_vognodig, array('eerstex','opnieuw','elkjaar','inhaal'))) {

        if (date_bigger($part_vogingediend, $ditevent_fiscalyear_start) == 1) {

          if ($vogverzocht_infiscalyear_ditevent  == 1) {
            $new_ditpart_vogstatus        = 'verzocht';
            $new_vogaanvraag_actstatus  = 'Available';
            wachthond($extdebug,2,  "STATUS VOG_AANVRAAG VAN $new_vogaanvraag_actstatus NAAR Available", 
                        "[WANT part_vogverzocht: $part_vogingediend IN EVENT_FISCAL_YEAR]");
          }
          if ($vogingediend_infiscalyear_ditevent == 1)   {
            $new_ditpart_vogstatus        = 'ingediend';
            $new_vogaanvraag_actstatus  = 'Completed';
            wachthond($extdebug,2,  "STATUS VOG_AANVRAAG VAN $new_vogaanvraag_actstatus NAAR Completed", 
                        "[WANT part_vogingediend: $part_vogingediend IN EVENT_FISCAL_YEAR]");
          }
          if ($vogontvangst_infiscalyear_ditevent == 1)   {
            $new_ditpart_vogstatus        = 'ontvangen';
            $new_vogaanvraag_actstatus  = 'Completed';
            wachthond($extdebug,2,  "STATUS VOG_AANVRAAG VAN $new_vogaanvraag_actstatus NAAR Completed",
                        "[WANT part_vogontvangst: $part_vogontvangst IN EVENT_FISCAL_YEAR]");
          }
          if ($partvogdatum_infiscalyear_ditevent == 1)   {
            $new_ditpart_vogstatus        = 'ontvangen';
            $new_vogaanvraag_actstatus  = 'Completed';             
            wachthond($extdebug,2,  "STATUS VOG AANVRAAG VAN $new_vogaanvraag_actstatus NAAR Completed",
                        "[WANT part_vogdatum: $part_vogdatum IN EVENT_FISCAL_YEAR]");
          }

        } elseif (empty($part_vogverzocht))         {
            $new_ditpart_vogstatus  = 'klaarzetten';
        }

      } elseif ($new_ditpart_vognodig == 'noggoed' AND $cont_voglaatste) {
            $new_ditpart_vogstatus      = 'noggoed';
            $new_vogaanvraag_actstatus  = 'Not Required';
      }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 17.4 b COPY VOGSTATUS DITEVENT > DITJAAR INDIEN EVENT DITJAAR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        if ($diteventleidyes == 1 OR $diteventleidstf == 1) {

            wachthond($extdebug,2, "2 new_ditpart_vognodig",        $new_ditpart_vognodig);
            wachthond($extdebug,2, "2 new_ditpart_vogstatus",       $new_ditpart_vogstatus);
            wachthond($extdebug,2, "2 new_vogaanvraag_actstatus",   $new_vogaanvraag_actstatus);
            wachthond($extdebug,2, "2 new_vogaanvraag_actprio",     $new_vogaanvraag_actprio);
        }

        if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

        wachthond($extdebug,2,  "VOGSTATUS ($new_ditjaar_vogstatus) UIT DITEVENT GEKOPIEERD NAAR DITJAAR", "[WANT EVENT IS IN DITJAAR]");

        $new_ditjaar_vogstatus      = $new_ditpart_vogstatus;
        $new_vogaanvraag_actstatus  = $new_vogaanvraag_actstatus;
        $new_vogaanvraag_actprio    = $new_vogaanvraag_actprio; 

        wachthond($extdebug,2, "2 new_ditjaar_vognodig",            $new_ditjaar_vognodig);
        wachthond($extdebug,2, "2 new_ditjaar_vogstatus",           $new_ditjaar_vogstatus);
        wachthond($extdebug,2, "2 new_vogaanvraag_actstatus",       $new_vogaanvraag_actstatus);
        wachthond($extdebug,2, "2 new_vogaanvraag_actprio",         $new_vogaanvraag_actprio);

    } else {

        wachthond($extdebug,2, 'ditjaareventleidyes',   $ditjaareventleidyes);
        wachthond($extdebug,2, 'ditjaareventleidstf',   $ditjaareventleidstf);

        wachthond($extdebug,2,  "VOGSTATUS UIT DITEVENT NIET KOPIEREN NAAR DITJAAR WANT EVENT =! DITJAAR");
    }

    wachthond($extdebug,2, "########################################################################");
    wachthond($extdebug,1, "### INT 17.5 a BEPAAL NEW STATUS ACTIVITEIT VOG ONTVANGST VOOR $displayname", "[groupID: $groupID]");
    wachthond($extdebug,2, "########################################################################");

    $new_vogontvangst_actstatus = 'Available';  // DEFAULT TO AVAILABLE (CONCEPT)
    $new_vogontvangst_actprio   = 'Normaal';    // DEFAULT TO NORMAL

    $vogontvangst_infiscalyear_ditevent = infiscalyear($part_vogontvangst,  $ditevent_event_start, 'vogontvangst',  'ditevent') ?? 0;
    $vogdatum_infiscalyear_ditevent     = infiscalyear($part_vogdatum,      $ditevent_event_start, 'vogdatum',      'ditevent') ?? 0;

    wachthond($extdebug,4, "1 ditevent_part_vogdatum",              $ditevent_part_vogdatum);
    wachthond($extdebug,4, "1 part_vogontvangst",                   $part_vogontvangst);
    wachthond($extdebug,3, "- vogontvangst_infiscalyear_ditevent",  "$vogontvangst_infiscalyear_ditevent\t[part_vogontvangst: $part_vogontvangst]");
    wachthond($extdebug,3, "- vogdatum_infiscalyear_ditevent",      "$vogdatum_infiscalyear_ditevent\t[part_vogdatum: $part_vogdatum]");

    wachthond($extdebug,2, "1 new_ditpart_vognodig",                $new_ditpart_vognodig);
    wachthond($extdebug,2, "1 new_ditpart_vogstatus",               $new_ditpart_vogstatus);
    wachthond($extdebug,2, "1 new_vogontvangst_actstatus",          $new_vogontvangst_actstatus);
    wachthond($extdebug,2, "1 new_vogontvangst_actprio",            $new_vogontvangst_actprio);

    if (in_array($new_ditjaar_vognodig, array("noggoed"))) {

        $new_vogontvangst_actstatus   = 'Not Required';

    } elseif ($part_vogingediend) {

        $diffsince_vogaanvraag  = NULL;
        $dayssince_vogaanvraag  = NULL;
        $diffsince_vogaanvraag  = date_diff(date_create($part_vogingediend),date_create($today_datetime));
        $dayssince_vogaanvraag  = $diffsince_vogaanvraag->format('%a');         
        wachthond($extdebug,3, "- dayssince_vogaanvraag",   $dayssince_vogaanvraag);

        if ($dayssince_vogaanvraag >= 0  AND $dayssince_vogaanvraag < 21)   { $new_vogontvangst_actstatus = "Pending";      } // AFWACHTING
        if ($dayssince_vogaanvraag >= 21 AND $dayssince_vogaanvraag < 35)   { $new_vogontvangst_actstatus = "Left Message"; } // HERINNERD
        if ($dayssince_vogaanvraag >= 35)                                   { $new_vogontvangst_actstatus = "Unreachable";  } // ONBEREIKBAAR
        if ($dayssince_vogaanvraag >= 270)                                  { $new_vogontvangst_actstatus = "Bounced";      } // GEFAALD/GEBOUNCED

        if (date_bigger($today_datetime, $ditevent_event_einde) == 1 AND $new_vogontvangst_actstatus != "Completed") {
            // $new_vogontvangst_actstatus = "Failed";
            wachthond($extdebug,2, "activity vogaanvraag > status failed want event inmiddels voorbij");        
        }

        // if ($dayssince_vogverzoek  >= 21 AND $new_vogontvangst_actstatus == "Pending") { $new_vogontvangst_actstatus = "Left Message"; }
        // Als aanvraag Unreachable of Bounced is -> schedule dan alsnog een reminder rond geplande ontvangstdatum
        
        // Maak status Activiteit ONTVANGST = Available als status AANVRAAG nog niet Completed is (civirules proof?)        
        // LET OP: DE VOLGENDE 1 REGEL NOG EVEN HEEL ERG GOED DUBBELCHECKEN!!!
        if ($new_vogaanvraag_actstatus != "Completed")  {
            $new_vogontvangst_actstatus = "Available";
        } 

        // als part_vogdatum binnen huidige fiscal year valt kan activity op completed
        // LET OP: DE VOLGENDE 1 REGEL NOG EVEN HEEL ERG GOED DUBBELCHECKEN!!!
//        if (infiscalyear($part_vogdatum,$ditevent_event_start,'part_vogdatum','ditevent') == 1) {
        if ($vogdatum_infiscalyear_ditevent == 1) {
          $new_vogontvangst_actstatus   = "Completed";
          $new_ditpart_vogstatus        = 'ontvangen';
          wachthond($extdebug,2, "PRIMA! part_vogdatum binnen fiscal year van dit event", "DUS: activity vogontvangst > status Completed");
        }

        if ($new_vogontvangst_actstatus == "Pending")       { $new_vogontvangst_actprio = 'Laag';   } // AFWACHTING
        if ($new_vogontvangst_actstatus == "Left Message")  { $new_vogontvangst_actprio = 'Normaal';}   // HERINNERD
        if ($new_vogontvangst_actstatus == "Unreachable")   { $new_vogontvangst_actprio = 'Urgent'; }   // ONBEREIKBAAR
        if ($new_vogontvangst_actstatus == "No_show")       { $new_vogontvangst_actprio = 'Urgent'; }   // VERLOPEN     
        if ($new_vogontvangst_actstatus == "Bounced")       { $new_vogontvangst_actprio = 'Urgent'; }   // GEFAALD/GEBOUNCED
      }

      wachthond($extdebug,2, "########################################################################");
      wachthond($extdebug,1, "### INT 17.5 b COPY VOGSTATUS DITEVENT > DITJAAR INDIEN EVENT DITJAAR $displayname", "[groupID: $groupID]");
      wachthond($extdebug,2, "########################################################################");

      if ($diteventleidyes == 1 OR $diteventleidstf == 1) {

        wachthond($extdebug,2, "2 new_ditpart_vognodig",        $new_ditpart_vognodig);
        wachthond($extdebug,2, "2 new_ditpart_vogstatus",       $new_ditpart_vogstatus);
        wachthond($extdebug,2, "2 new_vogontvangst_actstatus",  $new_vogontvangst_actstatus);
        wachthond($extdebug,2, "2 new_vogontvangst_actprio",    $new_vogontvangst_actprio);
      }

      if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

        wachthond($extdebug,2,  "VOGSTATUS ($new_ditjaar_vogstatus) UIT DITEVENT GEKOPIEERD NAAR DITJAAR", "[WANT EVENT IS IN DITJAAR]");

        $new_ditjaar_vogstatus                  = $new_ditpart_vogstatus;
        $new_vogontvangst_actstatus             = $new_vogontvangst_actstatus;
        $new_vogontvangst_actprio               = $new_vogontvangst_actprio;  

        wachthond($extdebug,2, "2 new_ditjaar_vognodig",                $new_ditjaar_vognodig);
        wachthond($extdebug,2, "2 new_ditjaar_vogstatus",               $new_ditjaar_vogstatus);
        wachthond($extdebug,2, "2 new_vogontvangst_actstatus",          $new_vogontvangst_actstatus);
        wachthond($extdebug,2, "2 new_vogontvangst_actprio",            $new_vogontvangst_actprio);

      }

    } else {

        wachthond($extdebug,1, 'extvog',                $extvog);
        wachthond($extdebug,1, 'extact',                $extact);
        wachthond($extdebug,1, 'ditjaarleidyes',        $ditjaarleidyes);
        wachthond($extdebug,1, 'diteventleidyes',       $diteventleidyes);
        wachthond($extdebug,1, 'diteventstfyes',        $diteventstfyes);
        wachthond($extdebug,1, 'ditjaareventleidyes',   $ditjaareventleidyes);

        wachthond($extdebug,1, "14.X SKIPPED BEPAAL NIEUWE STATUS ONDERDELEN INTAKE [VOG]");
    }

    if ($extref == 1 AND $extvog == 1 AND $extact == 1 AND $ditjaareventleidyes == 1) { 

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 17.6 BEPAAL DE STATUS VAN INT / REF / VOG VOOR $displayname", "[groupID: $groupID]");
        wachthond($extdebug,2, "########################################################################");

        $intakestatusinttodo    = 0;
        $intakestatusnawtodo    = 0;
        $intakestatusbiotodo    = 0;
        $intakestatusreftodo    = 0;
        $intakestatusvogtodo    = 0;

        $intakestatusintdone    = 0;
        $intakestatusnawdone    = 0;
        $intakestatusbiodone    = 0;
        $intakestatusrefdone    = 0;
        $intakestatusvogdone    = 0;

        $intakeintnodig         = 0;
        $intakenawnodig         = 0;
        $intakebionodig         = 0;
        $intakerefnodig         = 0;
        $intakevognodig         = 0;

        wachthond($extdebug,3, "new_ditjaar_intstatus", $new_ditjaar_intstatus);
        wachthond($extdebug,3, "new_ditjaar_nawstatus", $new_ditjaar_nawstatus);
        wachthond($extdebug,3, "new_ditjaar_biostatus", $new_ditjaar_biostatus);
        wachthond($extdebug,3, "new_ditjaar_refstatus", $new_ditjaar_refstatus);
        wachthond($extdebug,3, "new_ditjaar_vogstatus", $new_ditjaar_vogstatus);

        if (in_array($new_ditjaar_nawnodig,array("eerstex","elkjaar","opnieuw","inhaal")))  { $intakenawnodig = 1; }
        if (in_array($new_ditjaar_bionodig,array("eerstex","elkjaar","opnieuw","inhaal")))  { $intakebionodig = 1; }
        if (in_array($new_ditjaar_refnodig,array("eerstex","elkjaar","opnieuw","inhaal")))  { $intakerefnodig = 1; }
        if (in_array($new_ditjaar_vognodig,array("eerstex","elkjaar","opnieuw","inhaal")))  { $intakevognodig = 1; }

        wachthond($extdebug,3, "################################################");

        if (in_array($new_ditjaar_nawnodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND
           !in_array($new_ditjaar_nawstatus, array("noggoed", "bijgewerkt")))      {
            $intakestatusnawtodo  = 1;
        }
        if (in_array($new_ditjaar_bionodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND
           !in_array($new_ditjaar_biostatus, array("noggoed", "bijgewerkt")))      {
            $intakestatusbiotodo  = 1;
        }
        if (in_array($new_ditjaar_refnodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND 
           !in_array($new_ditjaar_refstatus, array("noggoed", "vragen", "ontvangen"))) {
            $intakestatusreftodo  = 1;
        }
        if (in_array($new_ditjaar_vognodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND
           !in_array($new_ditjaar_vogstatus, array("noggoed", "ontvangen")))       {
            $intakestatusvogtodo  = 1;
        }

        wachthond($extdebug,3, "intakestatusnawtodo", $intakestatusnawtodo);
        wachthond($extdebug,3, "intakestatusbiotodo", $intakestatusbiotodo);
        wachthond($extdebug,3, "intakestatusreftodo", $intakestatusreftodo);
        wachthond($extdebug,3, "intakestatusvogtodo", $intakestatusvogtodo);

        wachthond($extdebug,3, "################################################");

        if (in_array($new_ditjaar_nawnodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND
            in_array($new_ditjaar_nawstatus, array("noggoed", "bijgewerkt")))           {
            $intakestatusnawdone  = 1;
        }
        if (in_array($new_ditjaar_bionodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND
            in_array($new_ditjaar_biostatus, array("noggoed", "bijgewerkt")))           {
            $intakestatusbiodone  = 1;
        }
        if (in_array($new_ditjaar_refnodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND 
            in_array($new_ditjaar_refstatus, array("noggoed", "vragen", "ontvangen")))  {   // M61: wat te doen met status: bekend
            $intakestatusrefdone  = 1;
        }
        if (in_array($new_ditjaar_vognodig,array("eerstex","elkjaar","opnieuw","inhaal")) AND
            in_array($new_ditjaar_vogstatus, array("noggoed", "ontvangen")))            {   // M61: wat te doen met status: ingediend
            $intakestatusvogdone  = 1;
        }

        wachthond($extdebug,3, "intakestatusnawdone", $intakestatusnawdone);
        wachthond($extdebug,3, "intakestatusbiodone", $intakestatusbiodone);
        wachthond($extdebug,3, "intakestatusrefdone", $intakestatusrefdone);
        wachthond($extdebug,3, "intakestatusvogdone", $intakestatusvogdone);

        wachthond($extdebug,3, "################################################");

        $intakestatusnodig  = $intakebionodig       + $intakebionodig       + $intakerefnodig       + $intakevognodig;
        $intakestatustodo   = $intakestatusnawtodo  + $intakestatusbiotodo  + $intakestatusreftodo  + $intakestatusvogtodo;
        $intakestatusdone   = $intakestatusnawdone  + $intakestatusbiodone  + $intakestatusrefdone  + $intakestatusvogdone;

        wachthond($extdebug,3, "intakestatusnodig",   $intakestatusnodig);
        wachthond($extdebug,3, "intakestatustodo",    $intakestatustodo);
        wachthond($extdebug,3, "intakestatusrefdone", $intakestatusrefdone);

        wachthond($extdebug,3, "################################################");

        ###########################################################################################
        // BEPAAL DE NIEUWE WAARDE VAN INT STATUS
        ###########################################################################################

        if (in_array($new_ditjaar_intnodig,array("eerstex","elkjaar","opnieuw","inhaal"))) {

            if ($intakestatustodo < $intakestatusnodig AND $intakestatustodo > 0) {
                $new_ditjaar_intstatus    = 'gedeeltelijk';
            }
            if ($intakestatusdone == 0 AND in_array($new_ditjaar_vogstatus, array("verzocht"))) {
                $new_ditjaar_intstatus    = 'nognix';
            }
            //        if ($intakestatusdone == $intakestatusnodig) {
            //          $new_ditjaar_intstatus    = 'compleet';
            //        }
            if ($intakestatusdone == $intakestatusnodig AND in_array($new_ditjaar_refstatus, array("gevraagd"))) {
                $new_ditjaar_intstatus    = 'afwachting';
            }
            if (in_array($new_ditjaar_vogstatus, array("klaarzetten"))) {
                $new_ditjaar_intstatus    = 'klaarzetten';
            }

        } elseif (in_array($new_ditjaar_intnodig,array("noggoed"))) {
            $new_ditjaar_intstatus    = 'compleet';     
        } else  {
            $new_ditjaar_intstatus    = 'onbekend';
        }

        // IF DIT EVENT OOK DIT JAAR PLAATS DAN OOK IN PART
        if ($ditevent_infiscalyear_ditjaar == 1) {
            $new_ditpart_intstatus = $new_ditjaar_intstatus;
        }

        wachthond($extdebug,2, "new_ditjaar_intstatus", $new_ditjaar_intstatus);
        wachthond($extdebug,2, "new_ditpart_intstatus", $new_ditpart_intstatus);

    } else {
        wachthond($extdebug,1, "extref",        $extref);
        wachthond($extdebug,1, "extvog",        $extvog);
        wachthond($extdebug,1, 'ditjaareventleidyes', $ditjaareventleidyes);
        wachthond($extdebug,1, "14.5 SKIPPED BEPAAL DE STATUS VAN INT / REF / VOG");
    }

    if ($extref == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) {

        wachthond($extdebug,3, "########################################################################");
        wachthond($extdebug,1, "### INT 17.8 RETREIVE RELATED REF EN ASSIGN DIE NAAR PART RECORD $displayname", "[groupID: $groupID] [op: $op]");
        wachthond($extdebug,3, "########################################################################");

        $activity_id            = $result_activity_get[0]['id']                         ?? NULL;
        $activity_status        = $result_activity_get[0]['status_id']                  ?? NULL;
        $activity_status_name   = $result_activity_get[0]['status_id:name']             ?? NULL;
        $activity_datum         = $result_activity_get[0]['activity_date_time']         ?? NULL;

        $activity_kampkort      = $result_activity_get[0]['ACT_ALG.kampkort']           ?? NULL;
        $activity_kampfunctie   = $result_activity_get[0]['ACT_ALG.kampfunctie']        ?? NULL;
        $activity_kampstart     = $result_activity_get[0]['ACT_ALG.kampstart']          ?? NULL;
        $activity_kampjaar      = $result_activity_get[0]['ACT_ALG.kampjaar']           ?? NULL;

        $referentie_aanvrager   = $result_activity_get[0]['ACT_REF.aanvrager_naam']     ?? NULL;
        $referentie_relid       = $result_activity_get[0]['ACT_REF.relid']              ?? NULL;
        $referentie_refid       = $result_activity_get[0]['ACT_REF.referentie_cid']     ?? NULL;
        $referentie_naam        = $result_activity_get[0]['ACT_REF.referentie_naam']    ?? NULL;

        $vog_nodig              = $result_activity_get[0]['ACT_VOG.vog_nodig']          ?? NULL;
        $vog_datum_verzoek      = $result_activity_get[0]['ACT_VOG.datum_verzoek']      ?? NULL;
        $vog_datum_reminder     = $result_activity_get[0]['ACT_VOG.datum_reminder']     ?? NULL;
        $vog_datum_aanvraag     = $result_activity_get[0]['ACT_VOG.datum_aanvraag']     ?? NULL;
        $vog_datum_ontvangst    = $result_activity_get[0]['ACT_VOG.datum_ontvangst']    ?? NULL;

        $params_ref_get = [
            'checkPermissions' => FALSE,
            'debug' => $apidebug,
            'select' => [
            'row_count',          
                'id',
                'contact_id_b',
                'contact_id_b.display_name',
                'contact_id_b.first_name',
                'contact_id_b.middle_name',
                'contact_id_b.last_name',
                'contact_id_b.gender_id',
                'start_date', 
                'end_date',
     
                'ref_aanvrager.aanvrager_naam',
                'ref_aanvrager.aanvrager_functie',
                'ref_aanvrager.kamp_partid',
                'ref_aanvrager.kamp_cid',

                'ref_aanvrager.kamp_naam',
                'ref_aanvrager.kamp_eid',
                'ref_aanvrager.kamp_datum',

                'ref_aanvrager.referentie_relatie', 
                'ref_aanvrager.referentie_motivatie',
                'ref_aanvrager.referentie_toestemming',
                'ref_aanvrager.referentie_verzoek',
                'ref_aanvrager.datum_verzoek',
                'ref_feedback.datum_feedback',
                'ref_feedback.Bezwaar',
            ],    
            'where' => [
                ['relationship_type_id','=', 16],
                ['contact_id_a',        '=', $contact_id],
    //          ['start_date',          '=', 'this.fiscal_year'],
                ['end_date',            '=', 'this.fiscal_year'],
    //          ['ref_aanvrager.kamp_datum','=', 'this.fiscal_year'],  // M61 TODO: dit veld wordt nog niet altijd goed gevuld
    //          ['is_active',           '=', TRUE],
            ],
        ];

        wachthond($extdebug,7, 'params_ref_get',            $params_ref_get);
        $result_ref_get = civicrm_api4('Relationship','get',$params_ref_get);
        wachthond($extdebug,9, 'result_ref_get',            $result_ref_get);
        $result_ref_get_refcount =                          $result_ref_get->countMatched();
        wachthond($extdebug,9, 'result_ref_get_refcount',   $result_ref_get_refcount);

        if ($result_ref_get_refcount == 1 AND $result_ref_get[0]) {

            $referentie_relid       = $result_ref_get[0]['id'] ?? NULL;
            $referentie_cid         = $result_ref_get[0]['contact_id_b'] ?? NULL;
            $referentie_name        = $result_ref_get[0]['contact_id_b.display_name'] ?? NULL;
            $referentie_fn          = $result_ref_get[0]['contact_id_b.first_name'] ?? NULL;
            $referentie_mn          = $result_ref_get[0]['contact_id_b.middle_name'] ?? NULL;
            $referentie_ln          = $result_ref_get[0]['contact_id_b.last_name'] ?? NULL;
            $referentie_relatie     = trim($result_ref_get[0]['ref_aanvrager.referentie_relatie']);
            $referentie_motivatie   = trim($result_ref_get[0]['ref_aanvrager.referentie_motivatie']);
            $referentie_geslacht    = trim($result_ref_get[0]['contact_id_b.gender_id']);
            $referentie_start       = $result_ref_get[0]['start_date'] ?? NULL;
            $referentie_einde       = $result_ref_get[0]['end_date'] ?? NULL;   
            $referentie_kamp        = $result_ref_get[0]['kamp_naam'] ?? NULL;
            $referentie_kampid      = $result_ref_get[0]['kamp_eid'] ?? NULL;
            $referentie_kampstart   = $result_ref_get[0]['kamp_datum'] ?? NULL;

            $referentie_gevraagd    = $result_ref_get[0]['ref_aanvrager.datum_verzoek'] ?? NULL;
            $referentie_feedback    = $result_ref_get[0]['ref_feedback.datum_feedback'] ?? NULL;
            $referentie_bezwaar     = $result_ref_get[0]['ref_feedback.Bezwaar'] ?? NULL;

            $referentie_toestemming = $result_ref_get[0]['ref_aanvrager.referentie_toestemming'] ?? NULL;
            $ref_toestemming_array  = $result_ref_get[0]['ref_aanvrager.referentie_toestemming'] ?? NULL;

            if ($ref_toestemming_array) {
                arsort($ref_toestemming_array); // M61 not sure if this sort works  
                $ref_toestemming    = implode('', $ref_toestemming_array);
            } else {
                $ref_toestemming_array  = [];
                $ref_toestemming    = NULL;
            }

            if (empty($ref_toestemming_array))  { $ref_toestemming_array = []; }

            $ref_toestemming_array  = array_unique($ref_toestemming_array);
            asort($ref_toestemming_array);
            $ref_toestemming    = implode('', $ref_toestemming_array);
            $ref_toestemming    = ''.$ref_toestemming.'';

            $ref_toestemming_nr   = count(array_filter($ref_toestemming_array));

            wachthond($extdebug,4, 'ref_toestemming_array',   $ref_toestemming_array);
            wachthond($extdebug,4, 'ref_toestemming_nr',    $ref_toestemming_nr);
            wachthond($extdebug,4, 'ref_toestemming',       $ref_toestemming);
            wachthond($extdebug,4, 'referentie_toestemming',  $referentie_toestemming);

            // M61 BEDOELD OM TIJDELIJK INFO VAN REL NAAR PART TE KRIJGEN INDIEN NODIG
            if ($referentie_gevraagd AND empty($part_refgevraagd)) {
                $part_refgevraagd = $referentie_gevraagd;
                wachthond($extdebug,3, 'refverzocht_uit_rel',     $refverzocht);
            }
            if ($part_refgevraagd    AND empty($referentie_gevraagd)) {
                $referentie_gevraagd = $part_refgevraagd;
                wachthond($extdebug,3, 'refverzocht_uit_part',    $refverzocht);
            }
            if ($referentie_feedback AND empty($refingevuld)) {
                #$refingevuld = $referentie_feedback;
                wachthond($extdebug,3, 'refverzocht_uit_rel',     $refingevuld);
            }

            $part_refnaam       = $referentie_name;   // dit kan handiger
          
            wachthond($extdebug,3, 'referentie_relid',    $referentie_relid);
            wachthond($extdebug,3, 'referentie_cid',    $referentie_cid);
            wachthond($extdebug,3, 'referentie_name',     $referentie_name);

            wachthond($extdebug,3, 'referentie_fn',     $referentie_fn);
            wachthond($extdebug,3, 'referentie_mn',     $referentie_mn);
            wachthond($extdebug,3, 'referentie_ln',     $referentie_ln);

            wachthond($extdebug,3, 'referentie_geslacht',   $referentie_geslacht);
            wachthond($extdebug,3, 'referentie_relatie',  $referentie_relatie);
            wachthond($extdebug,3, 'referentie_motivatie',  $referentie_motivatie);
            wachthond($extdebug,3, 'referentie_toestemming',$referentie_toestemming);

            wachthond($extdebug,3, 'referentie_start',    $referentie_start);
            wachthond($extdebug,3, 'referentie_einde',    $referentie_einde);
            wachthond($extdebug,3, 'referentie_gevraagd',   $referentie_gevraagd);
            wachthond($extdebug,3, 'referentie_feedback',   $referentie_feedback);
            wachthond($extdebug,3, 'referentie_bezwaar',  $referentie_bezwaar);

            ##########################################################################################
            // GET PHONE VAN REFERENTIE
            ##########################################################################################
            $params_refcontact = [
                'checkPermissions' => FALSE,
                'debug' => $apidebug,       
                'select' => [
                    'display_name', 'first_name', 'image_URL',
                ],
                'where' => [
                    ['id', 'IN', [$referentie_cid]],
                ],
            ];
            $params_refphone = [
            'checkPermissions' => FALSE,
            'debug' => $apidebug,       
                'select' => [
                    'phone',
                ],
                'where' => [
                    ['contact_id',      'IN', [$referentie_cid]],
                    ['location_type_id',  '=', 1],
                    ['phone_type_id',     '=', 2],
                ],
            ];
            wachthond($extdebug,7, 'params_refcontact',     $params_refcontact);
            wachthond($extdebug,7, 'params_refphone  ',     $params_refphone);
            $result_refcontact  = civicrm_api4('Contact','get', $params_refcontact);
            $result_refphone  = civicrm_api4('Phone',  'get', $params_refphone);
            wachthond($extdebug,9, 'result_refphone',       $result_refphone);

            if (isset($referentie_cid)) {
                $referentie_phone      = $result_refphone[0]['phone'] ?? NULL;
                wachthond($extdebug,2, 'referentie_phone', $referentie_phone);
            } else {
                $referentie_phone      = "";
            }

            wachthond($extdebug,3, "########################################################################");
            wachthond($extdebug,1, "### INT 17.9 UPDATE RELATIONSHIP MET OA. TELEFOONVELDEN VOOR $displayname", "[groupID: $groupID] [op: $op]");
            wachthond($extdebug,3, "########################################################################");

            $params_ref_update = [
                'checkPermissions' => FALSE,
                'debug' => $apidebug,
                'where' => [
                    ['id',        '=', $referentie_relid],
                    ['contact_id_b',  '=', $referentie_cid],
                ],
                'values' => [
                    'is_active'                             => TRUE,
                    'start_date'                            => $ditevent_fiscalyear_start,
                    'end_date'                              => $ditevent_fiscalyear_einde,
                    'ref_aanvrager.kamp_eid'                => $ditevent_part_eventid,
                    'ref_aanvrager.kamp_naam'               => $eventkamp_kampkort_cap,
                    'ref_aanvrager.kamp_kort'               => $eventkamp_kampkort_low,
                    'ref_aanvrager.kamp_datum'              => $eventkamp_event_start,
                    'ref_aanvrager.aanvrager_naam'          => $displayname,
                    'ref_aanvrager.aanvrager_functie'       => $ditevent_part_functie,
                    'ref_aanvrager.aanvrager_partid'        => $ditevent_part_id,
                    'ref_aanvrager.referentie_naam'         => $referentie_name,
                    'ref_aanvrager.referentie_relatie'      => $referentie_relatie,
                    'ref_aanvrager.referentie_motivatie'    => $referentie_motivatie,
                    'ref_aanvrager.referentie_toestemming'  => $referentie_toestemming,
                    'ref_aanvrager.referentie_verzoek'      => $referentie_gevraagd,
                    'ref_feedback.referentie_naam'          => $referentie_name,
                    'ref_feedback.referentie_telefoon'      => $referentie_phone,
                ],
            ];

            wachthond($extdebug,7, 'params_ref_update',         $params_ref_update);
            $result_ref_update = civicrm_api4('Relationship', 'update', $params_ref_update);
            wachthond($extdebug,9, 'result_ref_update',         $result_ref_update);

        } elseif ($result_ref_get_refcount > 1) {

            wachthond($extdebug,2, 'result_ref_get',          $result_ref_get);
            wachthond($extdebug,1, "### INT CONFLICT >1 GELDIGE REFERENTIE GEVONDEN VOOR DIT JAAR ###", "[aantal: $result_ref_get_refcount]");

        } else {
          wachthond($extdebug,1, "### INT ERROR! GEEN GELDIGE REFERENTIE GEVONDEN VOOR DIT JAAR ###", "[aantal: $result_ref_get_refcount]");
        }
    }

    if ($extref == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) {

        wachthond($extdebug,1, "########################################################################");
        wachthond($extdebug,1, "### INT 18.X UPDATE ACTIVITIES REF & VOG VOOR $displayname", "[groupID: $groupID]");

        $activity_array = array(
            'displayname'               => $displayname,
            'contact_id'                => $contact_id,
            'activity_source'           => 1, 
            'activity_target'           => $contact_id,
            'activity_assignee'         => $related_hoofdleiding_id,
            'activity_date_time'        => $today_datetime,
            'activity_status_name'      => 'Available',     // initial status concept
            'activity_prioriteit'       => 'Normaal',
        );

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 18.1 UPDATE ACTIVITY REF PERSOON $displayname");
        wachthond($extdebug,2, "########################################################################");

        if ($refpersoon_activity_id AND $new_refpersoon_actstatus) {

            $intake_array = array(
                'ref_nodig'                 => $new_ditjaar_refnodig,
                'ref_datum_persoon'         => $part_refpersoon,
                'ref_datum_gevraagd'        => $part_refgevraagd,
                'ref_datum_feedback'        => $part_reffeedback,
                'ref_datum_bezwaar'         => $part_refbezwaar,

                'ref_aanvrager_naam'        => $displayname,
                'ref_aanvrager_functie'     => $ditevent_leid_functie,
                'ref_aanvrager_pid'         => $ditevent_part_id,
                'ref_aanvrager_cid'         => $contact_id,

                'ref_rel_id'                => $referentie_relid,
                'ref_referentie_cid'        => $referentie_cid,
                'ref_referentie_naam'       => $referentie_name,
                'ref_referentie_voornaam'   => $referentie_fn,
                'ref_referentie_telefoon'   => $referentie_phone,
            );

            $activity_array['activity_id']          = $refpersoon_activity_id;
            $activity_array['activity_type_id']     = 139;
            $activity_array['activity_type_naam']   = 'ref_persoon';
            $activity_array['activity_subject']     = 'REF persoon doorgegeven';
            $activity_array['activity_status_name'] = $new_refpersoon_actstatus;
            $activity_array['activity_prioriteit']  = $new_refpersoon_actprio;

            $intake_activity_update = intake_activity_update($contact_id, $activity_array, $event_array, $intake_array);
            wachthond($extdebug,3, "intake_activity_update",            "[NEW ACTID: $intake_activity_update]");

        } else {
            wachthond($extdebug,1, 'activity_refpersoon_update',        "SKIPPED");
            wachthond($extdebug,2, "refpersoon_activity_id",            $refpersoon_activity_id);
            wachthond($extdebug,2, "part_refpersoon",                   $part_vogverzocht);
            wachthond($extdebug,2, "new_refpersoon_actstatus",          $new_refpersoon_actstatus);
            wachthond($extdebug,2, "new_refpersoon_actprio",            $new_refpersoon_actprio);

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,3, 'extvog',                            $extvog);
            wachthond($extdebug,3, 'extact',                            $extact);
            wachthond($extdebug,3, 'ditjaareventleidstf',               $ditjaareventleidstf);
            wachthond($extdebug,3, 'ditjaareventleidyes',               $ditjaareventleidyes);
            wachthond($extdebug,3, 'profilepartleidmax',                $profilepartleidmax); 
        }

        wachthond($extdebug,2, "########################################################################");
        wachthond($extdebug,1, "### INT 18.1 UPDATE ACTIVITY REF VERZOEK $displayname");
        wachthond($extdebug,2, "########################################################################");

        if ($refverzoek_activity_id AND $new_new_refverzoek_actstatus) {

            $intake_array = array(
                'ref_nodig'                 => $new_ditjaar_refnodig,
                'ref_datum_verzoek'         => $part_refverzoek,
                'ref_datum_gevraagd'        => $part_refgevraagd,
                'ref_datum_feedback'        => $part_reffeedback,
                'ref_datum_bezwaar'         => $part_refbezwaar,

                'ref_aanvrager_naam'        => $displayname,
                'ref_aanvrager_functie'     => $ditevent_leid_functie,
                'ref_aanvrager_pid'         => $ditevent_part_id,
                'ref_aanvrager_cid'         => $contact_id,

                'ref_rel_id'                => $referentie_relid,
                'ref_referentie_cid'        => $referentie_cid,
                'ref_referentie_naam'       => $referentie_name,
                'ref_referentie_voornaam'   => $referentie_fn,
                'ref_referentie_telefoon'   => $referentie_phone,
            );

            $activity_array['activity_id']          = $refverzoek_activity_id;
            $activity_array['activity_type_id']     = 117;
            $activity_array['activity_type_naam']   = 'ref_feedback';
            $activity_array['activity_subject']     = 'REF feedback doorgegeven';
            $activity_array['activity_status_name'] = $new_refverzoek_actstatus;
            $activity_array['activity_prioriteit']  = $new_refverzoek_actprio;

            $intake_activity_update = intake_activity_update($contact_id, $activity_array, $event_array, $intake_array);
            wachthond($extdebug,3, "intake_activity_update",            "[NEW ACTID: $intake_activity_update]");

        } else {
            wachthond($extdebug,1, 'activity_refverzoek_update',        "SKIPPED");
            wachthond($extdebug,2, "refverzoek_activity_id",            $refverzoek_activity_id);
            wachthond($extdebug,2, "part_refverzoek",                   $part_vogverzocht);
            wachthond($extdebug,2, "new_refverzoek_actstatus",          $new_refverzoek_actstatus);
            wachthond($extdebug,2, "new_refverzoek_actprio",            $new_refverzoek_actprio);

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,3, 'extvog',                            $extvog);
            wachthond($extdebug,3, 'extact',                            $extact);
            wachthond($extdebug,3, 'ditjaareventleidstf',               $ditjaareventleidstf);
            wachthond($extdebug,3, 'ditjaareventleidyes',               $ditjaareventleidyes);
            wachthond($extdebug,3, 'profilepartleidmax',                $profilepartleidmax); 
        }
    }

        if ($extvog == 1 AND $extact == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1)) {

            wachthond($extdebug,2, "########################################################################");
            wachthond($extdebug,1, "### INT 18.3 UPDATE ACTIVITY VOG VERZOEK VOOR $displayname");
            wachthond($extdebug,2, "########################################################################");

            if ($vogverzoek_activity_id AND $new_vogverzoek_actstatus) {

                $intake_array = array(
                    'vog_nodig'                 => $new_ditpart_vognodig,
                    'vog_datum_verzoek'         => $part_vogverzocht,
                    'vog_datum_aanvraag'        => $part_vogingediend,
                    'vog_datum_ontvangst'       => $part_vogontvangst,
                );

                $activity_array['activity_id']          = $vogverzoek_activity_id;
                $activity_array['activity_type_id']     = 118;
                $activity_array['activity_type_naam']   = 'vog_verzoek';
                $activity_array['activity_subject']     = 'VOG aanvraag verzocht';
                $activity_array['activity_status_name'] = $new_vogverzoek_actstatus;
                $activity_array['activity_prioriteit']  = $new_vogverzoek_actprio;

                wachthond($extdebug,3, 'activity_array',                    $activity_array);
                wachthond($extdebug,3, 'event_array',                       $event_array);
                wachthond($extdebug,3, 'intake_array',                      $intake_array);

                $intake_activity_update = intake_activity_update($contact_id, $activity_array, $event_array, $intake_array);
                wachthond($extdebug,3, "intake_activity_update",            "[NEW ACTID: $intake_activity_update]");

            } else {
                wachthond($extdebug,1, 'activity_vogverzoek_update',        "SKIPPED");
                wachthond($extdebug,2, "vogverzoek_activity_id",            $vogverzoek_activity_id);
                wachthond($extdebug,2, "part_vogverzoek",                   $part_vogverzocht);
                wachthond($extdebug,2, "new_vogverzoek_actstatus",          $new_vogverzoek_actstatus);
                wachthond($extdebug,2, "new_vogverzoek_actprio",            $new_vogverzoek_actprio);       

                wachthond($extdebug,1, "########################################################################");
                wachthond($extdebug,3, 'extvog',                            $extvog);
                wachthond($extdebug,3, 'extact',                            $extact);
                wachthond($extdebug,3, 'ditjaareventleidstf',               $ditjaareventleidstf);
                wachthond($extdebug,3, 'ditjaareventleidyes',               $ditjaareventleidyes);
                wachthond($extdebug,3, 'profilepartleidmax',                $profilepartleidmax); 
            }

            wachthond($extdebug,2, "########################################################################");
            wachthond($extdebug,1, "### INT 18.4 UPDATE ACTIVITY VOG AANVRAAG VOOR $displayname");
            wachthond($extdebug,2, "########################################################################");

            if ($vogaanvraag_activity_id AND $new_vogaanvraag_actstatus) {

                $intake_array = array(
                    'vog_nodig'                 => $new_ditpart_vognodig,
                    'vog_datum_verzoek'         => $part_vogverzocht,
                    'vog_datum_aanvraag'        => $part_vogingediend,
                    'vog_datum_ontvangst'       => $part_vogontvangst,
                );

                $activity_array['activity_id']          = $vogaanvraag_activity_id;
                $activity_array['activity_type_id']     = 119;
                $activity_array['activity_type_naam']   = 'vog_aanvraag';
                $activity_array['activity_subject']     = 'VOG aanvraag gedaan';
                $activity_array['activity_status_name'] = $new_vogaanvraag_actstatus;
                $activity_array['activity_prioriteit']  = $new_vogaanvraag_actprio;

                $intake_activity_update = intake_activity_update($contact_id, $activity_array, $event_array, $intake_array);
                wachthond($extdebug,3, "intake_activity_update",            "[NEW ACTID: $intake_activity_update]");

            } else {
                wachthond($extdebug,1, 'activity_vogaanvraag_update',       "SKIPPED");
                wachthond($extdebug,2, "vogaanvraag_activity_id",           $vogaanvraag_activity_id);
                wachthond($extdebug,2, "part_vogaanvraag",                  $part_vogverzocht);
                wachthond($extdebug,2, "new_vogaanvraag_actstatus",         $new_vogaanvraag_actstatus);
                wachthond($extdebug,2, "new_vogaanvraag_actprio",           $new_vogaanvraag_actprio);       

                wachthond($extdebug,1, "########################################################################");
                wachthond($extdebug,3, 'extvog',                            $extvog);
                wachthond($extdebug,3, 'extact',                            $extact);
                wachthond($extdebug,3, 'ditjaareventleidstf',               $ditjaareventleidstf);
                wachthond($extdebug,3, 'ditjaareventleidyes',               $ditjaareventleidyes);
                wachthond($extdebug,3, 'profilepartleidmax',                $profilepartleidmax); 
            }

            wachthond($extdebug,2, "########################################################################");
            wachthond($extdebug,1, "### INT 18.5 UPDATE ACTIVITY VOG ONTVANGST VOOR $displayname");
            wachthond($extdebug,2, "########################################################################");

            if ($vogontvangst_activity_id AND $new_vogontvangst_actstatus) {

                $intake_array = array(
                    'vog_nodig'                 => $new_ditpart_vognodig,
                    'vog_datum_verzoek'         => $part_vogverzocht,
                    'vog_datum_aanvraag'        => $part_vogingediend,
                    'vog_datum_ontvangst'       => $part_vogontvangst,
                );

                $activity_array['activity_id']          = $vogontvangst_activity_id;
                $activity_array['activity_type_id']     = 120;
                $activity_array['activity_type_naam']   = 'vog_ontvangst';
                $activity_array['activity_subject']     = 'VOG ontvangst doorgegevens';
                $activity_array['activity_status_name'] = $new_vogontvangst_actstatus;
                $activity_array['activity_prioriteit']  = $new_vogontvangst_actprio;

                $intake_activity_update = intake_activity_update($contact_id, $activity_array, $event_array, $intake_array);
                wachthond($extdebug,3, "intake_activity_update",    "[NEW ACTID: $intake_activity_update]");

            } else {
                wachthond($extdebug,1, 'activity_vogontvangst_update',          "SKIPPED");
                wachthond($extdebug,2, "vogontvangst_activity_id",              $vogontvangst_activity_id);
                wachthond($extdebug,2, "part_vogontvangst",                     $part_vogverzocht);
                wachthond($extdebug,2, "new_vogontvangst_actstatus",            $new_vogontvangst_actstatus);
                wachthond($extdebug,2, "new_vogontvangst_actprio",              $new_vogontvangst_actprio);       

                wachthond($extdebug,1, "########################################################################");
                wachthond($extdebug,3, 'extvog',                                $extvog);
                wachthond($extdebug,3, 'extact',                                $extact);
                wachthond($extdebug,3, 'ditjaareventleidstf',                   $ditjaareventleidstf);
                wachthond($extdebug,3, 'ditjaareventleidyes',                   $ditjaareventleidyes);
                wachthond($extdebug,3, 'profilepartleidmax',                    $profilepartleidmax); 
            }

        } else {
            wachthond($extdebug,1, 'ditjaareventleidyes', $ditjaareventleidyes);
            wachthond($extdebug,1, "15.X SKIPPED 15.X UPDATE ACTIVITIES REF & VOG");
        }

        if ($extvog == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) {

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 18.6 DELETE ACTIVITIES INDIEN NODIG VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            ###########################################################################################
            ### 16. DELETE ACTIVITIES INDIEN: 1. aangemaakt maar VOG is nog goed 2. geen verzoek dit jaar 3. status niet completed
            ###########################################################################################
            if ($extvog == 1 AND (in_array($new_ditjaar_intnodig, array("noggoed")) OR $ditjaarleidnot == 1)) {

                wachthond($extdebug,3, "refpersoon_activity_id",    $refpersoon_activity_id);
                wachthond($extdebug,3, "refverzoek_activity_id",    $refverzoek_activity_id);
                wachthond($extdebug,3, "vogverzoek_activity_id",    $vogverzoek_activity_id);
                wachthond($extdebug,3, "vogaanvraag_activity_id",   $vogaanvraag_activity_id);
                wachthond($extdebug,3, "vogontvangst_activity_id",  $vogontvangst_activity_id);

                if ($refpersoon_activity_id   > 0 AND $refpersoon_activity_status   != 2) {
                    intake_activity_delete($contact_id, $refpersoon_activity_id);
                }           
                if ($refverzoek_activity_id   > 0 AND $refverzoek_activity_status   != 2) {
                    intake_activity_delete($contact_id, $refverzoek_activity_id);
                }           
                if ($vogverzoek_activity_id   > 0 AND $vogverzoek_activity_status   != 2) {
                    intake_activity_delete($contact_id, $vogverzoek_activity_id);
                }
                if ($vogaanvraag_activity_id  > 0 AND $vogaanvraag_activity_status  != 2) {
                    intake_activity_delete($contact_id, $vogaanvraag_activity_id);
                }
                if ($vogontvangst_activity_id > 0 AND $vogontvangst_activity_status != 2) {
                    intake_activity_delete($contact_id, $vogontvangst_activity_id);
                }

            } else {
                wachthond($extdebug,3, "ditjaarleidnot",          $ditjaarleidnot);
                wachthond($extdebug,3, "new_ditjaar_intnodig",    $new_ditjaar_intnodig);
            }
        }

        if (in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) {

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.X UPDATE PART DATA MBT INTAKE VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.1 UPDATE PART DATA MBT INTAKE NODIG VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            if ($ditjaarleidyes == 1 OR $ditjaarleidstf == 1) {

                if ($new_ditjaar_nawgecheckt)   { $params_contact['values']['INTAKE.NAW_gecheckt']  = $new_ditjaar_nawgecheckt; }
                if ($new_ditjaar_bioingevuld)   { $params_contact['values']['INTAKE.BIO_ingevuld']  = $new_ditjaar_bioingevuld; }
                if ($new_ditjaar_biogecheckt)   { $params_contact['values']['INTAKE.BIO_gecheckt']  = $new_ditjaar_biogecheckt; }

                if ($new_ditjaar_intnodig)      { $params_contact['values']['INTAKE.INT_nodig']     = $new_ditjaar_intnodig;} #TAB  NODIG INT
                if ($new_ditjaar_nawnodig)      { $params_contact['values']['INTAKE.NAW_nodig']     = $new_ditjaar_nawnodig;} #TAB  NODIG NAW
                if ($new_ditjaar_bionodig)      { $params_contact['values']['INTAKE.BIO_nodig']     = $new_ditjaar_bionodig;} #TAB  NODIG BIO
                if ($new_ditjaar_refnodig)      { $params_contact['values']['INTAKE.REF_nodig']     = $new_ditjaar_refnodig;} #TAB  NODIG VOG
                if ($new_ditjaar_vognodig)      { $params_contact['values']['INTAKE.VOG_nodig']     = $new_ditjaar_vognodig;} #TAB  NODIG REF

                wachthond($extdebug,1, "DOE  EEN UPDATE VAN 'DITJAAR  INTAKE NODIG'", $new_ditjaar_intnodig);
            } else {
                wachthond($extdebug,1, "DOE GEEN UPDATE VAN 'DITJAAR  INTAKE NODIG'", "ditjaarleidyes: $ditjaarleidyes");
            }

            if ($ditjaareventleidyes == 1 OR $ditjaareventleidstf == 1) {

                if ($new_ditpart_intnodig)      { $params_ditevent['values']['PART_LEID_INTERN.INT_nodig:name']  = $new_ditpart_intnodig;} #PART NODIG INT
                if ($new_ditpart_nawnodig)      { $params_ditevent['values']['PART_LEID_INTERN.NAW_nodig:name']  = $new_ditpart_nawnodig;} #PART NODIG NAW
                if ($new_ditpart_bionodig)      { $params_ditevent['values']['PART_LEID_INTERN.BIO_nodig:name']  = $new_ditpart_bionodig;} #PART NODIG BIO
                if ($new_ditpart_refnodig)      { $params_ditevent['values']['PART_LEID_INTERN.REF_nodig:name']  = $new_ditpart_refnodig;} #PART NODIG REF
                if ($new_ditpart_vognodig)      { $params_ditevent['values']['PART_LEID_INTERN.VOG_nodig:name']  = $new_ditpart_vognodig;} #PART NODIG VOG

                wachthond($extdebug,1, "DOE  EEN UPDATE VAN 'DITEVENT INTAKE NODIG'", $new_ditpart_intnodig);
            } else {
                wachthond($extdebug,1, "DOE GEEN UPDATE VAN 'DITEVENT INTAKE NODIG'", "ditjaareventleid: $ditjaareventleidyes");
            }

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.2 UPDATE PART DATA MBT INTAKE STATUS VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            wachthond($extdebug,2, "ditjaarleidyes",            $ditjaarleidyes);
            wachthond($extdebug,2, 'diteventleidyes',           $diteventleidyes);
            wachthond($extdebug,2, 'ditjaareventleidyes',       $ditjaareventleidyes);

            if ($ditjaarleidyes == 1 OR $ditjaardeelyes OR $ditjaardeeltop == 1 OR ($diteventleidstf == 1 AND $ditjaarleidstf == 1)) {

                if ($new_ditjaar_intstatus) { $params_contact['values']['INTAKE.INT_status']  = $new_ditjaar_intstatus; }
                if ($new_ditjaar_nawstatus) { $params_contact['values']['INTAKE.NAW_status']  = $new_ditjaar_nawstatus; }
                if ($new_ditjaar_biostatus) { $params_contact['values']['INTAKE.BIO_status']  = $new_ditjaar_biostatus; } 

                wachthond($extdebug,4, "new_ditjaar_intstatus",   $new_ditjaar_intstatus);
                wachthond($extdebug,2, "new_ditjaar_nawstatus",   $new_ditjaar_nawstatus);
                wachthond($extdebug,2, "new_ditjaar_biostatus",   $new_ditjaar_biostatus);

                wachthond($extdebug,1, 'PERFORM UPDATE CONT STATUS INTAKE (NAW/BIO)', "[ditjaardeeltop: $ditjaardeeltop]");

            }

            if (($diteventleidyes == 1 AND $ditjaarleidyes == 1) OR ($diteventleidstf == 1 AND $ditjaarleidstf == 1)) {

                if ($new_ditjaar_refstatus) { $params_contact['values']['INTAKE.REF_status']  = $new_ditjaar_refstatus; }
                if ($new_ditjaar_vogstatus) { $params_contact['values']['INTAKE.VOG_status']  = $new_ditjaar_vogstatus; }

                wachthond($extdebug,2, "new_ditjaar_refstatus",   $new_ditjaar_refstatus);
                wachthond($extdebug,2, "new_ditjaar_vogstatus",   $new_ditjaar_vogstatus);

                wachthond($extdebug,1, 'PERFORM UPDATE CONT STATUS INTAKE (REF/VOG)', "[ditjaarleidyes: $ditjaarleidyes]");

            }

            wachthond($extdebug,3, 'new_ditjaar_nawstatus',     $new_ditjaar_nawstatus);
            wachthond($extdebug,3, 'new_ditpart_nawstatus',     $new_ditpart_nawstatus);
            wachthond($extdebug,3, 'new_ditjaar_biostatus',     $new_ditjaar_biostatus);
            wachthond($extdebug,3, 'new_ditpart_biostatus',     $new_ditpart_biostatus);

            if ($new_ditpart_intstatus)     { $params_ditevent['values']['PART_LEID_INTERN.INT_status']  = $new_ditpart_intstatus;      } #PART NODIG INT
            if ($new_ditpart_nawstatus)     { $params_ditevent['values']['PART_LEID_INTERN.NAW_status']  = $new_ditpart_nawstatus;      } #PART NODIG NAW
            if ($new_ditpart_biostatus)     { $params_ditevent['values']['PART_LEID_INTERN.BIO_status']  = $new_ditpart_biostatus;      } #PART NODIG BIO
            if ($new_ditpart_refstatus)     { $params_ditevent['values']['PART_LEID_INTERN.REF_status']  = $new_ditpart_refstatus;      } #PART NODIG REF
            if ($new_ditpart_vogstatus)     { $params_ditevent['values']['PART_LEID_INTERN.VOG_status']  = $new_ditpart_vogstatus;      } #PART NODIG VOG

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.3 UPDATE PART DATA MBT INTAKE NAW/BIO VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            if ($new_ditpart_nawgecheckt)   { $params_ditevent['values']['PART.NAW_gecheckt']           = $new_ditpart_nawgecheckt;     }
            if ($new_ditpart_biogecheckt)   { $params_ditevent['values']['PART.BIO_gecheckt']           = $new_ditpart_biogecheckt;     }

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.4 UPDATE PART DATA MBT INTAKE REF VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            if ($new_ditpart_refpersoon)    { $params_contact['values']['INTAKE.REF_laatste']           = $new_ditjaar_refrecent;       }
            if ($new_ditjaar_refnaam)       { $params_contact['values']['INTAKE.REF_naam']              = $new_ditjaar_refnaam;         }
//          if ($new_ditjaar_refnaam)       { $params_contact['values']['INTAKE.ref_persoon']           = $new_ditjaar_refpersoon;      }

            if ($new_ditpart_refpersoon)    { $params_ditevent['values']['PART_LEID_REF.REF_persoon']   = $new_ditpart_refpersoon;      }
            if ($new_ditpart_refgevraagd)   { $params_ditevent['values']['PART_LEID_REF.REF_gevraagd']  = $new_ditpart_refgevraagd;     }
            if ($new_ditpart_reffeedback)   { $params_ditevent['values']['PART_LEID_REF.REF_feedback']  = $new_ditpart_reffeedback;     }

            if ($referentie_relid)          { $params_ditevent['values']['PART_LEID_REFERENTIE.rel_id']                    = $referentie_relid;        }
            if ($referentie_cid)            { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_contact']        = $referentie_cid;          }
            if ($referentie_cid)            { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_cid']            = $referentie_cid;          }
            if ($referentie_geslacht)       { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_geslacht']       = $referentie_geslacht;     }
            if ($referentie_name)           { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_naam']           = $referentie_name;         }
            if ($referentie_fn)             { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_voornaam']       = $referentie_fn;           }
            if ($referentie_mn)             { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_tussenvoegsel']  = $referentie_mn;           }
            if ($referentie_ln)             { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_achternaam']     = $referentie_ln;           }
            if ($referentie_relatie)        { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_relatie']        = $referentie_relatie;      }
            if ($referentie_motivatie)      { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_motivatie']      = $referentie_motivatie;    }
            if ($referentie_toestemming)    { $params_ditevent['values']['PART_LEID_REFERENTIE.referentie_toestemming']    = $referentie_toestemming;  }
            if ($referentie_verzoek)        { $params_ditevent['values']['PART_LEID_REF.REF_gevraagd']                     = $referentie_verzoek;      }

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.5 UPDATE PART DATA MBT INTAKE VOG VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            if ($new_ditjaar_vogrecent)     { $params_contact['values']['INTAKE.VOG_laatste']               = $new_ditjaar_vogrecent;       }
            if ($new_ditjaar_vogkenmerk)    { $params_contact['values']['INTAKE.VOG_kenmerk']               = $new_ditjaar_vogkenmerk;      }

            if ($new_part_vogverzoek)       { $params_ditevent['values']['PART_LEID_VOG.Datum_verzoek']     = $new_ditpart_vogverzoek;      }
            if ($new_part_vogaanvraag)      { $params_ditevent['values']['PART_LEID_VOG.Datum_aanvraag']    = $new_ditpart_vogaanvraag;     }
            if ($new_part_vogontvangst)     { $params_ditevent['values']['PART_LEID_VOG.Datum_ontvangst']   = $new_ditpart_vogontvangst;    }
            if ($new_part_vogdatum)         { $params_ditevent['values']['PART_LEID_VOG.Datum_nieuwe_VOG']  = $new_ditpart_vogdatum;        }
            if ($new_part_vogkenmerk)       { $params_ditevent['values']['PART_LEID_VOG.Kenmerk_VOG']       = $new_ditpart_vogkenmerk;      }

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 19.6 PERFORM UPDATE QUERY PART DATA VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            wachthond($extdebug,3, "params_contact",                    $params_contact);
            $result_contact = civicrm_api4('Contact', 'update',         $params_contact);
            wachthond($extdebug,9, "result_contact",                    $result_contact);

            wachthond($extdebug,3, "params_ditevent",                   $params_ditevent);
            $result_ditevent = civicrm_api4('Participant', 'update',    $params_ditevent);
            wachthond($extdebug,9, "result_ditevent",                   $result_ditevent);

        }

        if ($extvog == 1 AND in_array($groupID, $profilepartleidmax) AND ($ditjaareventleidyes == 1 OR $ditjaarleidstf == 1)) {

            wachthond($extdebug,1, "########################################################################");
            wachthond($extdebug,1, "### INT 20. RECHECK STATUS INTAKE ACTIVITIES VOOR $displayname", "[groupID: $groupID]");
            wachthond($extdebug,1, "########################################################################");

            $activity_array = array(
                'activity_type_id'          => 139,
                'activity_type_naam'        => 'ref_persoon',   // type_id: 139
            );
            $intake_activity_get = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
            wachthond($extdebug,3, "intake_activity_get",      $intake_activity_get);

            $activity_array = array(
                'activity_type_id'          => 117,
                'activity_type_naam'        => 'ref_verzoek',   // type_id: 117
            );
            $intake_activity_get = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
            wachthond($extdebug,3, "intake_activity_get",      $intake_activity_get);

            $activity_array = array(
                'activity_type_id'          => 118,
                'activity_type_naam'        => 'vog_verzoek',  // type_id: 118            
            );
            $intake_activity_get = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
            wachthond($extdebug,3, "intake_activity_get",      $intake_activity_get);

            $activity_array = array(
                'activity_type_id'          => 119,
                'activity_type_naam'        => 'vog_aanvraag',  // type_id: 119            
            );
            $intake_activity_get = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
            wachthond($extdebug,3, "intake_activity_get",      $intake_activity_get);

            $activity_array = array(
                'activity_type_id'          => 120,
                'activity_type_naam'        => 'vog_ontvangst',  // type_id: 120            
            );
            $intake_activity_get = intake_activity_get($contact_id, $activity_array, $ditevent_fiscalyear);
            wachthond($extdebug,3, "intake_activity_get",      $intake_activity_get);

            }
        }

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INT 10.X EINDE PROFILE PART INTAKE / VOG / REF", "[groupID: $groupID / op: $op]");
    wachthond($extdebug,1, "########################################################################");
}

/**
 * Implements hook_civicrm_config().
 *
 * @link https://docs.civicrm.org/dev/en/latest/hooks/hook_civicrm_config/
 */
function intake_civicrm_config(&$config): void {
  _intake_civix_civicrm_config($config);
}

/**
 * Implements hook_civicrm_install().
 *
 * @link https://docs.civicrm.org/dev/en/latest/hooks/hook_civicrm_install
 */
function intake_civicrm_install(): void {
  _intake_civix_civicrm_install();
}

/**
 * Implements hook_civicrm_enable().
 *
 * @link https://docs.civicrm.org/dev/en/latest/hooks/hook_civicrm_enable
 */
function intake_civicrm_enable(): void {
  _intake_civix_civicrm_enable();
}

function intake_activity_create($contact_id, $array_activity, $array_event, $array_intake) {

    $extdebug   = 0;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug   = FALSE;

    $activity_type_naam  = $array_activity['activity_type_naam']   ?? NULL;

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INTAKE CREATE ACTIVITY $activity_type_naam",                "[START]");
    wachthond($extdebug,1, "########################################################################");

    wachthond($extdebug,2, "contact_id",                                                  $contact_id);
    wachthond($extdebug,2, "array_activity",                                          $array_activity);
    wachthond($extdebug,2, "array_event",                                                $array_event);
    wachthond($extdebug,2, "array_intake",                                              $array_intake);

    if (empty($contact_id) OR empty($array_activity)) {
        return;
    }

    $today_datetime                 = date("Y-m-d H:i:s");
    $displayname                    = $array_activity['displayname']                ?? NULL;
    $contact_id                     = $array_activity['contact_id']                 ?? NULL;

    $activity_source                = $array_activity['activity_source']            ?? NULL; 
    $activity_target                = $array_activity['activity_target']            ?? NULL; 
    $activity_assignee              = $array_activity['activity_assignee']          ?? NULL; 

    $activity_type_id               = $array_activity['activity_type_id']           ?? NULL;
    $activity_type_naam             = $array_activity['activity_type_naam']         ?? NULL;
    $activity_datetime              = $array_activity['activity_date_time']         ?? NULL;
    $activity_subject               = $array_activity['activity_subject']           ?? NULL;
    $activity_status_name           = $array_activity['activity_status_name']       ?? NULL;
    $activity_prioriteit            = $array_activity['activity_prioriteit']        ?? NULL;

    $ditevent_part_id               = $array_event['ditevent_part_id']              ?? NULL;
    $ditevent_part_eventid          = $array_event['ditevent_part_eventid']         ?? NULL;
    $ditevent_leid_functie          = $array_event['ditevent_leid_functie']         ?? NULL;
    $ditevent_part_functie          = $array_event['ditevent_part_functie']         ?? NULL;
    $ditevent_part_rol              = $array_event['ditevent_part_rol']             ?? NULL;

    $ditevent_part_kampnaam         = $array_event['ditevent_part_kampnaam']        ?? NULL;
    $ditevent_part_kampkort         = $array_event['ditevent_part_kampkort']        ?? NULL;

    $ditevent_part_kampkort_low     = $array_event['ditevent_part_kampkort_low']    ?? NULL;
    $ditevent_part_kampkort_cap     = $array_event['ditevent_part_kampkort_cap']    ?? NULL;

    $ditevent_part_kampstart        = $array_event['ditevent_part_kampstart']       ?? NULL;
    $ditevent_part_kampeinde        = $array_event['ditevent_part_kampeinde']       ?? NULL;
    $ditevent_part_kampjaar         = $array_event['ditevent_part_kampjaar']        ?? NULL;

    $params_activity_create = [
        'checkPermissions' => FALSE,
        'debug'  => $apidebug,
        'values' => [
            'source_contact_id'         => $activity_source, 
            'target_contact_id'         => $activity_target,
            'assignee_contact_id'       => $activity_assignee,
            'activity_type_id'          => $activity_type_id,
#           'activity_type_id:name'     => $activity_type_naam,
            'activity_date_time'        => $activity_datetime,
            'subject'                   => $activity_subject, 
            'status_id:name'            => $activity_status_name,

            'ACT_ALG.actcontact_naam'   => $displayname,
            'ACT_ALG.actcontact_cid'    => $contact_id,
            'ACT_ALG.actcontact_pid'    => $ditevent_part_id,
            'ACT_ALG.actcontact_eid'    => $ditevent_part_eventid,
            'ACT_ALG.kampfunctie'       => $ditevent_part_functie,
            'ACT_ALG.kamprol'           => $ditevent_part_rol,

            'ACT_ALG.kampnaam'          => $ditevent_part_kampkort_cap,
            'ACT_ALG.kampkort'          => $ditevent_part_kampkort_low,
            'ACT_ALG.kampstart'         => $ditevent_part_kampstart,
            'ACT_ALG.kampeinde'         => $ditevent_part_kampeinde,
            'ACT_ALG.kampjaar'          => $ditevent_part_kampjaar,

            'ACT_ALG.modified'          => $today_datetime,
            'ACT_ALG.prioriteit:label'  => $activity_prioriteit,
        ],
    ];

    $vog_nodig                      = $array_intake['vog_nodig']                     ?? NULL;
    $vog_datum_verzoek              = $array_intake['vog_datum_verzoek']             ?? NULL;
    $vog_datum_aanvraag             = $array_intake['vog_datum_aanvraag']            ?? NULL;
    $vog_datum_ontvangst            = $array_intake['vog_datum_ontvangst']           ?? NULL;

    $params_activity_create['values']['ACT_VOG.vog_nodig']          = $vog_nodig;
    $params_activity_create['values']['ACT_VOG.datum_verzoek']      = $vog_datum_verzocht;
    $params_activity_create['values']['ACT_VOG.datum_aanvraag']     = $vog_datum_ingediend;
    $params_activity_create['values']['ACT_VOG.datum_ontvangst']    = $vog_datum_ontvangst;

    wachthond($extdebug,3, "params_activity_create",                                    $params_activity_create);
    $result_activity_create = civicrm_api4("Activity", "create",                        $params_activity_create);
    wachthond($extdebug,3, "params_activity_create $activity_type_naam",                "EXECUTED");
    wachthond($extdebug,7, "params_activity_create $activity_type_naam RESULT",         $result_activity_create);
    wachthond($extdebug,7, "params_activity_create $activity_type_naam RESULTS 0",      $result_activity_create[0]);
    wachthond($extdebug,7, "params_activity_create $activity_type_naam RESULTS 0 ID",   $result_activity_create[0]['id']);
    if (empty($activity_id))         { $activity_id       = $result_activity_create[0]['id']        ?? NULL; }
    if (empty($activity_status))     { $activity_status   = $result_activity_create[0]['status_id'] ?? NULL; }
    wachthond($extdebug,2, "(nieuwe) activity_id",       $activity_id);
    wachthond($extdebug,2, "(nieuwe) activity_status",   $activity_status);

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INTAKE CREATE ACTIVITY $activity_type_naam",                "[EINDE]");
    wachthond($extdebug,1, "########################################################################");

    return $activity_id;
}

function intake_activity_update($contact_id, $array_activity, $array_event, $array_intake) {

    $extdebug   = 0;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug   = FALSE;

    $activity_type_naam             = $array_activity['activity_type_naam']   ?? NULL;

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INTAKE UPDATE ACTIVITY $activity_type_naam",                "[START]");
    wachthond($extdebug,1, "########################################################################");

    wachthond($extdebug,2, "contact_id",                                                  $contact_id);
    wachthond($extdebug,2, "array_activity",                                          $array_activity);
    wachthond($extdebug,2, "array_event",                                                $array_event);
    wachthond($extdebug,2, "array_intake",                                              $array_intake);

    if (empty($contact_id) OR empty($array_activity)) {
        return;
    }

    $today_datetime                 = date("Y-m-d H:i:s");
    $displayname                    = $array_activity['displayname']                ?? NULL;
    $contact_id                     = $array_activity['contact_id']                 ?? NULL;

    $activity_id                    = $array_activity['activity_id']                ?? NULL;

    $activity_source                = $array_activity['activity_source']            ?? NULL;
    $activity_target                = $array_activity['activity_target']            ?? NULL;
    $activity_assignee              = $array_activity['activity_assignee']          ?? NULL;

    $activity_type_id               = $array_activity['activity_type_id']           ?? NULL;
    $activity_type_naam             = $array_activity['activity_type_naam']         ?? NULL;
    $activity_datetime              = $array_activity['activity_date_time']         ?? NULL;
    $activity_subject               = $array_activity['activity_subject']           ?? NULL;
    $activity_status_name           = $array_activity['activity_status_name']       ?? NULL;
    $activity_prioriteit            = $array_activity['activity_prioriteit']        ?? NULL;

    $ditevent_part_id               = $array_event['ditevent_part_id']              ?? NULL;
    $ditevent_part_eventid          = $array_event['ditevent_part_eventid']         ?? NULL;
    $ditevent_leid_functie          = $array_event['ditevent_leid_functie']         ?? NULL;
    $ditevent_part_functie          = $array_event['ditevent_part_functie']         ?? NULL;
    $ditevent_part_rol              = $array_event['ditevent_part_rol']             ?? NULL;

    $ditevent_part_kampnaam         = $array_event['ditevent_part_kampnaam']        ?? NULL;
    $ditevent_part_kampkort         = $array_event['ditevent_part_kampkort']        ?? NULL;
    $ditevent_part_kampkort_low     = $array_event['ditevent_part_kampkort_low']    ?? NULL;
    $ditevent_part_kampkort_cap     = $array_event['ditevent_part_kampkort_cap']    ?? NULL;

    $ditevent_part_kampstart        = $array_event['ditevent_part_kampstart']       ?? NULL;
    $ditevent_part_kampeinde        = $array_event['ditevent_part_kampeinde']       ?? NULL;
    $ditevent_part_kampjaar         = $array_event['ditevent_part_kampjaar']        ?? NULL;

    $params_activity_update = [
        'checkPermissions' => FALSE,
        'debug' => $apidebug,
        'where' => [
            ['id',                     '=',$activity_id],
        ],
        'values' => [
            'source_contact_id'         => $activity_source, 
            'target_contact_id'         => $activity_target,
            'assignee_contact_id'       => $activity_assignee,
            'activity_type_id'          => $activity_type_id,
#           'activity_type_id:name'     => $activity_type_naam,
            'activity_date_time'        => $activity_datetime,
            'subject'                   => $activity_subject, 
            'status_id:name'            => $activity_status_name,

            'ACT_ALG.activity_id'       => $activity_id,
            'ACT_ALG.actcontact_cid'    => $contact_id,
            'ACT_ALG.actcontact_naam'   => $displayname,
            'ACT_ALG.actcontact_pid'    => $ditevent_part_id,
            'ACT_ALG.actcontact_eid'    => $ditevent_part_eventid,
            'ACT_ALG.kampfunctie'       => $ditevent_part_functie,
            'ACT_ALG.kamprol'           => $ditevent_part_rol,

            'ACT_ALG.kampnaam'          => $ditevent_part_kampkort_cap,
            'ACT_ALG.kampkort'          => $ditevent_part_kampkort_low,
            'ACT_ALG.kampstart'         => $ditevent_part_kampstart,
            'ACT_ALG.kampeinde'         => $ditevent_part_kampeinde,
            'ACT_ALG.kampjaar'          => $ditevent_part_kampjaar,

            'ACT_ALG.modified'          => $today_datetime,
            'ACT_ALG.prioriteit:label'  => $activity_prioriteit,
            'priority_id:name'          => $activity_prioriteit,
        ],
    ];

    $ref_nodig                      = $array_intake['ref_nodig']                     ?? NULL;
    $vog_nodig                      = $array_intake['vog_nodig']                     ?? NULL;
    $vog_datum_verzoek              = $array_intake['vog_datum_verzoek']             ?? NULL;
    $vog_datum_reminder             = $array_intake['vog_datum_reminder']            ?? NULL;
    $vog_datum_aanvraag             = $array_intake['vog_datum_aanvraag']            ?? NULL;
    $vog_datum_ontvangst            = $array_intake['vog_datum_ontvangst']           ?? NULL;

    $params_activity_update['values']['ACT_REF.ref_nodig']          = $ref_nodig;

    $params_activity_update['values']['ACT_VOG.vog_nodig']          = $vog_nodig;
    $params_activity_update['values']['ACT_VOG.datum_verzoek']      = $vog_datum_verzoek;
    $params_activity_update['values']['ACT_VOG.datum_aanvraag']     = $vog_datum_aanvraag;
    $params_activity_update['values']['ACT_VOG.datum_ontvangst']    = $vog_datum_ontvangst;

    wachthond($extdebug,3, "params_activity_update",                                    $params_activity_update);
    $result_activity_update = civicrm_api4("Activity", "update",                        $params_activity_update);
    wachthond($extdebug,3, "params_activity_update $activity_type_naam",                "EXECUTED");
    wachthond($extdebug,7, "params_activity_update $activity_type_naam RESULT",         $result_activity_update);
    wachthond($extdebug,7, "params_activity_update $activity_type_naam RESULTS 0",      $result_activity_update[0]);
    wachthond($extdebug,7, "params_activity_update $activity_type_naam RESULTS 0 ID",   $result_activity_update[0]['id']);
    if (empty($activity_id))         { $activity_id       = $result_activity_update[0]['id']        ?? NULL; }
    if (empty($activity_status))     { $activity_status   = $result_activity_update[0]['status_id'] ?? NULL; }
    wachthond($extdebug,2, "(nieuwe) activity_id",       $activity_id);
    wachthond($extdebug,2, "(nieuwe) activity_status",   $activity_status);

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INTAKE UPDATE ACTIVITY $activity_type_naam",                "[EINDE]");
    wachthond($extdebug,1, "########################################################################");

    return $activity_id;
}

function intake_activity_get($contact_id, $array_activity, $array_period) {

    $extdebug   = 0;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug   = FALSE;

    $activity_type_id       = $array_activity['activity_type_id']       ?? NULL;
    $activity_type_naam     = $array_activity['activity_type_naam']     ?? NULL;

    $period_start = $array_period['fiscalyear_start'];
    $period_einde = $array_period['fiscalyear_einde'];

    wachthond($extdebug,3, "array_period",                                              $array_period);
    wachthond($extdebug,3, "period_start",                                              $period_start);
    wachthond($extdebug,3, "period_einde",                                              $period_einde);

    wachthond($extdebug,3, "########################################################################");
    wachthond($extdebug,3, "### INTAKE GET ACTIVITY $activity_type_naam",                   "[START]");
    wachthond($extdebug,3, "########################################################################");

    wachthond($extdebug,2, "contact_id",                                                  $contact_id);
    wachthond($extdebug,2, "activity_type_id",                                      $activity_type_id);

    if (empty($contact_id) OR empty($activity_type_id)) {
        return;
    }

    $params_activity_get = [
        'checkPermissions' => FALSE,
        'debug' => $apidebug,       
        'select' => [
            'row_count',
            'id',
            'activity_date_time',
            'status_id',
            'status_id:name',
            'subject',
            'activity_contact.contact_id',

            'ACT_ALG.actcontact_naam',
            'ACT_ALG.actcontact_cid',
            'ACT_ALG.actcontact_pid',
            'ACT_ALG.actcontact_eid',

            'ACT_ALG.kampnaam',
            'ACT_ALG.kampkort',
            'ACT_ALG.kampfunctie',
            'ACT_ALG.kamprol',
            'ACT_ALG.kampstart',
            'ACT_ALG.kampeinde',
            'ACT_ALG.kampjaar',

            'ACT_REF.ref_nodig',
            'ACT_REF.aanvrager_naam',
            'ACT_REF.referentie_naam',
            'ACT_REF.relid',

            'ACT_VOG.vog_nodig',
            'ACT_VOG.datum_verzoek',
            'ACT_VOG.datum_reminder',            
            'ACT_VOG.datum_aanvraag',
            'ACT_VOG.datum_ontvangst',

            'ACT_ALG.modified',
            'ACT_ALG.prioriteit:label',
            'priority_id:name',
        ],
        'join' => [
            ['ActivityContact AS activity_contact', 'INNER'],
        ],
        'where' => [
            ['activity_contact.contact_id',     '=',  $contact_id],
            ['activity_contact.record_type_id', '=',  3],
            ['activity_type_id',                '=',  $activity_type_id],
#           ['activity_type_id:name',           '=',  $activity_type_naam],
            ['activity_date_time',              '>=', $period_start],
            ['activity_date_time',              '<=', $period_einde],
            ['is_test',                         'IN', ['true,false']],
        ],
    ];

//  $params_activity_get['select']['ACT_REF.aanvrager_naam']     = $vog_datum_verzocht;
//  $params_activity_get['select']['ACT_REF.referentie_naam']    = $vog_datum_ingediend;
//  $params_activity_get['select']['ACT_REF.relid']              = $vog_datum_ontvangst;

    wachthond($extdebug,7,'params_activity_get',            $params_activity_get);
    $result_activity_get = civicrm_api4('Activity', 'get',  $params_activity_get);
    $result_activity_count = $result_activity_get->countMatched();
    wachthond($extdebug,3,'result_activity_count',          $result_activity_count);
    wachthond($extdebug,9,'result_activity_get',            $result_activity_get);

    if ($result_activity_count == 1) {

        $activity_id            = $result_activity_get[0]['id']                         ?? NULL;
        $activity_status        = $result_activity_get[0]['status_id']                  ?? NULL;
        $activity_status_name   = $result_activity_get[0]['status_id:name']             ?? NULL;
        $activity_datum         = $result_activity_get[0]['activity_date_time']         ?? NULL;

        $activity_kampkort      = $result_activity_get[0]['ACT_ALG.kampkort']           ?? NULL;
        $activity_kampfunctie   = $result_activity_get[0]['ACT_ALG.kampfunctie']        ?? NULL;
        $activity_kampstart     = $result_activity_get[0]['ACT_ALG.kampstart']          ?? NULL;
        $activity_kampjaar      = $result_activity_get[0]['ACT_ALG.kampjaar']           ?? NULL;

        $referentie_aanvrager   = $result_activity_get[0]['ACT_REF.aanvrager_naam']     ?? NULL;
        $referentie_relid       = $result_activity_get[0]['ACT_REF.relid']              ?? NULL;
        $referentie_refid       = $result_activity_get[0]['ACT_REF.referentie_cid']     ?? NULL;
        $referentie_naam        = $result_activity_get[0]['ACT_REF.referentie_naam']    ?? NULL;

        $vog_nodig              = $result_activity_get[0]['ACT_VOG.vog_nodig']          ?? NULL;
        $vog_datum_verzoek      = $result_activity_get[0]['ACT_VOG.datum_verzoek']      ?? NULL;
        $vog_datum_reminder     = $result_activity_get[0]['ACT_VOG.datum_reminder']     ?? NULL;
        $vog_datum_aanvraag     = $result_activity_get[0]['ACT_VOG.datum_aanvraag']     ?? NULL;
        $vog_datum_ontvangst    = $result_activity_get[0]['ACT_VOG.datum_ontvangst']    ?? NULL;

        $activity_intake_array = array(

            'activity_count'            => $result_activity_count,

            'activity_id'               => $activity_id,
            'activity_status'           => $activity_status,
            'activity_status_name'      => $activity_status_name,
            'activity_datum'            => $activity_datum,

            'activity_kampkort'         => $activity_kampkort,
            'activity_kampfunctie'      => $activity_kampfunctie,
            'activity_kampstart'        => $activity_kampstart,
            'activity_kampjaar'         => $activity_kampjaar,

            'referentie_aanvrager'      => $referentie_aanvrager,
            'referentie_relid'          => $referentie_relid,
            'referentie_refid'          => $referentie_refid,
            'referentie_naam'           => $referentie_naam,

            'vog_nodig'                 => $vog_nodig,
            'vog_datum_verzoek'         => $vog_datum_verzoek,
            'vog_datum_aanvraag'        => $vog_datum_aanvraag,
            'vog_datum_ontvangst'       => $vog_datum_ontvangst,
        );

        return $activity_intake_array;

    } else {
 
        $refpersoon_activity_id     = NULL;
        $refpersoon_activity_status = NULL;
        $refpersoon_activity_datum  = NULL;
        wachthond($extdebug,1, "result_activity_count voor $activity_type_naam", $result_activity_count);

        $activity_intake_array = array(
            'activity_type_name'        => $activity_type_naam,
            'activity_type_id'          => $activity_type_id,
            'activity_count'            => $result_activity_count,
        );

        return $activity_intake_array;

    }

    wachthond($extdebug,3, "########################################################################");
    wachthond($extdebug,3, "### INTAKE GET ACTIVITY $activity_type_naam",                   "[EINDE]");
    wachthond($extdebug,3, "########################################################################");

}

function intake_activity_delete($contact_id, $activity_id) {

    $extdebug   = 1;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug   = FALSE;

    wachthond($extdebug,2, "########################################################################");
    wachthond($extdebug,2, "### INTAKE DELETE ACTIVITY $activity_id",                       "[START]");
    wachthond($extdebug,2, "########################################################################");

    wachthond($extdebug,3, "contact_id",                                                  $contact_id);
    wachthond($extdebug,3, "activity_id",                                                $activity_id);

    if (empty($contact_id) OR empty($activity_id)) {
        return;
    }

    $params_activity_delete = [
        'checkPermissions' => FALSE,
        'debug' => $apidebug,
        'where' => [
            ['id', '=', $activity_id],
        ],
    ];
    $result_activity_delete = civicrm_api4('Activity', 'delete', $params_activity_delete);
    wachthond($extdebug,1, "ACTIVITY VERWIJDERD", "activity_id: $activity_id");

    wachthond($extdebug,3, "########################################################################");
    wachthond($extdebug,3, "### INTAKE DELETE ACTIVITY $activity_id",                       "[EINDE]");
    wachthond($extdebug,3, "########################################################################");

    return $result_activity_delete;
}

function intake_activitytype_delete($contact_id, $activity_type_name, $periodstart = NULL, $periodeinde = NULL) {

    $extdebug   = 1;  //  1 = basic // 2 = verbose // 3 = params / 4 = results
    $apidebug   = FALSE;

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INTAKE DELETE ACTIVITY $activity_type_name",                "[START]");
    wachthond($extdebug,1, "########################################################################");

    wachthond($extdebug,2, "contact_id",                                                  $contact_id);
    wachthond($extdebug,2, "activity_type_name",                                  $activity_type_name);

    if (empty($contact_id) OR empty($activity_type_id)) {
        return;
    }

    $params_activity_delete = [
        'checkPermissions' => FALSE,
        'debug' => $apidebug,
        'where' => [
            ['activity_contact.contact_id', '=',  $contact_id],
            ['activity_type_id:name',       '=',  $activity_type_name],
            ['activity_date_time',          '>=', $periodstart],
            ['activity_date_time',          '<=', $periodeinde],
        ],
    ];
    $result_activity_delete = civicrm_api4('Activity', 'delete', $params_activity_delete);
    wachthond($extdebug,1, "ACTIVITY_TYPE VERWIJDERD", "activity_type: $activity_type_name");

    wachthond($extdebug,1, "########################################################################");
    wachthond($extdebug,1, "### INTAKE DELETE ACTIVITY_TYPE $activity_type_name",           "[EINDE]");
    wachthond($extdebug,1, "########################################################################");

    return $result_activity_delete;
}